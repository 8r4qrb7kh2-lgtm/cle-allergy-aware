<!doctype html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="favicon.png">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1">
  <title>Clarivore - Safe dining for everyone</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #111630;
      --ink: #e9ecff;
      --muted: #a8b2d6;
      --brand: #7c9cff;
      --ok: #22c55e;
      --warn: #facc15;
      --bad: #ef4444;
      --border: #2a3261;
      --hover: #4c5ad4;
      --shadow: 0 10px 30px rgba(0, 0, 0, .35);
    }

    html {
      margin: 0;
      padding: 0;
      min-height: 100%;
      width: 100%;
      overflow: auto;
      background: var(--bg);
    }

    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      width: 100%;
      background: var(--bg);
      color: var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      overflow-x: hidden;
      overflow-y: auto;
    }

    #root {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }

    .chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chip {
      padding: 8px 10px;
      border: 1px solid var(--border);
      background: #12183a;
      border-radius: 999px;
      font-size: 14px;
    }

    .chip.active {
      border-color: #4c5ad4;
      box-shadow: 0 0 0 3px #7c9cff33 inset, 0 0 10px #24307a66;
    }

    .chip.clickable {
      cursor: pointer;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    .pill {
      padding: 10px 14px;
      border: 1px dashed #33408c;
      border-radius: 12px;
      margin-bottom: 10px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #1a2351;
      cursor: pointer;
      color: #fff;
      text-decoration: none;
    }

    .banner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: #351b1b;
      border: 1px solid #5b2c2c;
      border-radius: 12px;
      padding: 10px 12px;
      margin: 10px 0;
    }

    .ackBtn {
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      border: 1px solid;
    }

    @keyframes ackPulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 180, 180, 0.45); }
      50% { box-shadow: 0 0 0 8px rgba(255, 180, 180, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 180, 180, 0); }
    }

    .ackBtn.off {
      background: #8b1d1d;
      border-color: #a12525;
      animation: ackPulse 1.8s ease-in-out infinite;
    }

    .ackBtn.on {
      background: #17663a;
      border-color: #1a7b46;
      animation: none;
    }

    .topin {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 12px 22px 10px;
      flex-wrap: wrap;
      justify-content: center;
      box-sizing: border-box;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 16px;
      font-weight: 800;
      flex-shrink: 0;
      cursor: pointer;
    }

    .brand img {
      width: 52px;
      height: 52px;
      border-radius: 6px;
    }

    .brand span {
      font-size: clamp(1.5rem, 1.3rem + 1vw, 2.1rem);
    }

    .topNav {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .tab {
      padding: 8px 12px;
      border: 1px solid var(--border);
      background: #12183a;
      border-radius: 999px;
      cursor: pointer;
      white-space: nowrap;
    }

    .tab:hover {
      border-color: var(--hover);
      box-shadow: 0 0 0 3px #7c9cff33 inset, 0 2px 10px #0b1b60aa;
    }

    .restaurant-dropdown {
      position: relative;
      width: 100%;
    }

    .restaurant-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-top: 4px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }

    .restaurant-suggestions.visible {
      display: block;
    }

    .restaurant-option {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .restaurant-option:last-child {
      border-bottom: none;
    }

    .restaurant-option:hover {
      background: #1a2351;
    }

    .restaurant-option.selected {
      background: #1e2a5e;
      border-left: 3px solid var(--brand);
    }

    .restaurant-option img {
      width: 50px;
      height: 50px;
      border-radius: 6px;
      object-fit: cover;
      flex-shrink: 0;
    }

    .restaurant-option h3 {
      font-size: 1rem;
      margin: 0;
      color: var(--ink);
    }

    .selected-restaurant {
      padding: 12px 16px;
      background: #1e2a5e;
      border: 2px solid var(--brand);
      border-radius: 10px;
      margin-top: 12px;
      display: none;
      align-items: center;
      gap: 12px;
    }

    .selected-restaurant.visible {
      display: flex;
    }

    .selected-restaurant img {
      width: 50px;
      height: 50px;
      border-radius: 6px;
      object-fit: cover;
      flex-shrink: 0;
    }

    .selected-restaurant h3 {
      font-size: 1rem;
      margin: 0;
      color: var(--ink);
    }

    .search-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      background: #0b1020;
      color: var(--ink);
      border-radius: 10px;
      font-size: 1rem;
      margin-top: 12px;
      outline: none;
      font-family: inherit;
    }

    .search-input:focus {
      border-color: var(--hover);
      box-shadow: 0 0 0 3px rgba(76, 90, 212, 0.2);
    }

    .error-text {
      color: var(--bad);
      font-size: 0.9rem;
      margin: 8px 0;
      display: none;
    }

    .error-text.visible {
      display: block;
    }

    @media (max-width: 640px) {
      .restaurant-grid {
        grid-template-columns: 1fr;
      }
    }

    /* QR guest promo popup */
    .qrPromoBackdrop {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: rgba(8, 12, 32, .85);
      z-index: 2500;
    }

    .qrPromoBackdrop.show {
      display: flex;
    }

    .qrPromo {
      width: min(420px, calc(100% - 40px));
      background: linear-gradient(135deg, #1a2351 0%, #0f1638 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, .5);
      position: relative;
    }

    .qrPromo h2 {
      margin: 0 0 16px 0;
      font-size: 1.5rem;
      color: var(--ink);
    }

    .qrPromo p {
      margin: 0 0 12px 0;
      color: var(--muted);
      line-height: 1.5;
    }

    .qrPromo p:last-of-type {
      margin-bottom: 24px;
    }

    .qrPromoClose {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 32px;
      height: 32px;
      border: none;
      background: #1e2870;
      color: var(--ink);
      font-size: 24px;
      line-height: 1;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .qrPromoClose:hover {
      background: #2a3590;
    }

    .qrPromoClose:active {
      background: #1e2870;
    }

    .btnPrimary {
      width: 100%;
      padding: 12px 24px;
      background: var(--brand);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btnPrimary:hover {
      background: #6b8dff;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(124, 156, 255, 0.4);
    }

    .btnPrimary:active {
      transform: translateY(0);
    }

    /* QR banner at top */
    .qrBanner {
      position: fixed;
      left: 0;
      right: 0;
      top: 0;
      z-index: 2200;
      display: none;
      background: linear-gradient(135deg, #1a2351 0%, #0f1638 100%);
      border-bottom: 1px solid var(--border);
      padding: 12px 16px;
      gap: 12px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      box-shadow: 0 4px 20px rgba(0, 0, 0, .4);
      text-align: center;
    }

    .qrBanner.show {
      display: flex;
    }

    .qrBanner > div {
      color: var(--ink);
      font-size: 0.95rem;
    }

    .qrBanner strong {
      color: var(--brand);
    }

    body.qrBannerVisible .topin {
      margin-top: 80px;
    }

    @media (max-width: 640px) {
      .qrPromo {
        padding: 24px 20px;
      }

      .qrPromo h2 {
        font-size: 1.25rem;
      }

      .qrBanner {
        font-size: 0.85rem;
      }

      body.qrBannerVisible .topin {
        margin-top: 100px;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- QR Promo Popup -->
  <div class="qrPromoBackdrop" id="qrPromoBackdrop" aria-hidden="true">
    <div class="qrPromo" role="dialog" aria-labelledby="qrPromoTitle" aria-modal="true">
      <button class="qrPromoClose" id="qrPromoClose" type="button" aria-label="Close promotion">Ã—</button>
      <h2 id="qrPromoTitle">Check out all restaurants part of Clarivore</h2>
      <p>Save your allergens and diets once and unlock curated menus at restaurants across the city.</p>
      <p>Creating an account takes less than a minute and is completely free.</p>
      <button class="btn btnPrimary" id="qrPromoSignup" type="button">Create free account</button>
    </div>
  </div>

  <!-- QR Banner at Top -->
  <div class="qrBanner" id="qrBanner" aria-hidden="true">
    <div><strong>Keep exploring safely.</strong> Create a free account to save your allergens and diets, and see compatible dishes everywhere.</div>
    <button class="btn btnPrimary" id="qrBannerSignup" type="button">Create free account</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/auth-redirect.js" defer></script>
  <script>
    const SUPABASE_URL = 'https://fgoiyycctnwnghrvsilt.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZnb2l5eWNjdG53bmdocnZzaWx0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MzY1MjYsImV4cCI6MjA3NjAxMjUyNn0.xlSSXr0Gl7j-vsckrj-2anpPmp4BG2SUIdN-_dquSA8';
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
    window.supabaseClient = supabaseClient;

    const ALLERGENS = ["dairy", "egg", "peanut", "tree nut", "shellfish", "fish", "soy", "sesame", "wheat"];
    const ALLERGEN_EMOJI = {
      'dairy': 'ðŸ¥›',
      'egg': 'ðŸ¥š',
      'peanut': 'ðŸ¥œ',
      'tree nut': 'ðŸŒ°',
      'shellfish': 'ðŸ¦',
      'fish': 'ðŸŸ',
      'soy': 'ðŸ«›',
      'sesame': 'ðŸ«˜',
      'wheat': 'ðŸŒ¾'
    };
    const DIETS = ["Vegan", "Vegetarian", "Pescatarian", "Gluten-free"];

    const state = { allergies: [], diets: [], ack: false, user: { loggedIn: false } };
    let selectedRestaurant = null;
    let allRestaurants = [];
    let qrPromoTimerId = null;

    // QR Promo Functions
    function showQrBanner() {
      const banner = document.getElementById('qrBanner');
      if (!banner) return;
      if (state.user?.loggedIn) return;
      banner.classList.add('show');
      banner.setAttribute('aria-hidden', 'false');
      document.body.classList.add('qrBannerVisible');
    }

    function hideQrBanner() {
      const banner = document.getElementById('qrBanner');
      if (!banner) return;
      banner.classList.remove('show');
      banner.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('qrBannerVisible');
    }

    function openQrPromo() {
      const backdrop = document.getElementById('qrPromoBackdrop');
      if (!backdrop || backdrop.classList.contains('show')) return;
      hideQrBanner();
      backdrop.classList.add('show');
      backdrop.setAttribute('aria-hidden', 'false');
    }

    function closeQrPromo(reason = 'dismiss') {
      const backdrop = document.getElementById('qrPromoBackdrop');
      if (backdrop && backdrop.classList.contains('show')) {
        backdrop.classList.remove('show');
        backdrop.setAttribute('aria-hidden', 'true');
      }
      if (qrPromoTimerId) {
        clearTimeout(qrPromoTimerId);
        qrPromoTimerId = null;
      }
      if (reason === 'dismiss' && !state.user?.loggedIn) {
        showQrBanner();
      }
      if (reason === 'signup' || reason === 'login') {
        hideQrBanner();
      }
    }

    function queueQrPromoTimer() {
      if (qrPromoTimerId) {
        clearTimeout(qrPromoTimerId);
        qrPromoTimerId = null;
      }
      qrPromoTimerId = setTimeout(() => {
        qrPromoTimerId = null;
        if (!state.user?.loggedIn) {
          openQrPromo();
        }
      }, 10000); // 10 seconds
    }

    // Helper functions
    const norm = s => (s || '').toString().trim().toLowerCase();
    const esc = s => (s ?? '').toString().replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
    const cap = s => (s || '').split(' ').map(w => w ? w[0].toUpperCase() + w.slice(1) : '').join(' ');
    function div(html, cls) { const d = document.createElement('div'); if (cls) d.className = cls; d.innerHTML = html; return d; }

    function renderSelector(el) {
      el.innerHTML = '';
      const row = div('', 'chips');
      row.setAttribute('role', 'list');
      const sel = new Set((state.allergies || []).map(norm));
      ALLERGENS.forEach(a => {
        const isActive = sel.has(a);
        const emoji = ALLERGEN_EMOJI[a] || 'ðŸ”´';
        const c = div(`${emoji} ${esc(cap(a))}`, 'chip clickable' + (isActive ? ' active' : ''));
        c.setAttribute('role', 'button');
        c.setAttribute('tabindex', '0');
        c.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        c.dataset.value = a;
        const toggle = () => {
          if (sel.has(a)) {
            sel.delete(a);
          } else {
            sel.add(a);
          }
          state.allergies = [...sel];
          try { sessionStorage.setItem('qrAllergies', JSON.stringify(state.allergies)); } catch (_) { }
          renderSelector(el);
          hideError('allergyError');
        };
        c.addEventListener('click', (evt) => {
          evt.preventDefault();
          evt.stopPropagation();
          toggle();
        }, { passive: false });
        c.addEventListener('touchend', (evt) => {
          evt.preventDefault();
          evt.stopPropagation();
          toggle();
        }, { passive: false });
        c.addEventListener('keydown', (evt) => {
          if (evt.key === 'Enter' || evt.key === ' ') {
            evt.preventDefault();
            toggle();
          }
        });
        row.appendChild(c);
      });
      el.appendChild(row);
    }

    function renderDietSelector(el) {
      el.innerHTML = '';
      const row = div('', 'chips');
      row.setAttribute('role', 'list');
      const sel = new Set(state.diets || []);
      DIETS.forEach(diet => {
        const isActive = sel.has(diet);
        const emoji = diet === 'Vegan' ? 'ðŸŒ±' : diet === 'Vegetarian' ? 'ðŸ¥¬' : diet === 'Pescatarian' ? 'ðŸŸ' : diet === 'Gluten-free' ? 'ðŸŒ¾' : 'ðŸ½ï¸';
        const c = div(`${emoji} ${esc(diet)}`, 'chip clickable' + (isActive ? ' active' : ''));
        c.setAttribute('role', 'button');
        c.setAttribute('tabindex', '0');
        c.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        c.dataset.value = diet;
        const toggle = () => {
          if (sel.has(diet)) {
            sel.delete(diet);
          } else {
            sel.add(diet);
          }
          state.diets = [...sel];
          try { sessionStorage.setItem('qrDiets', JSON.stringify(state.diets)); } catch (_) { }
          renderDietSelector(el);
          hideError('allergyError');
        };
        c.addEventListener('click', (evt) => {
          evt.preventDefault();
          evt.stopPropagation();
          toggle();
        }, { passive: false });
        c.addEventListener('touchend', (evt) => {
          evt.preventDefault();
          evt.stopPropagation();
          toggle();
        }, { passive: false });
        c.addEventListener('keydown', (evt) => {
          if (evt.key === 'Enter' || evt.key === ' ') {
            evt.preventDefault();
            toggle();
          }
        });
        row.appendChild(c);
      });
      el.appendChild(row);
    }

    function showError(id) {
      const el = document.getElementById(id);
      if (el) el.classList.add('visible');
    }

    function hideError(id) {
      const el = document.getElementById(id);
      if (el) el.classList.remove('visible');
    }

    async function loadRestaurants() {
      try {
        const { data, error } = await supabaseClient
          .from('restaurants')
          .select('*')
          .order('name');

        if (error) throw error;

        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

        allRestaurants = (data || []).filter(r => {
          if (!r.last_confirmed) return false;
          const lastConfirmed = new Date(r.last_confirmed);
          return lastConfirmed >= thirtyDaysAgo;
        });

        // Restaurants loaded successfully
      } catch (error) {
        console.error('Error loading restaurants:', error);
      }
    }

    function renderRestaurantSuggestions(restaurants) {
      const suggestions = document.getElementById('restaurantSuggestions');

      if (!restaurants.length) {
        suggestions.innerHTML = '<div style="padding: 12px 16px; color: var(--muted); text-align: center;">No restaurants found</div>';
        suggestions.classList.add('visible');
        return;
      }

      suggestions.innerHTML = restaurants.map(r => {
        // Get the first menu image URL
        const menuImage = r.menu_images && r.menu_images.length > 0
          ? r.menu_images[0]
          : 'https://via.placeholder.com/50x50/1a2351/7c9cff?text=No+Image';

        return `
          <div class="restaurant-option ${selectedRestaurant?.id === r.id ? 'selected' : ''}"
               data-id="${r.id}"
               data-slug="${esc(r.slug)}"
               data-name="${esc(r.name)}"
               data-image="${esc(menuImage)}">
            <img src="${esc(menuImage)}" alt="${esc(r.name)}">
            <h3>${esc(r.name)}</h3>
          </div>
        `;
      }).join('');

      // Add click listeners
      suggestions.querySelectorAll('.restaurant-option').forEach(option => {
        option.addEventListener('click', function() {
          const id = parseInt(this.dataset.id);
          const slug = this.dataset.slug;
          const name = this.dataset.name;
          const image = this.dataset.image;
          selectRestaurant(id, slug, name, image);
        });
      });

      suggestions.classList.add('visible');
    }

    window.selectRestaurant = function(id, slug, name, image) {
      selectedRestaurant = { id, slug, name, image };

      // Update search input placeholder and clear value
      const searchInput = document.getElementById('restaurantSearch');
      if (searchInput) {
        searchInput.value = '';
        searchInput.placeholder = 'Search again...';
      }

      // Hide suggestions
      const suggestions = document.getElementById('restaurantSuggestions');
      if (suggestions) suggestions.classList.remove('visible');

      // Show selected restaurant display with thumbnail
      const selectedDisplay = document.getElementById('selectedRestaurant');
      if (selectedDisplay) {
        selectedDisplay.innerHTML = `
          <img src="${esc(image)}" alt="${esc(name)}">
          <h3>${esc(name)}</h3>
        `;
        selectedDisplay.classList.add('visible');
      }

      hideError('restaurantError');
      const banner = document.getElementById('disclaimerBanner');
      if (banner) banner.style.display = 'flex';
    };

    function setupListeners() {
      const searchInput = document.getElementById('restaurantSearch');
      const suggestions = document.getElementById('restaurantSuggestions');

      if (searchInput) {
        // Show suggestions on focus
        searchInput.addEventListener('focus', (e) => {
          if (e.target.value.trim()) {
            const query = e.target.value.toLowerCase();
            const filtered = allRestaurants.filter(r =>
              r.name.toLowerCase().includes(query) ||
              r.slug.toLowerCase().includes(query)
            );
            renderRestaurantSuggestions(filtered);
          }
        });

        // Filter as user types
        searchInput.addEventListener('input', (e) => {
          const query = e.target.value.toLowerCase().trim();

          if (!query) {
            suggestions.classList.remove('visible');
            selectedRestaurant = null;
            document.getElementById('selectedRestaurant').classList.remove('visible');
            document.getElementById('disclaimerBanner').style.display = 'none';
            return;
          }

          const filtered = allRestaurants.filter(r =>
            r.name.toLowerCase().includes(query) ||
            r.slug.toLowerCase().includes(query)
          );
          renderRestaurantSuggestions(filtered);
        });
      }

      // Hide suggestions when clicking outside
      document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !suggestions.contains(e.target)) {
          suggestions.classList.remove('visible');
        }
      });

      const ackBtn = document.getElementById('ackBtn');
      if (ackBtn) {
        ackBtn.addEventListener('click', function() {
          const hasSelection = state.allergies.length > 0 || state.diets.length > 0;

          if (!hasSelection) {
            showError('allergyError');
            document.getElementById('allergyError').scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
          }

          if (!selectedRestaurant) {
            showError('restaurantError');
            document.getElementById('restaurantError').scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
          }

          try {
            sessionStorage.setItem('qrAllergies', JSON.stringify(state.allergies));
            sessionStorage.setItem('qrDiets', JSON.stringify(state.diets));
          } catch (e) {
            console.warn('Could not save to sessionStorage:', e);
          }

          this.textContent = 'Acknowledged';
          this.classList.remove('off');
          this.classList.add('on');

          window.location.href = `restaurant.html?slug=${selectedRestaurant.slug}&qr=1&ack=1`;
        });
      }

      // QR Promo event listeners
      const qrPromoBackdrop = document.getElementById('qrPromoBackdrop');
      const qrPromoCloseBtn = document.getElementById('qrPromoClose');
      const qrPromoSignupBtn = document.getElementById('qrPromoSignup');
      const qrBannerSignupBtn = document.getElementById('qrBannerSignup');

      if (qrPromoBackdrop) {
        qrPromoBackdrop.addEventListener('click', (e) => {
          if (e.target === qrPromoBackdrop) closeQrPromo('dismiss');
        });
      }

      if (qrPromoCloseBtn) {
        qrPromoCloseBtn.onclick = () => closeQrPromo('dismiss');
      }

      if (qrPromoSignupBtn) {
        qrPromoSignupBtn.onclick = () => {
          closeQrPromo('signup');
          window.location.href = 'account.html';
        };
      }

      if (qrBannerSignupBtn) {
        qrBannerSignupBtn.onclick = () => {
          hideQrBanner();
          window.location.href = 'account.html';
        };
      }
    }

    async function checkAuth() {
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (user) {
        state.user.loggedIn = true;
        state.user.data = user;
        const { data: record } = await supabaseClient
          .from('user_allergies')
          .select('allergens, diets')
          .eq('user_id', user.id)
          .maybeSingle();

        if (record) {
          state.allergies = (record.allergens || []).map(norm);
          state.diets = record.diets || [];
          renderSelector(document.getElementById('savedChips'));
          renderDietSelector(document.getElementById('dietChips'));
        }
      }
      return state.user.loggedIn;
    }

    function renderTopbar() {
      const topbar = document.getElementById('topbar');
      topbar.innerHTML = '';

      const brand = div(`<img src="https://static.wixstatic.com/media/945e9d_2b97098295d341d493e4a07d80d6b57c~mv2.png" alt=""><span>Clarivore</span>`, 'brand');
      brand.onclick = () => {
        if (state.user?.loggedIn) {
          window.location.href = 'home.html';
        } else {
          window.location.href = 'index.html';
        }
      };
      topbar.appendChild(brand);

      const navWrap = div('', 'topNav');
      const tabs = div('', 'tabs');

      if (state.user?.loggedIn) {
        // Show "Home" for logged-in users
        const homeTab = div('Home', 'tab');
        homeTab.onclick = () => {
          window.location.href = 'home.html';
        };
        tabs.appendChild(homeTab);

        // Show "Account" for logged-in users
        const accountTab = div('Account', 'tab');
        accountTab.onclick = () => {
          window.location.href = 'account.html';
        };
        tabs.appendChild(accountTab);
      } else {
        // Show "Sign in" for non-logged-in users
        const signInTab = div('Sign in', 'tab');
        signInTab.onclick = () => {
          window.location.href = 'account.html';
        };
        tabs.appendChild(signInTab);
      }

      navWrap.appendChild(tabs);
      topbar.appendChild(navWrap);
    }

    async function render() {
      const root = document.getElementById('root');
      root.innerHTML = `
    <div class="topin" id="topbar"></div>
    <div style="max-width:900px;margin:0 auto;padding:20px">
      <div class="pill">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;flex-wrap:wrap;gap:8px">
          <div style="font-weight:600">Select Your Allergens</div>
        </div>
        <div id="savedChips"></div>
      </div>
      <div class="pill">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;flex-wrap:wrap;gap:8px">
          <div style="font-weight:600">Dietary Preferences</div>
        </div>
        <div id="dietChips"></div>
      </div>
      <p class="error-text" id="allergyError">Please select at least one allergen or dietary preference</p>
      <div class="pill">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;flex-wrap:wrap;gap:8px">
          <div style="font-weight:600">Choose a Restaurant</div>
        </div>
        <div class="restaurant-dropdown">
          <input type="text" class="search-input" id="restaurantSearch" placeholder="Search for a restaurant...">
          <div class="restaurant-suggestions" id="restaurantSuggestions"></div>
          <div class="selected-restaurant" id="selectedRestaurant"></div>
        </div>
      </div>
      <p class="error-text" id="restaurantError">Please select a restaurant</p>
      <div class="banner" id="disclaimerBanner" style="display:none">
        <span>Reference only. Ingredients & practices can change. Always inform staff about your allergens.</span>
        <button class="ackBtn off" id="ackBtn">I understand</button>
      </div>
    </div>
      `;

      renderSelector(document.getElementById('savedChips'));
      renderDietSelector(document.getElementById('dietChips'));

      // Wait for auth check to complete before rendering navigation and queueing promo
      const isLoggedIn = await checkAuth();
      renderTopbar();

      loadRestaurants();
      setupListeners();

      // Start promo timer for non-logged-in users
      if (!isLoggedIn) {
        queueQrPromoTimer();
      }
    }

    render();
  </script>
</body>
</html>
