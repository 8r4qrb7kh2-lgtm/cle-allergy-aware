<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Account Settings - Clarivore</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body class="page-shell">
  <header class="simple-topbar">
    <div class="simple-topbar-inner">
      <a class="simple-brand" href="account.html">
        <img src="https://static.wixstatic.com/media/945e9d_2b97098295d341d493e4a07d80d6b57c~mv2.png" alt="Clarivore logo">
        <span>Clarivore</span>
      </a>
      <div class="simple-nav">
        <!-- Navigation populated by shared-nav.js -->
        <button id="navReturnMenu" type="button" style="display:none;">Back to menu</button>
      </div>
    </div>
  </header>

  <main class="page-main">
    <div class="page-content">
      <div class="account-layout">
        <!-- Sign-in card -->
        <section id="auth-section" class="auth-card">
          <h2>Manage your allergy profile</h2>
          <p class="muted-text">Sign in to manage your saved allergens and view participating restaurants.</p>
          <input type="email" id="email" placeholder="Email" autocomplete="email">
          <input type="password" id="password" placeholder="Password" autocomplete="current-password">
          <div class="auth-actions">
            <button class="primary-btn" id="login-btn">Sign in</button>
            <button class="secondary-btn" id="start-signup-btn" type="button">Create an account</button>
          </div>
          <button class="link-btn" id="forgot-password-btn" type="button">Forgot your password?</button>
          <p id="auth-message" class="status-text"></p>
        </section>

        <!-- Sign-up card -->
        <section id="signup-view" class="auth-card" style="display:none;">
          <div class="auth-actions" style="justify-content:space-between;">
            <h2 style="margin:0;">Create your account</h2>
            <button class="secondary-btn" id="signup-back-btn" type="button">‚Üê Back</button>
          </div>
          <div class="form-row">
            <input type="text" id="signup-first-name" placeholder="First name" autocomplete="given-name">
            <input type="text" id="signup-last-name" placeholder="Last name" autocomplete="family-name">
          </div>
          <input type="email" id="signup-email" placeholder="Email" autocomplete="email">
          <input type="password" id="signup-password" placeholder="Password" autocomplete="new-password">
          <div>
            <p class="muted-text" style="margin-bottom:8px;">Select the allergens you avoid (you can update this later).</p>
            <div id="signup-allergen-pills" class="allergen-select"></div>
          </div>
          <div class="auth-actions">
            <button class="primary-btn" id="signup-submit-btn" type="button">Create account</button>
          </div>
          <p id="signup-message" class="status-text"></p>
        </section>

        <!-- Personal details -->
        <section id="details-section" class="auth-card" style="display:none;">
          <h2 style="margin:0;">Your information</h2>
          <div class="form-row">
            <input type="text" id="profile-first-name" placeholder="First name" autocomplete="given-name">
            <input type="text" id="profile-last-name" placeholder="Last name" autocomplete="family-name">
          </div>
          <input type="email" id="profile-email" placeholder="Email" autocomplete="email">
          <p class="muted-text">Updating your email will send a confirmation message.</p>
          <div class="auth-actions">
            <button class="primary-btn" id="details-save-btn" type="button">Save details</button>
          </div>
          <p id="details-status" class="status-text"></p>
        </section>

        <!-- Allergen settings (shown when logged in) -->
        <section id="allergen-section" class="auth-card" style="display:none;">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
            <h2 style="margin:0;">My Allergens</h2>
            <button class="primary-btn" id="save-btn" type="button">Save changes</button>
          </div>
          <div id="allergen-pills" class="allergen-select"></div>
          <p id="allergen-status" class="status-text" style="display:none;"></p>
        </section>

        <!-- Dietary Preferences settings (shown when logged in) -->
        <section id="diet-section" class="auth-card" style="display:none;">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
            <h2 style="margin:0;">My Dietary Preferences</h2>
            <button class="primary-btn" id="save-diet-btn" type="button">Save changes</button>
          </div>
          <div id="diet-pills" class="allergen-select"></div>
          <p id="diet-status" class="status-text" style="display:none;"></p>
        </section>

        <!-- Sign out section (shown when logged in) -->
        <section id="sign-out-section" class="auth-card" style="display:none;">
          <div style="text-align:center;">
            <button class="secondary-btn" id="sign-out-btn" type="button">Sign out</button>
          </div>
        </section>

        <!-- Password reset -->
        <section id="password-reset-section" class="auth-card" style="display:none;">
          <h2 style="margin:0 0 12px;">Set a new password</h2>
          <p class="muted-text" style="margin-bottom:12px;">Enter a new password for your Clarivore account.</p>
          <input type="password" id="reset-password" placeholder="New password" autocomplete="new-password">
          <input type="password" id="reset-password-confirm" placeholder="Confirm new password" autocomplete="new-password">
          <div class="auth-actions">
            <button class="primary-btn" id="reset-password-btn" type="button">Update password</button>
            <button class="secondary-btn" id="reset-cancel-btn" type="button">Cancel</button>
          </div>
          <p id="reset-message" class="status-text"></p>
        </section>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module">
    import supabaseClient from './js/supabase-client.js';
    import { setupNav, attachSignOutHandler } from './js/shared-nav.js';

    const ALLERGENS = ["dairy", "egg", "peanut", "tree nut", "shellfish", "fish", "soy", "sesame", "wheat"];
    const DIETS = ["Vegan", "Vegetarian", "Pescatarian", "Kosher", "Halal"];
    const ALLERGEN_EMOJI = {
      'dairy': 'ü•õ',
      'egg': 'ü•ö',
      'peanut': 'ü•ú',
      'tree nut': 'üå∞',
      'shellfish': 'ü¶ê',
      'fish': 'üêü',
      'soy': 'ü´õ',
      'sesame': 'ü´ò',
      'wheat': 'üåæ'
    };
    const DIET_EMOJI = {
      'Vegan': 'üå±',
      'Vegetarian': 'ü•¨',
      'Pescatarian': 'üêü',
      'Kosher': '‚ú°Ô∏è',
      'Halal': '‚ò™Ô∏è'
    };
    let selectedAllergies = [];
    let selectedDiets = [];
    let signupAllergies = [];
    let currentUser = null;
    const params = new URLSearchParams(window.location.search);
    const redirectParam = params.get('redirect') || null;
    const returnSlug = params.get('returnSlug');
    const hashParams = new URLSearchParams((window.location.hash || '').replace(/^#/, ''));
    let isRecoveryMode = hashParams.get('type') === 'recovery';
    if (isRecoveryMode) {
      window.history.replaceState({}, document.title, window.location.pathname + window.location.search);
    }

    const navReturnMenu = document.getElementById('navReturnMenu');
    const authSection = document.getElementById('auth-section');
    const signupView = document.getElementById('signup-view');
    const detailsSection = document.getElementById('details-section');
    const allergenSection = document.getElementById('allergen-section');
    const dietSection = document.getElementById('diet-section');
    const signOutSection = document.getElementById('sign-out-section');
    const authMessage = document.getElementById('auth-message');
    const signupMessage = document.getElementById('signup-message');
    const allergenStatus = document.getElementById('allergen-status');
    const dietStatus = document.getElementById('diet-status');
    const detailsStatus = document.getElementById('details-status');
    const profileFirstName = document.getElementById('profile-first-name');
    const profileLastName = document.getElementById('profile-last-name');
    const profileEmail = document.getElementById('profile-email');
    const forgotPasswordBtn = document.getElementById('forgot-password-btn');
    const passwordResetSection = document.getElementById('password-reset-section');
    const resetPasswordInput = document.getElementById('reset-password');
    const resetPasswordConfirmInput = document.getElementById('reset-password-confirm');
    const resetPasswordBtn = document.getElementById('reset-password-btn');
    const resetCancelBtn = document.getElementById('reset-cancel-btn');
    const resetMessage = document.getElementById('reset-message');

    function setNavState(user) {
      const fromQr = !!returnSlug;
      const showBackToMenu = fromQr && !user;

      navReturnMenu.style.display = showBackToMenu ? 'inline-flex' : 'none';
      if (showBackToMenu) {
        navReturnMenu.onclick = () => {
          const url = `restaurant.html?slug=${encodeURIComponent(returnSlug)}&qr=1`;
          window.location.href = url;
        };
      }

      // Setup navigation with current page indicator
      if (!isRecoveryMode) {
        setupNav('account', user);
        attachSignOutHandler(supabaseClient);
      }
    }

    async function checkAuth() {
      const { data: { user } } = await supabaseClient.auth.getUser();
      currentUser = user;
      setNavState(user);

      if (user) {
        if (isRecoveryMode) {
          authSection.style.display = 'none';
          signupView.style.display = 'none';
          detailsSection.style.display = 'none';
          allergenSection.style.display = 'none';
          dietSection.style.display = 'none';
          signOutSection.style.display = 'none';
          passwordResetSection.style.display = 'flex';
          resetPasswordInput.value = '';
          resetPasswordConfirmInput.value = '';
          resetMessage.textContent = '';
          resetMessage.classList.remove('error','success');
          return;
        }

        authSection.style.display = 'none';
        signupView.style.display = 'none';
        detailsSection.style.display = 'flex';
        allergenSection.style.display = 'flex';
        dietSection.style.display = 'flex';
        signOutSection.style.display = 'flex';
        passwordResetSection.style.display = 'none';
        populateDetails(user);
        await loadAllergies();
        await loadDiets();
        if (!returnSlug && redirectParam === 'restaurants') {
          window.location.href = 'restaurants.html';
          return;
        }
        if (!returnSlug && redirectParam === 'favorites') {
          window.location.href = 'favorites.html';
          return;
        }
      } else {
        allergenSection.style.display = 'none';
        dietSection.style.display = 'none';
        signOutSection.style.display = 'none';
        detailsSection.style.display = 'none';
        signupView.style.display = 'none';
        authSection.style.display = 'flex';
        passwordResetSection.style.display = 'none';
        if (isRecoveryMode) {
          isRecoveryMode = false;
        }
      }
    }

    async function loadAllergies() {
      if (!currentUser) return;
      allergenStatus.textContent = '';
      allergenStatus.classList.remove('error','success');
      const { data } = await supabaseClient
        .from('user_allergies')
        .select('allergens')
        .eq('user_id', currentUser.id)
        .maybeSingle();
      // Filter out any allergens not in current ALLERGENS list (removes legacy data like 'gluten')
      const dbAllergens = data?.allergens || [];
      selectedAllergies = dbAllergens.filter(a => ALLERGENS.includes(a));
      // If we filtered anything out, save the cleaned list back to the database
      if (dbAllergens.length !== selectedAllergies.length) {
        await saveAllergies(selectedAllergies);
      }
      renderAllergens();
    }

    function renderAllergens() {
      const container = document.getElementById('allergen-pills');
      container.innerHTML = '';
      ALLERGENS.forEach(allergen => {
        const pill = document.createElement('button');
        pill.type = 'button';
        pill.className = 'chip' + (selectedAllergies.includes(allergen) ? ' active' : '');
        const emoji = ALLERGEN_EMOJI[allergen] || '';
        pill.textContent = emoji + ' ' + allergen.charAt(0).toUpperCase() + allergen.slice(1);
        pill.onclick = () => {
          if (selectedAllergies.includes(allergen)) {
            selectedAllergies = selectedAllergies.filter(a => a !== allergen);
          } else {
            selectedAllergies.push(allergen);
          }
          renderAllergens();
        };
        container.appendChild(pill);
      });
    }

    async function loadDiets() {
      if (!currentUser) return;
      dietStatus.textContent = '';
      dietStatus.classList.remove('error','success');
      const { data } = await supabaseClient
        .from('user_allergies')
        .select('diets')
        .eq('user_id', currentUser.id)
        .maybeSingle();
      selectedDiets = data?.diets || [];
      renderDiets();
    }

    function renderDiets() {
      const container = document.getElementById('diet-pills');
      container.innerHTML = '';
      DIETS.forEach(diet => {
        const pill = document.createElement('button');
        pill.type = 'button';
        pill.className = 'chip' + (selectedDiets.includes(diet) ? ' active' : '');
        const emoji = DIET_EMOJI[diet] || '';
        pill.textContent = emoji + ' ' + diet;
        pill.onclick = () => {
          if (selectedDiets.includes(diet)) {
            selectedDiets = selectedDiets.filter(d => d !== diet);
          } else {
            selectedDiets.push(diet);
          }
          renderDiets();
        };
        container.appendChild(pill);
      });
    }

    async function saveDiets(diets) {
      if (!currentUser) return;
      // Get current allergens to preserve them
      const { data: current } = await supabaseClient
        .from('user_allergies')
        .select('allergens, diets')
        .eq('user_id', currentUser.id)
        .maybeSingle();

      const payload = {
        user_id: currentUser.id,
        allergens: current?.allergens || [],
        updated_at: new Date().toISOString()
      };

      // Only include diets if the column exists
      if (current && 'diets' in current) {
        payload.diets = diets;
      } else {
        // If diets column doesn't exist, throw a helpful error
        throw new Error('Dietary preferences feature requires a database update. Please contact support.');
      }

      const { error } = await supabaseClient
        .from('user_allergies')
        .upsert(payload, { onConflict: 'user_id' });
      if (error) throw error;
    }

    function renderSignupAllergens() {
      const container = document.getElementById('signup-allergen-pills');
      container.innerHTML = '';
      ALLERGENS.forEach(allergen => {
        const pill = document.createElement('button');
        pill.type = 'button';
        pill.className = 'chip' + (signupAllergies.includes(allergen) ? ' active' : '');
        const emoji = ALLERGEN_EMOJI[allergen] || '';
        pill.textContent = emoji + ' ' + allergen.charAt(0).toUpperCase() + allergen.slice(1);
        pill.onclick = () => {
          if (signupAllergies.includes(allergen)) {
            signupAllergies = signupAllergies.filter(a => a !== allergen);
          } else {
            signupAllergies.push(allergen);
          }
          renderSignupAllergens();
        };
        container.appendChild(pill);
      });
    }

    async function saveAllergies(allergies) {
      if (!currentUser) return;
      // Get current diets to preserve them
      const { data: current } = await supabaseClient
        .from('user_allergies')
        .select('diets')
        .eq('user_id', currentUser.id)
        .maybeSingle();

      const payload = {
        user_id: currentUser.id,
        allergens: allergies,
        updated_at: new Date().toISOString()
      };

      // Only include diets if the column exists in the response
      if (current && 'diets' in current) {
        payload.diets = current.diets || [];
      }

      const { error } = await supabaseClient
        .from('user_allergies')
        .upsert(payload, { onConflict: 'user_id' });
      if (error) throw error;
    }

    function populateDetails(user) {
      profileFirstName.value = user?.user_metadata?.first_name || '';
      profileLastName.value = user?.user_metadata?.last_name || '';
      profileEmail.value = user?.email || '';
      detailsStatus.textContent = '';
      detailsStatus.classList.remove('error','success');
    }

    document.getElementById('save-btn').onclick = async () => {
      if (!currentUser) return;
      const saveBtn = document.getElementById('save-btn');
      const originalText = saveBtn.textContent;
      allergenStatus.textContent = '';
      allergenStatus.style.display = 'none';
      try {
        await saveAllergies(selectedAllergies);
        saveBtn.textContent = 'Saved!';
        saveBtn.style.background = '#22c55e';
        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtn.style.background = '';
        }, 2000);
      } catch (error) {
        allergenStatus.textContent = error.message || 'Failed to save.';
        allergenStatus.classList.remove('success');
        allergenStatus.classList.add('error');
        allergenStatus.style.display = 'block';
      }
    };

    document.getElementById('save-diet-btn').onclick = async () => {
      if (!currentUser) return;
      const saveDietBtn = document.getElementById('save-diet-btn');
      const originalText = saveDietBtn.textContent;
      dietStatus.textContent = '';
      dietStatus.style.display = 'none';
      try {
        await saveDiets(selectedDiets);
        saveDietBtn.textContent = 'Saved!';
        saveDietBtn.style.background = '#22c55e';
        setTimeout(() => {
          saveDietBtn.textContent = originalText;
          saveDietBtn.style.background = '';
        }, 2000);
      } catch (error) {
        dietStatus.textContent = error.message || 'Failed to save.';
        dietStatus.classList.remove('success');
        dietStatus.classList.add('error');
        dietStatus.style.display = 'block';
      }
    };

    document.getElementById('login-btn').onclick = async () => {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      authMessage.textContent = '';
      authMessage.classList.remove('error', 'success');

      if (!email || !password) {
        authMessage.textContent = 'Please enter your email and password.';
        authMessage.classList.add('error');
        return;
      }

      const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) {
        authMessage.textContent = error.message;
        authMessage.classList.add('error');
      } else {
        authMessage.textContent = '';
        await checkAuth();
      }
    };

    forgotPasswordBtn.addEventListener('click', async () => {
      const email = document.getElementById('email').value.trim();
      authMessage.textContent = '';
      authMessage.classList.remove('error','success');
      if (!email) {
        authMessage.textContent = 'Enter your email first, then tap "Forgot your password?"';
        authMessage.classList.add('error');
        return;
      }
      try {
        const redirectTo = `${window.location.origin}/account.html#type=recovery`;
        const { error } = await supabaseClient.auth.resetPasswordForEmail(email, { redirectTo });
        if (error) throw error;
        authMessage.textContent = 'Password reset email sent! Check your inbox.';
        authMessage.classList.add('success');
      } catch (error) {
        authMessage.textContent = error.message || 'Unable to send reset email.';
        authMessage.classList.add('error');
      }
    });

    document.getElementById('start-signup-btn').onclick = () => {
      authMessage.textContent = '';
      authSection.style.display = 'none';
      signupView.style.display = 'flex';
      signupAllergies = [];
      signupMessage.textContent = '';
      signupMessage.classList.remove('error','success');
      renderSignupAllergens();
    };

    document.getElementById('signup-back-btn').onclick = () => {
      signupMessage.textContent = '';
      signupView.style.display = 'none';
      authSection.style.display = 'flex';
      signupAllergies = [];
    };

    document.getElementById('signup-submit-btn').onclick = async () => {
      const firstName = document.getElementById('signup-first-name').value.trim();
      const lastName = document.getElementById('signup-last-name').value.trim();
      const email = document.getElementById('signup-email').value.trim();
      const password = document.getElementById('signup-password').value;
      signupMessage.textContent = '';
      signupMessage.classList.remove('error', 'success');

      if (!firstName || !lastName || !email || !password) {
        signupMessage.textContent = 'Please fill in all fields.';
        signupMessage.classList.add('error');
        return;
      }

      const { error } = await supabaseClient.auth.signUp({
        email,
        password,
        options: {
          data: { first_name: firstName, last_name: lastName, allergies: signupAllergies }
        }
      });

      if (error) {
        signupMessage.textContent = error.message;
        signupMessage.classList.add('error');
        return;
      }

      signupMessage.textContent = 'Account created! Check your email to confirm.';
      signupMessage.classList.add('success');

      // Attempt immediate login if session returned (email confirmations disabled)
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (session) {
        // Save allergens immediately after signup
        try {
          const { data: { user } } = await supabaseClient.auth.getUser();
          if (user && signupAllergies.length > 0) {
            await supabaseClient
              .from('user_allergies')
              .upsert({
                user_id: user.id,
                allergens: signupAllergies,
                updated_at: new Date().toISOString()
              }, { onConflict: 'user_id' });
          }
        } catch (err) {
          console.error('Failed to save initial allergens', err);
        }
        await checkAuth();
        signupAllergies = [];
      } else {
        setTimeout(() => {
          signupView.style.display = 'none';
          authSection.style.display = 'flex';
          signupAllergies = [];
        }, 1500);
      }
    };

    document.getElementById('details-save-btn').onclick = async () => {
      if (!currentUser) return;
      const firstName = profileFirstName.value.trim();
      const lastName = profileLastName.value.trim();
      const email = profileEmail.value.trim();
      detailsStatus.textContent = '';
      detailsStatus.classList.remove('error','success');

      if (!firstName || !lastName || !email) {
        detailsStatus.textContent = 'Please fill in your first name, last name, and email.';
        detailsStatus.classList.add('error');
        return;
      }

      const payload = {
        data: { first_name: firstName, last_name: lastName }
      };
      if (email !== currentUser.email) {
        payload.email = email;
      }

      const { data, error } = await supabaseClient.auth.updateUser(payload);
      if (error) {
        detailsStatus.textContent = error.message;
        detailsStatus.classList.add('error');
        return;
      }

      currentUser = data.user;
      detailsStatus.textContent = 'Details saved.';
      detailsStatus.classList.add('success');
      setNavState(currentUser);
    };

    // Sign out button handler
    const signOutBtn = document.getElementById('sign-out-btn');
    if (signOutBtn) {
      signOutBtn.addEventListener('click', async () => {
        await supabaseClient.auth.signOut();
        selectedAllergies = [];
        selectedDiets = [];
        signupAllergies = [];
        await checkAuth();
      });
    }

    resetPasswordBtn.addEventListener('click', async () => {
      resetMessage.textContent = '';
      resetMessage.classList.remove('error','success');
      const password = resetPasswordInput.value;
      const confirm = resetPasswordConfirmInput.value;
      if (!password || !confirm) {
        resetMessage.textContent = 'Enter and confirm your new password.';
        resetMessage.classList.add('error');
        return;
      }
      if (password !== confirm) {
        resetMessage.textContent = 'Passwords do not match.';
        resetMessage.classList.add('error');
        return;
      }
      if (password.length < 8) {
        resetMessage.textContent = 'Use at least 8 characters for your new password.';
        resetMessage.classList.add('error');
        return;
      }
      try {
        const { error } = await supabaseClient.auth.updateUser({ password });
        if (error) throw error;
        resetMessage.textContent = 'Password updated! You are signed in.';
        resetMessage.classList.add('success');
        isRecoveryMode = false;
        setTimeout(() => {
          checkAuth();
        }, 1200);
      } catch (error) {
        resetMessage.textContent = error.message || 'Unable to update password.';
        resetMessage.classList.add('error');
      }
    });

    resetCancelBtn.addEventListener('click', async () => {
      resetMessage.textContent = '';
      resetMessage.classList.remove('error','success');
      resetPasswordInput.value = '';
      resetPasswordConfirmInput.value = '';
      isRecoveryMode = false;
      await checkAuth();
    });

    checkAuth();
  </script>
  <script type="module" src="js/report-modal.js"></script>
</body>
</html>
