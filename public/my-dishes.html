<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="favicon.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Dishes - Clarivore</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .two-column-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
      max-width: 1400px;
      margin: 0 auto;
    }


    .column {
      min-width: 0;
    }

    .column-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .column-header h2 {
      margin: 0;
      font-size: 1.4rem;
      color: var(--text);
    }

    .column-description {
      color: var(--muted);
      font-size: 0.9rem;
      margin-bottom: 24px;
    }

    .restaurant-section {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .restaurant-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .restaurant-section-name {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .restaurant-section-name a {
      color: var(--accent);
      text-decoration: none;
    }

    .restaurant-section-name a:hover {
      text-decoration: underline;
    }

    .restaurant-dish-count {
      color: var(--muted);
      font-size: 0.85rem;
    }

    .dish-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: var(--soft);
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .dish-item:hover {
      background: var(--hover);
    }

    .dish-item:last-child {
      margin-bottom: 0;
    }

    .dish-name {
      font-size: 0.95rem;
      color: var(--text);
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .dish-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: 12px;
    }

    .dish-date {
      font-size: 0.75rem;
      color: var(--muted);
      white-space: nowrap;
    }

    .dish-launch-link {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4px;
      border-radius: 4px;
      color: var(--muted);
      transition: color 0.2s, background 0.2s;
    }

    .dish-launch-link:hover {
      color: var(--accent);
      background: rgba(76, 90, 212, 0.15);
    }

    .empty-state {
      color: var(--muted);
      padding: 40px 20px;
      border: 1px dashed var(--border);
      border-radius: 16px;
      text-align: center;
    }

    .loading {
      text-align: center;
      color: var(--muted);
      padding: 40px 20px;
    }

    .status-text {
      text-align: center;
      font-size: 0.95rem;
      margin-bottom: 20px;
    }

    .status-text.success {
      color: var(--ok);
    }

    .status-text.error {
      color: var(--bad);
    }

    .unlove-btn {
      background: transparent;
      border: none;
      padding: 4px 8px;
      cursor: pointer;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.75rem;
      color: var(--muted);
      transition: background 0.2s, color 0.2s;
    }

    .unlove-btn:hover {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .unlove-btn svg {
      width: 14px;
      height: 14px;
    }

    /* Mode toggle styles */
    .mode-toggle-container {
      display: none;
      align-items: center;
      gap: 10px;
      margin-left: auto;
      padding-left: 16px;
    }

    .mode-toggle-label {
      font-size: 0.85rem;
      color: var(--muted);
      white-space: nowrap;
    }

    .mode-toggle {
      width: 44px;
      height: 24px;
      background: var(--border);
      border-radius: 12px;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
    }

    .mode-toggle::after {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: transform 0.2s;
    }

    .mode-toggle.active {
      background: var(--accent);
    }

    .mode-toggle.active::after {
      transform: translateX(20px);
    }
  </style>
</head>

<body class="page-shell">
  <header class="simple-topbar">
    <div class="simple-topbar-inner">
      <a class="simple-brand" href="home.html">
        <img src="https://static.wixstatic.com/media/945e9d_2b97098295d341d493e4a07d80d6b57c~mv2.png"
          alt="Clarivore logo">
        <span>Clarivore</span>
      </a>
      <div class="simple-nav">
        <!-- Navigation populated by shared-nav.js -->
      </div>
      <div class="mode-toggle-container" id="modeToggleContainer">
        <!-- Mode toggle populated by JS for managers/owner -->
      </div>
    </div>
  </header>

  <main class="page-main">
    <div class="page-content">
      <h1 style="text-align:center;margin-bottom:8px;">My Dishes</h1>
      <p style="text-align:center;color:var(--muted);margin-bottom:32px;">Your favorite and previously ordered dishes</p>

      <p id="status-message" class="status-text" style="display:none;"></p>

      <div class="two-column-container">
        <!-- Left Column: Loved Dishes -->
        <div class="column">
          <div class="column-header">
            <h2>Loved Dishes</h2>
          </div>
          <p class="column-description">Dishes you've saved to your favorites</p>
          <div id="loved-dishes-container">
            <div class="loading">Loading your favorite dishes...</div>
          </div>
        </div>

        <!-- Right Column: Previously Ordered -->
        <div class="column">
          <div class="column-header">
            <h2>Previously Ordered</h2>
          </div>
          <p class="column-description">Dishes from your approved orders</p>
          <div id="ordered-dishes-container">
            <div class="loading">Loading your order history...</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Initialize Supabase client for this page
    const SUPABASE_URL = 'https://fgoiyycctnwnghrvsilt.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZnb2l5eWNjdG53bmdocnZzaWx0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MzY1MjYsImV4cCI6MjA3NjAxMjUyNn0.xlSSXr0Gl7j-vsckrj-2anpPmp4BG2SUIdN-_dquSA8';
    const { createClient } = supabase;
    window.supabaseClient = window.supabaseClient || createClient(SUPABASE_URL, SUPABASE_KEY);
    window.SUPABASE_ANON_KEY = SUPABASE_KEY;
  </script>
  <script type="module">
    import supabaseClient from './js/supabase-client.js';
    import { setupNav } from './js/shared-nav.js';
    import { fetchManagerRestaurants } from './js/manager-context.js';

    let currentUser = null;
    const lovedDishesContainer = document.getElementById('loved-dishes-container');
    const orderedDishesContainer = document.getElementById('ordered-dishes-container');
    const statusMessage = document.getElementById('status-message');
    const lovedDishesSet = new Set();

    function setStatus(message, type = '') {
      statusMessage.textContent = message;
      statusMessage.className = type ? `status-text ${type}` : 'status-text';
      statusMessage.style.display = message ? 'block' : 'none';
      if (message) {
        setTimeout(() => {
          statusMessage.style.display = 'none';
        }, 3000);
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function getDishKey(restaurantId, dishName) {
      return `${String(restaurantId)}:${dishName}`;
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

      if (diffDays === 0) return 'Today';
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return `${diffDays} days ago`;
      if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
      return date.toLocaleDateString();
    }

    function renderDishItem(dish, restaurantSlug, isLoved, showUnloveButton = false) {
      const dishKey = getDishKey(dish.restaurant_id, dish.dish_name).replace(/[^a-zA-Z0-9]/g, '-');
      const dishUrl = `restaurant.html?slug=${encodeURIComponent(restaurantSlug || '')}&dishName=${encodeURIComponent(dish.dish_name)}`;
      const dateStr = dish.created_at ? formatDate(dish.created_at) : '';

      const unloveBtn = showUnloveButton ? `
        <button class="unlove-btn" data-restaurant-id="${dish.restaurant_id}" data-dish-name="${escapeHtml(dish.dish_name)}" title="Remove from favorites" onclick="event.stopPropagation()">
          <svg viewBox="0 0 24 24" fill="currentColor" stroke="none">
            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
          </svg>
          Remove
        </button>
      ` : '';

      return `
        <div class="dish-item" data-restaurant-slug="${restaurantSlug || ''}" data-dish-name="${escapeHtml(dish.dish_name)}" data-restaurant-id="${dish.restaurant_id}">
          <span class="dish-name">${escapeHtml(dish.dish_name)}</span>
          <span class="dish-actions">
            ${unloveBtn}
            ${dateStr ? `<span class="dish-date">${dateStr}</span>` : ''}
            <a href="${dishUrl}" class="dish-launch-link" title="View dish details" onclick="event.stopPropagation()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                <polyline points="15 3 21 3 21 9"/>
                <line x1="10" y1="14" x2="21" y2="3"/>
              </svg>
            </a>
          </span>
        </div>
      `;
    }

    async function loadLovedDishes() {
      try {
        lovedDishesContainer.innerHTML = '<div class="loading">Loading your favorite dishes...</div>';

        // Fetch loved dishes for the current user
        const { data: lovedDishesData, error: lovedError } = await supabaseClient
          .from('user_loved_dishes')
          .select('restaurant_id, dish_name, created_at')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false });

        if (lovedError) throw lovedError;

        lovedDishesSet.clear();
        if (lovedDishesData) {
          lovedDishesData.forEach(d => {
            lovedDishesSet.add(getDishKey(d.restaurant_id, d.dish_name));
          });
        }

        if (!lovedDishesData || lovedDishesData.length === 0) {
          lovedDishesContainer.innerHTML = `
            <div class="empty-state">
              <p style="font-size:1.1rem;margin-bottom:8px;">No favorite dishes yet</p>
              <p style="margin-bottom:16px;">Click the heart icon on any dish to save it!</p>
              <a href="dish-search.html" style="color:var(--accent);text-decoration:none;">Search for dishes →</a>
            </div>
          `;
          return;
        }

        // Get unique restaurant IDs
        const restaurantIds = [...new Set(lovedDishesData.map(d => d.restaurant_id))];

        // Fetch restaurant details
        const { data: restaurantsData, error: restaurantsError } = await supabaseClient
          .from('restaurants')
          .select('id, name, slug')
          .in('id', restaurantIds);

        if (restaurantsError) throw restaurantsError;

        // Create a map of restaurant data
        const restaurantsMap = new Map();
        (restaurantsData || []).forEach(r => {
          restaurantsMap.set(r.id, r);
        });

        // Group dishes by restaurant
        const dishesByRestaurant = {};
        lovedDishesData.forEach(dish => {
          if (!dishesByRestaurant[dish.restaurant_id]) {
            dishesByRestaurant[dish.restaurant_id] = [];
          }
          dishesByRestaurant[dish.restaurant_id].push(dish);
        });

        // Sort restaurants by number of loved dishes (most first)
        const restaurantEntries = Object.entries(dishesByRestaurant).sort((a, b) => {
          return b[1].length - a[1].length;
        });

        // Render dishes grouped by restaurant
        let html = '';
        restaurantEntries.forEach(([restaurantId, dishes]) => {
          const restaurant = restaurantsMap.get(restaurantId);
          const restaurantName = restaurant?.name || 'Unknown Restaurant';
          const restaurantSlug = restaurant?.slug || '';
          const count = dishes.length;

          html += `
            <div class="restaurant-section">
              <div class="restaurant-section-header">
                <h3 class="restaurant-section-name">
                  ${restaurantSlug ? `<a href="restaurant.html?slug=${encodeURIComponent(restaurantSlug)}">${escapeHtml(restaurantName)}</a>` : escapeHtml(restaurantName)}
                </h3>
                <span class="restaurant-dish-count">${count} dish${count !== 1 ? 'es' : ''}</span>
              </div>
              ${dishes.map(dish => renderDishItem(dish, restaurantSlug, true, true)).join('')}
            </div>
          `;
        });

        lovedDishesContainer.innerHTML = html;
        attachHandlers();
        attachUnloveHandlers();

      } catch (err) {
        console.error('Failed to load loved dishes', err);
        lovedDishesContainer.innerHTML = '<div class="status-text error">Failed to load favorite dishes.</div>';
      }
    }

    async function loadPreviouslyOrderedDishes() {
      try {
        orderedDishesContainer.innerHTML = '<div class="loading">Loading your order history...</div>';

        // Fetch acknowledged orders for the current user
        const { data: orders, error } = await supabaseClient
          .from('tablet_orders')
          .select('restaurant_id, payload, created_at')
          .eq('status', 'acknowledged')
          .eq('payload->>userId', currentUser.id)
          .order('created_at', { ascending: false });

        if (error) throw error;

        if (!orders || orders.length === 0) {
          orderedDishesContainer.innerHTML = '<div class="empty-state">No order history found.</div>';
          return;
        }

        // Track dishes with their most recent order date
        const dishesMap = new Map();

        orders.forEach(order => {
          const payload = order.payload || {};
          const items = Array.isArray(payload.items) ? payload.items : [];

          items.forEach(dishName => {
            const key = getDishKey(order.restaurant_id, dishName);
            // Keep the most recent order date for each dish
            if (!dishesMap.has(key)) {
              dishesMap.set(key, {
                restaurant_id: order.restaurant_id,
                dish_name: dishName,
                created_at: order.created_at
              });
            }
          });
        });

        const uniqueDishes = Array.from(dishesMap.values());

        if (uniqueDishes.length === 0) {
          orderedDishesContainer.innerHTML = '<div class="empty-state">No dishes found in your order history.</div>';
          return;
        }

        const restaurantIds = [...new Set(uniqueDishes.map(d => d.restaurant_id))];

        const { data: restaurantsData, error: restaurantsError } = await supabaseClient
          .from('restaurants')
          .select('id, name, slug')
          .in('id', restaurantIds);

        if (restaurantsError) throw restaurantsError;

        const restaurantsMap = new Map();
        (restaurantsData || []).forEach(r => {
          restaurantsMap.set(r.id, r);
        });

        // Group dishes by restaurant, keeping track of most recent order per restaurant
        const dishesByRestaurant = {};
        const restaurantMostRecentOrder = {};

        uniqueDishes.forEach(dish => {
          if (!dishesByRestaurant[dish.restaurant_id]) {
            dishesByRestaurant[dish.restaurant_id] = [];
            restaurantMostRecentOrder[dish.restaurant_id] = dish.created_at;
          }
          dishesByRestaurant[dish.restaurant_id].push(dish);
          // Update most recent order for this restaurant
          if (new Date(dish.created_at) > new Date(restaurantMostRecentOrder[dish.restaurant_id])) {
            restaurantMostRecentOrder[dish.restaurant_id] = dish.created_at;
          }
        });

        // Sort restaurants by most recent order (most recent first)
        const restaurantEntries = Object.entries(dishesByRestaurant).sort((a, b) => {
          const dateA = new Date(restaurantMostRecentOrder[a[0]]);
          const dateB = new Date(restaurantMostRecentOrder[b[0]]);
          return dateB - dateA;
        });

        let html = '';
        restaurantEntries.forEach(([restaurantId, dishes]) => {
          const restaurant = restaurantsMap.get(restaurantId);
          const restaurantName = restaurant?.name || 'Unknown Restaurant';
          const restaurantSlug = restaurant?.slug || '';
          const count = dishes.length;

          // Sort dishes within restaurant by most recent first
          dishes.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

          html += `
            <div class="restaurant-section">
              <div class="restaurant-section-header">
                <h3 class="restaurant-section-name">
                  ${restaurantSlug ? `<a href="restaurant.html?slug=${encodeURIComponent(restaurantSlug)}">${escapeHtml(restaurantName)}</a>` : escapeHtml(restaurantName)}
                </h3>
                <span class="restaurant-dish-count">${count} dish${count !== 1 ? 'es' : ''}</span>
              </div>
              ${dishes.map(dish => {
                const key = getDishKey(restaurantId, dish.dish_name);
                const isLoved = lovedDishesSet.has(key);
                return renderDishItem(dish, restaurantSlug, isLoved);
              }).join('')}
            </div>
          `;
        });

        orderedDishesContainer.innerHTML = html;
        attachHandlers();

      } catch (err) {
        console.error('Failed to load ordered dishes', err);
        orderedDishesContainer.innerHTML = '<div class="status-text error">Failed to load order history.</div>';
      }
    }

    function attachHandlers() {
      // Dish item click handlers (navigate to restaurant page)
      document.querySelectorAll('.dish-item').forEach(item => {
        item.addEventListener('click', () => {
          const slug = item.dataset.restaurantSlug;
          const dishName = item.dataset.dishName;
          if (slug) {
            window.location.href = `restaurant.html?slug=${encodeURIComponent(slug)}&dishName=${encodeURIComponent(dishName)}`;
          }
        });
      });
    }

    function attachUnloveHandlers() {
      document.querySelectorAll('.unlove-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const restaurantId = btn.dataset.restaurantId;
          const dishName = btn.dataset.dishName;

          if (!restaurantId || !dishName) return;

          btn.disabled = true;
          btn.textContent = 'Removing...';

          try {
            const { error } = await supabaseClient
              .from('user_loved_dishes')
              .delete()
              .eq('user_id', currentUser.id)
              .eq('restaurant_id', restaurantId)
              .eq('dish_name', dishName);

            if (error) throw error;

            // Remove from local set
            lovedDishesSet.delete(getDishKey(restaurantId, dishName));

            // Remove the dish item from DOM
            const dishItem = btn.closest('.dish-item');
            const restaurantSection = dishItem.closest('.restaurant-section');
            dishItem.remove();

            // Check if restaurant section is now empty
            const remainingDishes = restaurantSection.querySelectorAll('.dish-item');
            if (remainingDishes.length === 0) {
              restaurantSection.remove();
            } else {
              // Update the dish count
              const countEl = restaurantSection.querySelector('.restaurant-dish-count');
              if (countEl) {
                const count = remainingDishes.length;
                countEl.textContent = `${count} dish${count !== 1 ? 'es' : ''}`;
              }
            }

            // Check if no loved dishes remain
            if (lovedDishesContainer.querySelectorAll('.dish-item').length === 0) {
              lovedDishesContainer.innerHTML = `
                <div class="empty-state">
                  <p style="font-size:1.1rem;margin-bottom:8px;">No favorite dishes yet</p>
                  <p style="margin-bottom:16px;">Click the heart icon on any dish to save it!</p>
                  <a href="dish-search.html" style="color:var(--accent);text-decoration:none;">Search for dishes →</a>
                </div>
              `;
            }

            setStatus('Dish removed from favorites', 'success');
          } catch (err) {
            console.error('Failed to unlove dish', err);
            setStatus('Failed to remove dish', 'error');
            btn.disabled = false;
            btn.innerHTML = `
              <svg viewBox="0 0 24 24" fill="currentColor" stroke="none">
                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
              </svg>
              Remove
            `;
          }
        });
      });
    }

    function setupModeToggle(isOwner, isManager) {
      if (!isOwner && !isManager) return;

      const modeToggleContainer = document.getElementById('modeToggleContainer');
      if (!modeToggleContainer) return;

      const currentMode = localStorage.getItem('clarivoreManagerMode') || 'editor';
      const isEditorMode = currentMode === 'editor';

      modeToggleContainer.style.display = 'flex';
      modeToggleContainer.innerHTML = `
        <span class="mode-toggle-label">${isEditorMode ? 'Editor mode' : 'Customer mode'}</span>
        <div class="mode-toggle ${isEditorMode ? 'active' : ''}" id="modeToggle" title="Toggle between Editor and Customer mode"></div>
      `;

      const toggle = document.getElementById('modeToggle');
      if (toggle) {
        toggle.onclick = () => {
          if (isEditorMode) {
            localStorage.setItem('clarivoreManagerMode', 'customer');
            window.location.href = 'home.html';
          } else {
            localStorage.setItem('clarivoreManagerMode', 'editor');
            window.location.href = 'manager-dashboard.html';
          }
        };
      }
    }

    async function checkAuth() {
      const { data: { user } } = await supabaseClient.auth.getUser();

      if (!user) {
        window.location.href = 'account.html';
        return;
      }

      const OWNER_EMAIL = 'matt.29.ds@gmail.com';
      const isOwner = user.email === OWNER_EMAIL;
      const isManager = user.user_metadata?.role === 'manager';

      let managerRestaurants = [];
      if (isManager || isOwner) {
        managerRestaurants = await fetchManagerRestaurants(supabaseClient, user.id);
      }

      if (isManager && !isOwner) {
        const targetRestaurant = managerRestaurants[0];
        window.location.href = targetRestaurant
          ? `restaurant.html?slug=${encodeURIComponent(targetRestaurant.slug)}`
          : 'server-tablet.html';
        return;
      }

      currentUser = user;
      setupNav('my-dishes', user, { managerRestaurants });
      setupModeToggle(isOwner, isManager);
      await Promise.all([
        loadLovedDishes(),
        loadPreviouslyOrderedDishes()
      ]);
    }

    // Initialize page
    checkAuth();
  </script>
</body>

</html>
