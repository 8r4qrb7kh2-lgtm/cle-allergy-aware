<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1">

<title>CLE Allergy Aware</title>
<style>
  :root{
    --bg:#0b1020; --panel:#111630; --ink:#e9ecff; --muted:#a8b2d6;
    --brand:#7c9cff; --ok:#22c55e; --warn:#facc15; --bad:#ef4444;
    --border:#2a3261; --hover:#4c5ad4; --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  html{
    margin:0;padding:0;height:100%;width:100%;
    overflow:auto;
    -webkit-overflow-scrolling:touch;
    touch-action: pan-x pan-y;
  }
  body{
    margin:0;padding:0;min-height:100%;width:100%;background:var(--bg);color:var(--ink);
    font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    overflow-x:hidden;
    overflow-y:auto;
    -webkit-overflow-scrolling:touch;
    box-sizing:border-box;
    touch-action: pan-x pan-y;
  }
  *{box-sizing:border-box; touch-action: pan-x pan-y;}
  .menuWrap, .menuInner, .overlayLayer, .overlay, .tip {
    touch-action: pan-x pan-y;
  }
  .wrap{min-height:100%;display:flex;flex-direction:column;width:100%}
  .content{flex:1;max-width:1100px;margin:0 auto;padding:16px;padding-bottom:100px;width:100%;box-sizing:border-box}
  a{color:inherit;text-decoration:none}

  .topbar{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,#0f1530,#0b1020);border-bottom:1px solid #1c2347;box-shadow:var(--shadow);width:100%}
  .topin{max-width:1100px;margin:0 auto;display:flex;flex-direction:column;align-items:center;gap:12px;padding:12px 22px 10px;flex-wrap:wrap;justify-content:center;box-sizing:border-box}
  .brand{display:flex;align-items:center;gap:16px;font-weight:800;flex-shrink:0;cursor:pointer}
  .brand img{width:52px;height:52px;border-radius:6px}
  .brand span{font-size:clamp(1.5rem,1.3rem + 1vw,2.1rem);}

  .topNav{display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:center}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  .tab{padding:8px 12px;border:1px solid var(--border);background:#12183a;border-radius:999px;cursor:pointer;white-space:nowrap}
  .acctBtn{padding:8px 12px;border:1px solid var(--border);background:#12183a;border-radius:999px;cursor:pointer;white-space:nowrap}

  .tab:hover,.btn:hover,.acctBtn:hover,.chip.clickable:hover,.ackBtn:hover,.pill:hover,.algBtn:hover{
    border-color:var(--hover); box-shadow:0 0 0 3px #7c9cff33 inset,0 2px 10px #0b1b60aa;
  }

  h1{font-size:clamp(1.4rem,1.1rem + 1.5vw,2rem);margin:6px 0 12px}
  .note{color:var(--muted)}

  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{padding:8px 10px;border:1px solid var(--border);background:#12183a;border-radius:999px;font-size:14px}
  .chip.active{border-color:#4c5ad4;box-shadow:0 0 0 3px #7c9cff33 inset,0 0 10px #24307a66}
  .chip.clickable{cursor:pointer;touch-action:manipulation;-webkit-tap-highlight-color:transparent}
  .pill{padding:10px 14px;border:1px dashed #33408c;border-radius:12px}

  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#1a2351;cursor:pointer;color:#fff}
  .btnPrimary{background:#3651ff;border-color:#4e65ff}
  .btnDanger{background:#8b1d1d;border-color:#a12525}
  .btnSuccess{background:#17663a;border-color:#1a7b46}
  .mgrRow{display:flex;justify-content:flex-end;margin:12px 0;gap:10px;flex-wrap:wrap}

  .cards{display:flex;flex-wrap:wrap;gap:16px;justify-content:center}
  .card{background:var(--panel);border:1px solid #1a2042;border-radius:16px;box-shadow:var(--shadow);width:330px;overflow:hidden}
  .card img{display:block;width:100%;height:160px;object-fit:cover}
  .card .pad{padding:12px}

  .banner{display:flex;align-items:center;gap:10px;background:#351b1b;border:1px solid #5b2c2c;border-radius:12px;padding:10px 12px;margin:10px 0}
  .legend{display:flex;gap:16px;align-items:center;flex-wrap:wrap;color:var(--muted);margin:10px 0 16px}
  .key{display:inline-block;width:14px;height:14px;border-radius:4px;border:2px solid currentColor}
  .key.ok{color:var(--ok)} .key.warn{color:var(--warn)} .key.bad{color:var(--bad)}

  .ackBtn{padding:8px 12px;border-radius:10px;cursor:pointer;border:1px solid}
  @keyframes ackPulse{
    0%{box-shadow:0 0 0 0 rgba(255,180,180,0.45);}
    50%{box-shadow:0 0 0 8px rgba(255,180,180,0);}
    100%{box-shadow:0 0 0 0 rgba(255,180,180,0);}
  }
  .ackBtn.off{background:#8b1d1d;border-color:#a12525;animation:ackPulse 1.8s ease-in-out infinite}
  .ackBtn.on{background:#17663a;border-color:#1a7b46;animation:none}

  /* Viewer: simple image that scales with page zoom */
  .menuWrap{display:none;background:#0d132a;border-radius:14px;position:relative;overflow-x:auto;overflow-y:visible;min-height:140px;transform-origin:top left;-webkit-overflow-scrolling:touch}
  .menuWrap.show{display:block}
  .menuInner{position:relative;display:inline-block;user-select:none;line-height:0;transform-origin:top left;min-width:100%}
  .menuImg{display:block;max-width:100%;height:auto;width:100%}
  .overlayLayer{position:absolute;left:0;top:0;pointer-events:none;line-height:normal;width:100%;height:100%}
  .overlay{position:absolute;border:1.5px solid;border-radius:4px;background:transparent;pointer-events:auto;box-sizing:border-box}
  .overlay:hover{box-shadow:0 0 0 3px #ffffff22,0 6px 16px rgba(0,0,0,.35)}
  .mobileMenuNotice{margin:16px 0;padding:14px 16px;border-radius:18px;background:rgba(18,24,58,0.75);border:1px solid rgba(76,90,212,0.4);color:var(--ink);text-align:center;display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center;box-shadow:0 14px 32px rgba(0,0,0,0.28)}
  .mobileMenuNoticeText{font-size:0.95rem;line-height:1.5;color:var(--muted)}
  .mobileMenuNotice .mobileMenuOpenBtn{min-width:200px}
  #mobileViewerChrome{position:fixed;inset:0;z-index:3400;display:none;pointer-events:none}
  body.mobileViewerActive #mobileViewerChrome{display:block}
  #mobileViewerChrome .chromeTop{position:fixed;top:calc(env(safe-area-inset-top,0) + 18px);left:0;right:0;display:flex;align-items:center;justify-content:space-between;gap:16px;padding:0 clamp(16px,4vw,32px);pointer-events:none}
  #mobileViewerChrome .chromeTop .mobileZoomGroup{pointer-events:auto}
  #mobileViewerChrome button{pointer-events:auto}
  .mobileViewerSummary{flex:1;display:flex;align-items:center;justify-content:center;pointer-events:none}
  .mobileViewerSummaryInner{display:inline-flex;align-items:center;gap:8px;padding:12px 24px;border-radius:999px;border:1px solid rgba(76,90,212,0.35);background:rgba(8,12,28,0.88);box-shadow:0 10px 28px rgba(0,0,0,0.35);color:var(--muted);flex-wrap:wrap;justify-content:center;max-width:min(96vw,840px)}
  .mobileViewerSummaryInner .label{font-weight:600;color:var(--ink)}
  .mobileViewerSummaryInner .values{color:var(--ink)}
  .mobileViewerControlBtn{background:rgba(18,24,58,0.9);border:1px solid rgba(76,90,212,0.5);color:var(--ink);padding:10px 18px;border-radius:999px;font-weight:600;cursor:pointer;box-shadow:0 10px 28px rgba(0,0,0,0.35)}
  .mobileZoomGroup{display:inline-flex;align-items:center;gap:14px;background:rgba(18,24,58,0.9);border:1px solid rgba(76,90,212,0.4);border-radius:999px;padding:10px 18px;box-shadow:0 10px 28px rgba(0,0,0,0.3)}
  .mobileZoomGroup button{background:transparent;border:none;color:var(--ink);font-size:1.3rem;width:48px;height:48px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}
  .mobileZoomGroup span{font-weight:600;color:var(--ink);min-width:60px;text-align:center;font-size:0.95rem}
  body.mobileViewerActive{overflow:hidden}
  body.mobileViewerActive .menuWrap{pointer-events:auto;position:fixed;inset:0;margin:0;border-radius:0;padding:calc(env(safe-area-inset-top,0) + 120px) clamp(14px,4vw,36px) calc(env(safe-area-inset-bottom,0) + 80px);background:rgba(4,7,20,0.96);z-index:3100;overflow:auto;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:32px}
  body.mobileViewerActive .menuWrap .menuInner{margin:0 auto}
  body.mobileViewerActive .mobileMenuNotice{display:none !important}
  body.mobileViewerActive .topbar,
  body.mobileViewerActive #root > :not(.menuWrap),
  body.mobileViewerActive .modalBack,
  body.mobileViewerActive .photoModal,
  body.mobileViewerActive .qrPromoBackdrop,
  body.mobileViewerActive .qrBanner{display:none !important}
  .ovBadge{position:absolute;top:3px;right:3px;width:18px;height:18px;background:#3651ff;border:1.5px solid #dbe2ff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold;cursor:pointer;z-index:10;pointer-events:auto;line-height:1}
  .ovBadge:hover{background:#4e65ff;box-shadow:0 0 6px #3651ff}
  .ovWarning{position:absolute;top:3px;left:3px;width:18px;height:18px;background:#facc15;border:1.5px solid #fef08a;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold;cursor:pointer;z-index:10;pointer-events:auto;line-height:1;color:#000;}
  .ovWarning:hover{background:#fbbf24;box-shadow:0 0 6px #facc15}

  /* Tooltip (with mobile X). We'll shrink it based on visual viewport scale. */
  .tip{position:absolute;z-index:3400;pointer-events:auto;background:rgba(15,21,52,0.98);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid #2a3466;border-radius:10px;padding:10px;box-shadow:var(--shadow);display:none;max-width:280px;transform-origin:top left}
  .tipHead{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px}
  .tTitle{font-weight:800}
  .tClose{border:1px solid #2a3466;background:#16205a;color:#fff;border-radius:8px;padding:4px 8px;cursor:pointer;line-height:1}
  .tClose:hover{border-color:var(--hover)}
  .tooltipList{margin:4px 0 0 18px;padding:0;list-style:disc}
  .tooltipList li{margin:3px 0}
  .tooltipDangerText{color:var(--bad);font-weight:500}
  .tooltipWarnText{color:var(--warn);font-weight:500}
  .tooltipNeutralText{color:#cbd5f5}

  .aiAssistBackdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:24px;background:rgba(7,11,28,0.85);z-index:3600}
  .aiAssistBackdrop.show{display:flex}
  .aiAssistPanel{width:min(960px,calc(100% - 32px));max-height:90vh;overflow:auto;background:linear-gradient(180deg,#111a3c,#0d132a);border:1px solid #2a3466;border-radius:20px;box-shadow:0 20px 50px rgba(0,0,0,0.5);padding:26px;display:flex;flex-direction:column;gap:18px}
  .aiAssistHead{display:flex;align-items:center;justify-content:space-between;gap:16px}
  .aiAssistHead h2{margin:0;font-size:clamp(1.1rem,1rem + 1vw,1.6rem)}
  .aiAssistClose{background:rgba(22,32,90,0.9);border:1px solid rgba(76,90,212,0.4);color:var(--ink);width:40px;height:40px;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:22px;line-height:1;touch-action:manipulation}
  .aiAssistClose:hover{border-color:var(--hover);box-shadow:0 0 8px #3651ff}
  .aiAssistClose:focus{outline:2px solid var(--hover);outline-offset:2px}
  .aiAssistIntro{margin:0;color:var(--muted);font-size:0.95rem}
  .aiAssistInput{width:100%;min-height:160px;border-radius:16px;border:1px solid rgba(76,90,212,0.35);background:rgba(10,16,36,0.95);color:var(--ink);padding:16px;font-size:1rem;resize:vertical}
  .aiAssistControls{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  .aiAssistStatus{font-size:0.9rem;color:var(--muted)}
  .aiAssistStatus[data-tone="warn"]{color:var(--warn)}
  .aiAssistStatus[data-tone="error"]{color:var(--bad)}
  .aiAssistStatus[data-tone="success"]{color:var(--ok)}
  .aiAssistMedia{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-top:6px}
  .aiAssistMedia button{background:#16205a;border:1px solid rgba(76,90,212,0.4);color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer}
  .aiAssistMedia button:hover{border-color:var(--hover);box-shadow:0 0 8px #3651ff}
  .aiAssistMediaPreview{display:none;flex-direction:column;gap:12px}
  .aiAssistMediaPreview.show{display:flex}
  .aiAssistMediaPreview video,.aiAssistMediaPreview img{max-width:320px;border-radius:12px;border:1px solid rgba(76,90,212,0.35);background:#000}
  .aiAssistPhotoControls{display:flex;gap:10px;flex-wrap:wrap}
  .aiAssistPhotoControls button{background:#16205a;border:1px solid rgba(76,90,212,0.4);color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
  .aiAssistPhotoControls button:hover{border-color:var(--hover);box-shadow:0 0 8px #3651ff}
  .aiAssistHidden{display:none !important}
  .aiAssistResults{display:none;flex-direction:column;gap:16px}
  .aiAssistResults.show{display:flex}
  .aiAssistTableWrapper{overflow-x:auto;border:1px solid rgba(76,90,212,0.35);border-radius:16px;background:rgba(9,13,30,0.9)}
  #aiAssistTable{width:100%;border-collapse:collapse;min-width:720px;font-size:0.95rem}
  #aiAssistTable th,#aiAssistTable td{padding:12px;border-bottom:1px solid rgba(76,90,212,0.2);vertical-align:top}
  #aiAssistTable th{text-align:left;background:rgba(17,26,60,0.75)}
  .aiAssistTableWrapper tr:last-child td{border-bottom:none}
  .aiBrandCell{display:flex;flex-direction:column;gap:10px}
  .aiBrandsList{display:flex;flex-direction:column;gap:10px}
  .aiBrandItem{background:#12183a;border:1px solid rgba(76,90,212,0.3);border-radius:12px;padding:10px}
  .aiBrandItemHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .aiBrandItemHeader strong{font-size:0.9rem}
  .aiRemoveBrand{background:#301424;border:1px solid #4c2138;padding:2px 8px;font-size:1.2rem;line-height:1}
  .aiRemoveBrand:hover{border-color:#a12525;box-shadow:0 0 8px rgba(220,82,120,0.55)}
  .aiNoBrands{color:var(--muted);font-size:0.85rem;font-style:italic}
  .aiBrandCell .aiBrandActions{display:flex;gap:8px;flex-wrap:wrap}
  .aiBrandCell .aiBrandActions .btn{padding:8px 12px;font-size:0.9rem}
  .btnSmall{padding:4px 8px !important;font-size:0.85rem !important}
  .aiBrandPreview{display:flex;gap:10px;flex-wrap:wrap}
  .aiBrandPreview img{width:150px;height:150px;object-fit:contain;border-radius:12px;border:1px solid rgba(76,90,212,0.35);background:#0b1020;cursor:pointer;transition:all 0.2s}
  .aiBrandPreview img:hover{border-color:rgba(76,90,212,0.7);box-shadow:0 0 12px rgba(76,90,212,0.4);transform:scale(1.02)}
  .imageModal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:10000;align-items:center;justify-content:center;padding:20px}
  .imageModal.show{display:flex}
  .imageModal img{max-width:90vw;max-height:90vh;object-fit:contain;border-radius:12px;border:2px solid rgba(76,90,212,0.5);box-shadow:0 10px 50px rgba(0,0,0,0.8)}
  .imageModal .closeModal{position:absolute;top:20px;right:20px;background:rgba(76,90,212,0.8);color:white;border:none;border-radius:50%;width:48px;height:48px;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center}
  .imageModal .closeModal:hover{background:rgba(76,90,212,1)}
  .aiIngredientList{color:var(--muted);font-size:0.85rem}
  .aiIngredientRow{display:flex;flex-direction:column;gap:12px}
  .aiIngredientMain{display:grid;grid-template-columns:1fr 2fr 2fr auto;gap:12px;align-items:start}
  .aiRowBrandResults{display:none;flex-direction:column;gap:12px;padding:16px;border:1px solid rgba(76,90,212,0.35);border-radius:16px;background:rgba(9,13,30,0.9);margin-top:8px}
  .aiRowBrandResults.show{display:flex}
  .aiAllergenChecklist{display:flex;flex-wrap:wrap;gap:8px}
  .aiAllergenChecklist label{display:flex;align-items:center;gap:6px;background:#12183a;border:1px solid rgba(76,90,212,0.3);border-radius:999px;padding:6px 10px;font-size:0.85rem}
  .aiAllergenChecklist label.aiDetected{background:rgba(34,139,34,0.15);border-color:rgba(76,175,80,0.5)}
  .aiAllergenChecklist label.aiDetected:hover{background:rgba(34,139,34,0.25);border-color:rgba(76,175,80,0.7)}
  .aiAllergenChecklist input{margin:0}
  .aiAssistTableActions{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .aiAssistTableActions .aiAssistSpacer{flex:1 1 auto}
  .aiAssistBrandResults{display:none;flex-direction:column;gap:12px;padding:16px;border:1px solid rgba(76,90,212,0.35);border-radius:16px;background:rgba(9,13,30,0.9);max-height:320px;overflow:auto}
  .aiAssistBrandResults.show{display:flex}
  .aiBrandSuggestion{border:1px solid rgba(76,90,212,0.35);border-radius:12px;padding:12px;display:flex;gap:12px;cursor:pointer;align-items:flex-start;background:#12183a}
  .aiBrandSuggestion:hover{border-color:var(--hover);box-shadow:0 0 8px #3651ff}
  .aiBrandSuggestion img{width:72px;height:72px;border-radius:10px;object-fit:cover;border:1px solid rgba(76,90,212,0.35)}
  .aiBrandSuggestion h4{margin:0;font-size:1rem}
  .aiBrandSuggestion p{margin:4px 0 0;font-size:0.85rem;color:var(--muted)}

  /* Modal (editor) */
  .modalBack{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:3000;overflow:auto;padding:20px}
  .modal{background:#0f1534;border:1px solid #2a3466;border-radius:14px;width:min(980px,96vw);max-height:82vh;overflow:auto;box-shadow:var(--shadow);position:relative}
  .modal .head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #2a3466}
  .modal .body{padding:14px}
  .modalCloseBtn{position:absolute;top:12px;right:12px;width:32px;height:32px;background:#16205a;border:2px solid #2a3466;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff;font-weight:bold;z-index:10}
  .modalCloseBtn:hover{background:#1a2660;border-color:var(--hover)}
  
  .photoCapture{display:flex;flex-direction:column;gap:12px;align-items:center;padding:20px;background:#12183a;border-radius:12px;border:1px solid #2a3466}
  .photoPreview{max-width:100%;max-height:400px;border-radius:8px;border:1px solid #2a3466}
  .videoPreview{max-width:100%;max-height:400px;border-radius:8px;border:1px solid #2a3466;background:#000}
  
  .logEntry{background:#12183a;border:1px solid #2a3466;border-radius:12px;padding:12px;margin:8px 0}
  .logEntry .logHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:8px}
  .logEntry .logTimestamp{color:var(--muted);font-size:13px}
  .logEntry .logType{padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600}
  .logType.confirm{background:#17663a;color:#fff}
  .logType.update{background:#3651ff;color:#fff}
  .logEntry .logImage{max-width:100%;border-radius:8px;margin-top:8px;cursor:pointer}
  .logEntry .logImage:hover{opacity:0.8}
  .logEntry .logThumbnail{max-width:120px;max-height:80px;object-fit:cover;border-radius:6px;margin-top:6px;cursor:pointer;border:1px solid #2a3466}
  .logEntry .logThumbnail:hover{opacity:0.85;box-shadow:0 0 8px #3651ff}
  .logAuthor{font-weight:600;margin-bottom:6px}
  .logItem{margin-top:10px;font-weight:600;color:var(--ink)}
  .logList{margin:6px 0 0 18px;padding:0;list-style:disc;color:var(--muted);font-size:13px}
  .logList li{margin:4px 0}
  
  /* Photo preview modal */
  .photoModal{position:fixed;inset:0;background:#000c;display:none;align-items:center;justify-content:center;z-index:4000;padding:20px}
  .photoModal img{max-width:90%;max-height:90%;border-radius:8px;box-shadow:0 10px 40px rgba(0,0,0,.5)}
  .photoModalClose{position:absolute;top:20px;right:20px;width:40px;height:40px;background:#16205a;border:2px solid #2a3466;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff;font-weight:bold}
  .photoModalClose:hover{background:#1a2660;border-color:var(--hover)}

  .algRow{display:grid;grid-template-columns:180px minmax(180px,300px) max-content max-content;column-gap:12px;row-gap:6px;align-items:center;margin:6px 0}
  .algBtn{padding:8px 12px;border-radius:999px;border:1px solid #2a3261;background:#12183a;cursor:pointer;text-align:center}
  .algBtn.active{background:#1a2351;box-shadow:0 0 0 3px #7c9cff33 inset;border-color:#4c5ad4}
  .algInput{background:#0c1230;color:var(--ink);border:1px solid #31407f;border-radius:8px;padding:8px 10px;width:100%}
  .algChk{display:flex;align-items:center;gap:8px;white-space:nowrap;justify-self:end}
  .saveRow{display:none}

  .editBox{position:absolute;border:2px solid var(--warn);border-radius:6px;background:transparent;cursor:move}
  .editBadge{position:absolute;top:2px;right:2px;width:18px;height:18px;background:#3651ff;border:1.5px solid #dbe2ff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;cursor:pointer;z-index:10;line-height:1}
  .editBadge:hover{background:#4e65ff;box-shadow:0 0 6px #3651ff}
  .handle{position:absolute;width:14px;height:14px;background:#3651ff;border:2px solid #dbe2ff;border-radius:4px}
  .handle.se{right:-7px;bottom:-7px;cursor:nwse-resize}
  .handle.ne{right:-7px;top:-7px;cursor:nesw-resize}
  .handle.nw{left:-7px;top:-7px;cursor:nwse-resize}
  .handle.sw{left:-7px;bottom:-7px;cursor:nesw-resize}

  /* Report inputs */
  input[type="text"], input[type="email"], textarea{
    color:var(--ink) !important; caret-color:var(--ink);
    background:#12183a; border:1px solid #2a3261; border-radius:14px; padding:12px;
  }
  input::placeholder, textarea::placeholder{color:#cfd5ff88}

  /* QR guest promo */
  .qrPromoBackdrop{
    position:fixed; inset:0; display:none;
    align-items:center; justify-content:center;
    padding:20px; background:rgba(8,12,32,.85); z-index:2500;
  }
  .qrPromoBackdrop.show{display:flex;}
  .qrPromo{
    width:min(420px,calc(100% - 40px));
    background:linear-gradient(180deg,#121a3f,#0d132a);
    border:1px solid #2a3466; border-radius:20px;
    box-shadow:0 18px 50px rgba(0,0,0,.45);
    padding:34px 64px 30px 34px; position:relative;
    display:flex; flex-direction:column; gap:14px; text-align:center;
  }
  .qrPromo h2{margin:0 0 6px;font-size:clamp(1.1rem,1rem + 1vw,1.6rem);}
  .qrPromo p{margin:0;color:var(--muted);font-size:0.95rem;line-height:1.5;}
  .qrPromoClose{
    position:absolute; top:12px; right:12px;
    width:44px; height:44px;
    border:1px solid #2a3466; background:#16205a;
    border-radius:8px; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    font-size:24px; color:#fff; line-height:1;
    touch-action:manipulation;
    z-index:10;
  }
  .qrPromoClose:hover{border-color:var(--hover); box-shadow:0 0 8px #3651ff;}
  .qrPromoClose:active{background:#1e2870;}
  .qrBanner{
    position:fixed; left:0; right:0; top:0; z-index:2200;
    background:linear-gradient(180deg,#0f1534,#0b1020);
    border-bottom:1px solid #2a3466; padding:16px 20px;
    display:none; gap:16px; align-items:center; justify-content:center; flex-wrap:wrap;
    box-shadow:0 4px 20px rgba(0,0,0,.4);
    text-align:center;
  }
  .qrBanner.show{display:flex;}
  body.qrBannerVisible .wrap{padding-top:80px;}
  body.qrBannerVisible .topbar{top:80px;}
  body.qrMode .topbar{border-bottom:none; box-shadow:none;}
  body.qrMode .topin{padding:32px 18px;gap:24px;}
  @media (max-width:640px){
    .topin{gap:12px;padding:16px 14px 12px}
    .brand{gap:12px}
    .brand img{width:40px;height:40px}
    .tabs{gap:6px}
    .tab{padding:6px 10px;font-size:13px}
    .acctBtn{padding:6px 10px;font-size:13px}
    .content{padding:10px;padding-bottom:160px}
    .legend{gap:10px}
    h1{font-size:1.3rem;margin:4px 0 10px}
    .cards{gap:12px}
    .card{width:calc(100% - 20px);max-width:400px}
    .card img{height:140px}
    .card .pad{padding:10px}
    .card .pad > div:first-child{font-size:16px;margin-bottom:4px}
    .note{font-size:12px}
    .btn{padding:8px 12px;font-size:13px}
    .ovBadge,.ovWarning{top:1px;width:6px;height:6px;border:0.5px solid;font-size:5px}
    .ovBadge{right:1px;border-color:#dbe2ff}
    .ovWarning{left:1px;border-color:#fef08a}
    .ovBadge:hover{box-shadow:0 0 4px #3651ff}
    .ovWarning:hover{box-shadow:0 0 4px #facc15}
    .banner{flex-direction:column;align-items:stretch}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar"><div class="topin" id="topbar"></div></div>
  <div class="content" id="root"></div>
</div>

<div class="tip" id="tip"></div>

<div class="modalBack" id="modalBack">
  <div class="modal">
    <button class="modalCloseBtn" id="modalCloseBtn" type="button">×</button>
    <div class="head"><div id="modalTitle">Edit item</div></div>
    <div class="body" id="modalBody"></div>
  </div>
</div>

<div class="photoModal" id="photoModal">
  <div class="photoModalClose" id="photoModalClose">×</div>
  <img id="photoModalImage" src="" alt="Confirmation photo">
</div>

<div class="qrPromoBackdrop" id="qrPromoBackdrop" aria-hidden="true">
  <div class="qrPromo" role="dialog" aria-labelledby="qrPromoTitle" aria-modal="true">
    <button class="qrPromoClose" id="qrPromoClose" type="button" aria-label="Close promotion">×</button>
    <h2 id="qrPromoTitle">See allergy-safe spots all over CLE</h2>
    <p>Save your allergens once and unlock curated menus at restaurants across the city.</p>
    <p>Creating an account takes less than a minute and is completely free.</p>
    <button class="btn btnPrimary" id="qrPromoSignup" type="button">Create free account</button>
  </div>
</div>
<div class="qrBanner" id="qrBanner" aria-hidden="true">
  <div><strong>Keep exploring safely.</strong> Create a free account to save your allergens and see compatible dishes everywhere.</div>
  <button class="btn btnPrimary" id="qrBannerSignup" type="button">Create free account</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script type="module">
// Initialize Supabase
const SUPABASE_URL = 'https://fgoiyycctnwnghrvsilt.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZnb2l5eWNjdG53bmdocnZzaWx0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MzY1MjYsImV4cCI6MjA3NjAxMjUyNn0.xlSSXr0Gl7j-vsckrj-2anpPmp4BG2SUIdN-_dquSA8';
const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
window.supabaseClient = supabaseClient;

// Get slug from URL
const urlParams = new URLSearchParams(window.location.search);
const slug = urlParams.get('slug');
const qrParam = urlParams.get('qr');
const isQrVisit = qrParam ? /^(1|true|yes)$/i.test(qrParam) : false;
window.__qrVisit = isQrVisit;

if (!slug) {
  document.body.innerHTML = '<div style="color: #ef4444; text-align: center; padding: 40px;">Error: No restaurant specified</div>';
} else {
  // Fetch restaurant data
  async function loadRestaurant() {
    const { data: restaurant, error } = await supabaseClient
      .from('restaurants')
      .select('*')
      .eq('slug', slug)
      .single();

    if (error) {
      console.error('Error loading restaurant:', error);
      document.body.innerHTML = '<div style="color: #ef4444; text-align: center; padding: 40px;">Error loading restaurant</div>';
      return;
    }

    if (!restaurant) {
      document.body.innerHTML = '<div style="color: #ef4444; text-align: center; padding: 40px;">Restaurant not found</div>';
      return;
    }

    // Get current user
    const { data: { user } } = await supabaseClient.auth.getUser();

    // Get user allergies if logged in
    let allergies = [];
    let canEdit = false;
    if (user) {
      const { data: record } = await supabaseClient
        .from('user_allergies')
        .select('allergens')
        .eq('user_id', user.id)
        .maybeSingle();
      allergies = record?.allergens || [];

      const { data: managerRecord, error: managerError } = await supabaseClient
        .from('restaurant_managers')
        .select('id')
        .eq('user_id', user.id)
        .eq('restaurant_id', restaurant.id)
        .maybeSingle();
      if(managerError){
        console.error('Manager lookup failed', managerError);
      }
      console.log('Manager row:', managerRecord, 'error:', managerError);
      canEdit = !!managerRecord;
    }

    // Transform restaurant data to match expected format
    const restaurantData = normalizeRestaurant(restaurant);

    // Send data to the embedded page script
    window.postMessage({
      page: 'restaurant',
      restaurant: restaurantData,
      user: user ? { loggedIn: true, email: user.email, id: user.id, name: user.user_metadata?.first_name || null } : { loggedIn: false },
      allergies: allergies,
      canEdit: canEdit,
      canEditSource: canEdit ? 'manager-row' : 'none',
      qr: isQrVisit
    }, '*');
  }

  loadRestaurant();
}
</script>

<script>
// Ensure zoom is always allowed on mobile Safari
(function () {
  var m = document.querySelector('meta[name="viewport"]');
  if (m && !/maximum-scale/i.test(m.content)) {
    m.content += ', user-scalable=yes, maximum-scale=10';
  }
  ['touchstart','touchmove'].forEach(function (t) {
    document.addEventListener(t, function () {}, {passive:true});
  });
})();
document.body.style.display='none';

const ALLERGENS=["dairy","egg","peanut","tree nut","shellfish","fish","gluten","soy","sesame","wheat"];
const ALLERGEN_ALIASES={
  milk:'dairy',
  lactose:'dairy',
  butter:'dairy',
  eggs:'egg',
  egg:'egg',
  peanuts:'peanut',
  peanut:'peanut',
  treenut:'tree nut',
  "tree nut":"tree nut",
  "tree nuts":"tree nut",
  almond:'tree nut',
  cashew:'tree nut',
  walnut:'tree nut',
  shellfish:'shellfish',
  crustaceans:'shellfish',
  crustacean:'shellfish',
  molluscs:'shellfish',
  fish:'fish',
  salmon:'fish',
  tuna:'fish',
  gluten:'gluten',
  wheat:'wheat',
  soy:'soy',
  soya:'soy',
  sesame:'sesame'
};

function detectAllergensInText(text){
  if(!text) return [];
  const lower=text.toLowerCase();
  const found=new Set();
  Object.entries(ALLERGEN_ALIASES).forEach(([alias,target])=>{
    if(lower.includes(alias)) found.add(target);
  });
  ALLERGENS.forEach(a=>{ if(lower.includes(a)) found.add(a); });
  return [...found];
}
const state={page:null,restaurants:[],restaurant:null,allergies:[],ack:false,user:{loggedIn:false},canEdit:false,qr:false,_hydrated:false,aiAssistEndpoint:null};
let mobileInfoPanel=null;
let currentMobileInfoItem=null;
let mobileViewerChrome=null;
let mobileZoomLevel=1;
let mobileViewerKeyHandler=null;

function ensureMobileInfoPanel(){
  if(mobileInfoPanel && mobileInfoPanel.isConnected) return mobileInfoPanel;
  if(!mobileInfoPanel){
    mobileInfoPanel=document.createElement('div');
    mobileInfoPanel.id='mobileInfoPanel';
    mobileInfoPanel.className='mobileInfoPanel';
    mobileInfoPanel.setAttribute('aria-live','polite');
    mobileInfoPanel.style.position='fixed';
    mobileInfoPanel.style.left='0';
    mobileInfoPanel.style.right='0';
    mobileInfoPanel.style.bottom='0';
    mobileInfoPanel.style.width='100%';
    mobileInfoPanel.style.zIndex='3500';
    mobileInfoPanel.style.background='rgba(11,16,32,0.94)';
    mobileInfoPanel.style.backdropFilter='blur(14px)';
    mobileInfoPanel.style.webkitBackdropFilter='blur(14px)';
    mobileInfoPanel.style.paddingBottom='calc(24px + env(safe-area-inset-bottom,0))';
  }
  mobileInfoPanel.innerHTML='';
  mobileInfoPanel.classList.remove('show');
  document.body.appendChild(mobileInfoPanel);
  adjustMobileInfoPanelForZoom();
  return mobileInfoPanel;
}

function adjustMobileInfoPanelForZoom(){
  // No longer needed since pinch-to-zoom is disabled
  // Keeping function for compatibility
}

function getMenuState(){
  if(!window.__menuState) window.__menuState={};
  return window.__menuState;
}

function captureMenuBaseDimensions(force=false){
  const state=getMenuState();
  const img=state?.img;
  if(!img) return;
  if(force || !state.baseWidth){
    state.baseWidth = img.clientWidth || img.naturalWidth || img.width || 0;
    state.baseHeight = img.clientHeight || img.naturalHeight || img.height || 0;
  }
}

function ensureMobileViewerChrome(){
  if(mobileViewerChrome && mobileViewerChrome.isConnected) return mobileViewerChrome;
  let chrome=document.getElementById('mobileViewerChrome');
  if(!chrome){
    chrome=document.createElement('div');
    chrome.id='mobileViewerChrome';
    chrome.innerHTML=`
      <div class="chromeTop">
        <button type="button" class="mobileViewerControlBtn" id="mobileViewerCloseBtn">Close</button>
        <div class="mobileViewerSummary" id="mobileViewerAllergySummary" aria-live="polite"></div>
        <div class="mobileZoomGroup">
          <button type="button" id="mobileZoomOutBtn" aria-label="Zoom out">−</button>
          <span id="mobileZoomValue">100%</span>
          <button type="button" id="mobileZoomInBtn" aria-label="Zoom in">+</button>
        </div>
      </div>`;
    document.body.appendChild(chrome);
  }
  if(!chrome.style.display) chrome.style.display='none';
  if(!chrome.hasAttribute('aria-hidden')) chrome.setAttribute('aria-hidden','true');
  mobileViewerChrome=chrome;
  const closeBtn=chrome.querySelector('#mobileViewerCloseBtn');
  const zoomOutBtn=chrome.querySelector('#mobileZoomOutBtn');
  const zoomInBtn=chrome.querySelector('#mobileZoomInBtn');
  if(closeBtn) closeBtn.onclick=()=>closeMobileViewer();
  if(zoomOutBtn) zoomOutBtn.onclick=()=>setMobileZoom(mobileZoomLevel-0.25);
  if(zoomInBtn) zoomInBtn.onclick=()=>setMobileZoom(mobileZoomLevel+0.25);
  updateFullScreenAllergySummary();
  return mobileViewerChrome;
}

function updateZoomIndicator(){
  const indicator=document.getElementById('mobileZoomValue');
  if(indicator) indicator.textContent=`${Math.round(mobileZoomLevel*100)}%`;
}

function updateFullScreenAllergySummary(){
  const summary=document.getElementById('mobileViewerAllergySummary');
  if(!summary) return;
  const uniqueKeys=Array.from(new Set((state.allergies||[]).map(norm))).filter(Boolean);
  const selected=uniqueKeys.map(cap);
  if(selected.length){
    summary.innerHTML=`<div class="mobileViewerSummaryInner"><span class="label">Selected:</span><span class="values">${selected.map(esc).join(', ')}</span></div>`;
  } else {
    summary.innerHTML=`<div class="mobileViewerSummaryInner"><span class="values">No allergens selected</span></div>`;
  }
}

function setMobileZoom(level, resetBase=false){
  const state=getMenuState();
  const img=state?.img;
  if(!img) return;
  if(resetBase){
    state.baseWidth=null;
    state.baseHeight=null;
  }
  captureMenuBaseDimensions(resetBase);
  if(!state.baseWidth){
    updateZoomIndicator();
    return;
  }
  mobileZoomLevel=Math.min(Math.max(level,1),4);
  const width=state.baseWidth*mobileZoomLevel;
  const inner=state.inner;
  const layer=state.layer;
  img.style.width=width+'px';
  if(inner) inner.style.width=width+'px';
  if(layer) layer.style.width=width+'px';
  requestAnimationFrame(()=>{
    if(window.__rerenderLayer__) window.__rerenderLayer__();
    updateZoomIndicator();
  });
}

function resetMobileZoom(){
  const state=getMenuState();
  mobileZoomLevel=1;
  const img=state?.img;
  if(img){
    img.style.width='';
    if(state.inner) state.inner.style.width='';
    if(state.layer) state.layer.style.width='';
  }
  requestAnimationFrame(()=>{
    if(window.__rerenderLayer__) window.__rerenderLayer__();
    captureMenuBaseDimensions(true);
    updateZoomIndicator();
  });
}

function openMobileViewer(){
  const chrome=ensureMobileViewerChrome();
  if(chrome){
    chrome.style.display='block';
    chrome.setAttribute('aria-hidden','false');
  }
  captureMenuBaseDimensions(true);
  document.body.classList.add('mobileViewerActive');
  updateFullScreenAllergySummary();
  setMobileZoom(1,true);
  if(prefersMobileInfo()){
    if(currentMobileInfoItem){
      renderMobileInfo(currentMobileInfoItem);
    } else {
      renderMobileInfo(null);
    }
  }
  const wrap=document.getElementById('menu');
  if(wrap){
    wrap.scrollTop=0;
  }
  const closeBtn=document.getElementById('mobileViewerCloseBtn');
  if(closeBtn){
    setTimeout(()=>closeBtn.focus(),150);
  }
  if(!mobileViewerKeyHandler){
    mobileViewerKeyHandler=(e)=>{
      if(e.key==='Escape'){
        e.preventDefault();
        closeMobileViewer();
      }
    };
    document.addEventListener('keydown',mobileViewerKeyHandler);
  }
}

function closeMobileViewer(){
  document.body.classList.remove('mobileViewerActive');
  if(mobileViewerChrome){
    mobileViewerChrome.style.display='none';
    mobileViewerChrome.setAttribute('aria-hidden','true');
  }
  resetMobileZoom();
  if(prefersMobileInfo()){
    if(currentMobileInfoItem){
      renderMobileInfo(currentMobileInfoItem);
    } else {
      renderMobileInfo(null);
    }
  }
  const openBtn=document.querySelector('#mobileMenuNotice .mobileMenuOpenBtn');
  if(openBtn){
    setTimeout(()=>openBtn.focus(),150);
  }
  const notice=document.getElementById('mobileMenuNotice');
  if(notice && notice.dataset.enabled==='1'){
    notice.style.display='flex';
    notice.setAttribute('aria-hidden','false');
  }
  if(mobileViewerKeyHandler){
    document.removeEventListener('keydown',mobileViewerKeyHandler);
    mobileViewerKeyHandler=null;
  }
}

const urlQR=typeof window.__qrVisit==='boolean'
  ? window.__qrVisit
  : (()=>{const v=new URLSearchParams(location.search).get('qr'); return v && /^(1|true|yes)$/i.test(v);})();

const QR_PROMO_STORAGE_KEY='qrPromoDismissed';
function shouldShowQrPromo(){
  try{return !sessionStorage.getItem(QR_PROMO_STORAGE_KEY);}catch(_){return true;}
}
function dismissQrPromo(){
  try{sessionStorage.setItem(QR_PROMO_STORAGE_KEY,'1');}catch(_){}
}
function shouldShowQrBanner(){
  return !state.user?.loggedIn;
}
function showQrBanner(){
  const banner=document.getElementById('qrBanner');
  if(!banner) return;
  if(!shouldShowQrBanner()) return;
  banner.classList.add('show');
  banner.setAttribute('aria-hidden','false');
  document.body.classList.add('qrBannerVisible');
}
function hideQrBanner(){
  const banner=document.getElementById('qrBanner');
  if(!banner) return;
  banner.classList.remove('show');
  banner.setAttribute('aria-hidden','true');
  document.body.classList.remove('qrBannerVisible');
}
let qrPromoTimerId=null;
function cancelQrPromoTimer(){
  if(qrPromoTimerId){clearTimeout(qrPromoTimerId);qrPromoTimerId=null;}
}
function queueQrPromoTimer(){
  cancelQrPromoTimer();
  qrPromoTimerId=setTimeout(()=>{
    qrPromoTimerId=null;
    if(!state.user?.loggedIn && shouldShowQrPromo()){
      openQrPromo();
    }
  },10000);
}
function openQrPromo(){
  const backdrop=document.getElementById('qrPromoBackdrop');
  if(!backdrop || backdrop.classList.contains('show')) return;
  hideQrBanner();
  backdrop.classList.add('show');
  backdrop.setAttribute('aria-hidden','false');
}
function closeQrPromo(reason='dismiss'){
  const backdrop=document.getElementById('qrPromoBackdrop');
  if(backdrop && backdrop.classList.contains('show')){
    backdrop.classList.remove('show');
    backdrop.setAttribute('aria-hidden','true');
  }
  if(reason!=='login') dismissQrPromo();
  cancelQrPromoTimer();
  if(reason==='dismiss' && shouldShowQrBanner()){
    showQrBanner();
  }
  if(reason==='signup' || reason==='login'){
    hideQrBanner();
  }
}

// Handle navigation in standalone mode
const isStandalone = (window === window.parent);
const send=(p)=>{
  if (isStandalone) {
    // Handle navigation directly in standalone mode
    if (p.type === 'navigate') {
      if (p.to === '/restaurants') window.location.href = 'restaurants.html';
      else if (p.to === '/favorites') window.location.href = 'favorites.html';
      else if (p.to === '/report-issue') window.location.href = 'report-issue.html';
      else if (p.to === '/accounts') {
        const params=new URLSearchParams();
        if(p.slug) params.set('returnSlug',p.slug);
        if(p.redirect) params.set('redirect',p.redirect);
        const url='account.html'+(params.toString()?`?${params.toString()}`:'');
        window.location.href=url;
      }
      else window.location.href = p.to;
    } else if (p.type === 'signIn') {
      const params=new URLSearchParams();
      if(p.slug) params.set('returnSlug',p.slug);
      if(p.redirect) params.set('redirect',p.redirect);
      const url='account.html'+(params.toString()?`?${params.toString()}`:'');
      window.location.href = url;
    } else if (p.type === 'openRestaurant') {
      window.location.href = `restaurant.html?slug=${p.slug}`;
    } else if (p.type === 'saveOverlays') {
      (async ()=>{
        try{
          const client = window.supabaseClient;
          if(!client) throw new Error('Supabase client not ready.');
          const restaurantId = state.restaurant?._id || state.restaurant?.id || null;
          if(!restaurantId) throw new Error('Restaurant not loaded yet.');
          const payload = { overlays: p.overlays || [] };
          if (p.menuImage) payload.menu_image = p.menuImage;
          const { data, error } = await client
            .from('restaurants')
            .update(payload)
            .eq('id', restaurantId)
            .select()
            .single();
          if(error) throw error;
          const updatedRestaurant = normalizeRestaurant(data);
          window.postMessage({type:'overlaysSaved', restaurant: updatedRestaurant}, '*');

          const rawChangePayload=p.changes;
          let changePayload=null;
          if(rawChangePayload && typeof rawChangePayload==='object' && !Array.isArray(rawChangePayload)){
            changePayload=rawChangePayload;
          } else if(typeof rawChangePayload==='string'){
            try{ changePayload=JSON.parse(rawChangePayload); }
            catch(_){ changePayload=null; }
          }

          let authorName='Manager';
          if(state.user?.name){
            authorName=state.user.name;
          } else if(state.user?.user_metadata?.first_name || state.user?.user_metadata?.last_name){
            const first=state.user.user_metadata.first_name || '';
            const last=state.user.user_metadata.last_name || '';
            authorName=`${first} ${last}`.trim();
          } else if(state.user?.email){
            authorName=state.user.email.split('@')[0];
          }

          if(changePayload && changePayload.author){
            authorName=changePayload.author;
          }

          const storedChanges=changePayload
            ? JSON.stringify(changePayload)
            : (typeof rawChangePayload==='string' ? rawChangePayload : 'Menu overlays updated.');

          try{
            await insertChangeLogEntry({
              restaurantId,
              timestamp: new Date().toISOString(),
              type: 'update',
              description: authorName,
              changes: storedChanges,
              userEmail: state.user?.email || null
            });
          }catch(logError){
            console.error('Change log insert failed', logError);
          }
        }catch(err){
          console.error('Saving overlays failed', err);
          window.postMessage({type:'saveFailed', message: err.message}, '*');
        }
      })();
      return;
    } else if (p.type === 'confirmAllergens') {
      (async ()=>{
        try{
          const client = window.supabaseClient;
          if(!client) throw new Error('Supabase client not ready.');
          const restaurantId = state.restaurant?._id || state.restaurant?.id || null;
          if(!restaurantId) throw new Error('Restaurant not loaded yet.');
          const timestamp = p.timestamp || new Date().toISOString();

          const { data: updated, error } = await client
            .from('restaurants')
            .update({ last_confirmed: timestamp })
            .eq('id', restaurantId)
            .select()
            .single();
          if(error) throw error;

      try{
        let userName = 'Manager';
        if(state.user?.name) {
          userName = state.user.name;
        } else if(state.user?.user_metadata?.first_name || state.user?.user_metadata?.last_name) {
          const first = state.user.user_metadata.first_name || '';
          const last = state.user.user_metadata.last_name || '';
          userName = `${first} ${last}`.trim();
        } else if(state.user?.email) {
          userName = state.user.email.split('@')[0];
        }
        const confirmPayload={
          author:userName,
          general:['Allergen information confirmed'],
          items:{}
        };
        await insertChangeLogEntry({
          restaurantId,
          timestamp,
          type: 'confirm',
          description: userName,
          changes: JSON.stringify(confirmPayload),
          userEmail: state.user?.email || null,
          photos: p.photos || (p.photo ? [p.photo] : [])
        });
      }catch(logError){
        console.error('Change log insert failed', logError);
      }

          window.postMessage({type:'confirmationSaved', restaurant: normalizeRestaurant(updated), timestamp}, '*');
        }catch(err){
          console.error('Confirmation failed', err);
          window.postMessage({type:'confirmationFailed', message: err.message}, '*');
        }
      })();
      return;
    } else if (p.type === 'getChangeLog') {
      (async ()=>{
        try{
          const logs = await fetchChangeLogEntries(p.restaurantId || state.restaurant?._id || state.restaurant?.id || null);
          window.postMessage({type:'changeLog', logs:logs || []}, '*');
        }catch(err){
          console.error('Loading change log failed', err);
          window.postMessage({type:'changeLog', logs:[], error: err.message}, '*');
        }
      })();
      return;
    }
    // For other message types, just log them in standalone mode
    console.log('Message sent:', p);
  } else {
    // In iframe mode, use postMessage
    parent.postMessage(p,"*");
  }
};
function requestSignIn(origin){
  const slugParam=(state.restaurant && state.restaurant.slug) || slug || '';
  const payload={type:'signIn'};
  if(slugParam) payload.slug=slugParam;
  if(origin==='restaurants') payload.redirect='restaurants';
  if(origin==='qr') payload.from='qr';
  send(payload);
}
const qrPromoBackdrop=document.getElementById('qrPromoBackdrop');
const qrPromoCloseBtn=document.getElementById('qrPromoClose');
const qrPromoSignupBtn=document.getElementById('qrPromoSignup');
const qrBanner=document.getElementById('qrBanner');
const qrBannerSignupBtn=document.getElementById('qrBannerSignup');

if(qrPromoBackdrop){
  qrPromoBackdrop.addEventListener('click',(e)=>{if(e.target===qrPromoBackdrop) closeQrPromo('dismiss');});
}
if(qrPromoCloseBtn){
  qrPromoCloseBtn.onclick=()=>closeQrPromo('dismiss');
}
if(qrPromoSignupBtn){
  qrPromoSignupBtn.onclick=()=>{closeQrPromo('signup'); requestSignIn('qr');};
}
if(qrBannerSignupBtn){
  qrBannerSignupBtn.onclick=()=>{hideQrBanner(); requestSignIn('qr');};
}
const norm=s=>(s||'').toString().trim().toLowerCase();
const esc=s=>(s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const cap=s=>(s||'').split(' ').map(w=>w? w[0].toUpperCase()+w.slice(1):'').join(' ');
const fmtDate=d=>{try{const x=new Date(d);return isNaN(x)?'':x.toLocaleDateString();}catch(_){return '';}};
const fmtDateTime=d=>{try{const x=new Date(d);return isNaN(x)?'':x.toLocaleDateString()+' at '+x.toLocaleTimeString();}catch(_){return '';}};

let aiAssistBackdrop=null;
let aiAssistPanel=null;
let aiAssistCloseBtn=null;
let aiAssistInput=null;
let aiAssistDictateBtn=null;
let aiAssistProcessBtn=null;
let aiAssistStatusEl=null;
let aiAssistResultsEl=null;
let aiAssistTableBody=null;
let aiAssistAddRowBtn=null;
let aiAssistApplyBtn=null;
let aiAssistBrandResults=null;
let aiAssistUploadBtn=null;
let aiAssistCameraBtn=null;
let aiAssistFileInput=null;
let aiAssistImagePreview=null;
let aiAssistVideo=null;
let aiAssistCaptureBtn=null;
let aiAssistCancelCameraBtn=null;
let aiAssistClearImageBtn=null;
let aiAssistMediaPreview=null;
let aiAssistElementsBound=false;

const aiAssistState={
  context:null,
  recognition:null,
  listening:false,
  pendingRequestId:null,
  brandSuggestions:{},
  imageData:null,
  imageFileName:null,
  mediaStream:null,
};

const AI_BRAND_LIMIT=6;
const AI_BRAND_MEMORY_KEY='cle:aiBrandMemory:v1';

let aiBrandMemoryCache=null;

function loadAiBrandMemory(){
  if(aiBrandMemoryCache) return aiBrandMemoryCache;
  try{
    const raw=localStorage.getItem(AI_BRAND_MEMORY_KEY);
    aiBrandMemoryCache=raw?JSON.parse(raw):{};
  }catch(_){
    aiBrandMemoryCache={};
  }
  return aiBrandMemoryCache;
}

function persistAiBrandMemory(){
  try{
    localStorage.setItem(AI_BRAND_MEMORY_KEY,JSON.stringify(aiBrandMemoryCache||{}));
  }catch(_){ }
}

function normalizeIngredientKey(name){
  return norm(name||'').replace(/[^a-z0-9]+/g,' ').trim();
}

function rememberBrand(name,data={}){
  const key=normalizeIngredientKey(name);
  if(!key) return;
  const store=loadAiBrandMemory();
  const brand=(data.brand||'').trim();
  if(!brand){
    delete store[key];
    persistAiBrandMemory();
    return;
  }
  store[key]={
    brand,
    brandImage:data.brandImage||'',
    ingredientsImage:data.ingredientsImage||'',
    ingredientsList:Array.isArray(data.ingredientsList)?data.ingredientsList.slice():[],
    allergens:Array.isArray(data.allergens)?data.allergens.slice():[],
  };
  persistAiBrandMemory();
}

function forgetBrand(name){
  const key=normalizeIngredientKey(name);
  if(!key) return;
  const store=loadAiBrandMemory();
  if(store[key]){
    delete store[key];
    persistAiBrandMemory();
  }
}

function getRememberedBrand(name){
  const key=normalizeIngredientKey(name);
  if(!key) return null;
  const store=loadAiBrandMemory();
  return store[key]||null;
}

function fillRowFromMemory(rowElement,force){
  if(!rowElement) return;
  const nameInput=rowElement.querySelector('.aiIngredientName');
  const brandInput=rowElement.querySelector('.aiIngredientBrand');
  const name=(nameInput?.value||'').trim();
  if(!name) return;
  const memory=getRememberedBrand(name);
  if(!memory) return;
  if(brandInput && (force || !(brandInput.value||'').trim()) && memory.brand){
    brandInput.value=memory.brand;
  }
  if(memory.brandImage){
    rowElement.dataset.brandImage=memory.brandImage;
  }
  if(memory.ingredientsImage){
    rowElement.dataset.ingredientsImage=memory.ingredientsImage;
  }
  if(memory.ingredientsList && memory.ingredientsList.length){
    rowElement.dataset.ingredientsList=JSON.stringify(memory.ingredientsList);
  }
  if(memory.allergens && memory.allergens.length){
    const allergenSet=new Set(memory.allergens.map(norm));
    rowElement.querySelectorAll('.aiAllergenChecklist input').forEach(input=>{
      if(allergenSet.has(norm(input.value))) input.checked=true;
    });
  }
  updateAiBrandPreview(rowElement);
}

function aiAssistSetStatus(message='', tone='info'){
  if(!aiAssistStatusEl) return;
  aiAssistStatusEl.textContent=message;
  if(message){
    aiAssistStatusEl.setAttribute('data-tone',tone);
  } else {
    aiAssistStatusEl.removeAttribute('data-tone');
  }
}

function ensureAiAssistElements(){
  if(aiAssistBackdrop && aiAssistBackdrop.isConnected) return;
  if(aiAssistBackdrop && !aiAssistBackdrop.isConnected){
    aiAssistBackdrop=null;
    aiAssistPanel=null;
    aiAssistCloseBtn=null;
    aiAssistInput=null;
    aiAssistDictateBtn=null;
    aiAssistProcessBtn=null;
    aiAssistStatusEl=null;
    aiAssistResultsEl=null;
    aiAssistTableBody=null;
    aiAssistAddRowBtn=null;
    aiAssistApplyBtn=null;
    aiAssistBrandResults=null;
    aiAssistUploadBtn=null;
    aiAssistCameraBtn=null;
    aiAssistFileInput=null;
    aiAssistImagePreview=null;
    aiAssistVideo=null;
    aiAssistCaptureBtn=null;
    aiAssistCancelCameraBtn=null;
    aiAssistClearImageBtn=null;
    aiAssistMediaPreview=null;
    aiAssistElementsBound=false;
  }
  if(!aiAssistBackdrop){
    const backdrop=document.createElement('div');
    backdrop.className='aiAssistBackdrop';
    backdrop.id='aiAssistBackdrop';
    backdrop.setAttribute('aria-hidden','true');
    backdrop.innerHTML=`
      <div class="aiAssistPanel" id="aiAssistPanel" role="dialog" aria-modal="true" aria-labelledby="aiAssistTitle">
        <div class="aiAssistHead">
          <h2 id="aiAssistTitle">AI Ingredient Assistant</h2>
          <button type="button" class="aiAssistClose" id="aiAssistClose" aria-label="Close AI assistant">×</button>
        </div>
        <p class="aiAssistIntro">Describe how the dish is prepared or list its ingredients. The assistant will suggest ingredients, brands, and likely allergens.</p>
        <textarea id="aiAssistInput" class="aiAssistInput" placeholder="Example: Grilled chicken marinated in yogurt, lemon juice, garlic, served with toasted pita and tahini sauce."></textarea>
        <div class="aiAssistControls">
          <button type="button" class="btn" id="aiAssistDictateBtn">🎙 Dictate</button>
          <button type="button" class="btn btnPrimary" id="aiAssistProcessBtn">Process text</button>
          <span class="aiAssistStatus" id="aiAssistStatus"></span>
        </div>
        <div class="aiAssistMedia" id="aiAssistMedia">
          <button type="button" class="btn" id="aiAssistUploadRecipeBtn">📁 Upload recipe photo</button>
          <button type="button" class="btn" id="aiAssistCameraRecipeBtn">📷 Take recipe photo</button>
          <input type="file" id="aiAssistRecipeFileInput" class="aiAssistHidden" accept="image/*">
        </div>
        <div class="aiAssistMediaPreview" id="aiAssistMediaPreview">
          <video id="aiAssistVideo" class="aiAssistHidden" playsinline muted></video>
          <img id="aiAssistImagePreview" class="aiAssistHidden" alt="Ingredient label preview">
          <div class="aiAssistPhotoControls">
            <button type="button" class="btn" id="aiAssistCaptureBtn">Capture photo</button>
            <button type="button" class="btn" id="aiAssistCancelCameraBtn">Cancel camera</button>
            <button type="button" class="btn" id="aiAssistClearImageBtn">Clear image</button>
          </div>
        </div>
        <div class="aiAssistResults" id="aiAssistResults" aria-live="polite">
          <h3 style="margin:0">Ingredients</h3>
          <div class="aiAssistTableWrapper">
            <table id="aiAssistTable">
              <thead>
                <tr>
                  <th style="width:24%">Ingredient</th>
                  <th style="width:32%">Brand</th>
                  <th>Allergens</th>
                  <th style="width:60px">Actions</th>
                </tr>
              </thead>
              <tbody id="aiAssistTableBody"></tbody>
            </table>
          </div>
          <div class="aiAssistTableActions">
            <button type="button" class="btn" id="aiAssistAddRowBtn">Add ingredient</button>
            <div class="aiAssistSpacer"></div>
            <button type="button" class="btn btnPrimary" id="aiAssistApplyBtn">Apply to dish</button>
          </div>
          <div class="aiAssistBrandResults" id="aiAssistBrandResults" aria-live="polite"></div>
        </div>
      </div>`;
    document.body.appendChild(backdrop);
    aiAssistBackdrop=backdrop;
    aiAssistPanel=backdrop.querySelector('#aiAssistPanel');

    // Create image modal
    if(!document.getElementById('imageModal')){
      const modal=document.createElement('div');
      modal.id='imageModal';
      modal.className='imageModal';
      modal.innerHTML=`
        <button type="button" class="closeModal" onclick="closeImageModal()" aria-label="Close">×</button>
        <img id="imageModalImg" src="" alt="Full size image">
      `;
      modal.addEventListener('click',(e)=>{
        if(e.target.classList.contains('imageModal')){
          closeImageModal();
        }
      });
      document.body.appendChild(modal);
    }
    aiAssistCloseBtn=backdrop.querySelector('#aiAssistClose');
    aiAssistInput=backdrop.querySelector('#aiAssistInput');
    aiAssistDictateBtn=backdrop.querySelector('#aiAssistDictateBtn');
    aiAssistProcessBtn=backdrop.querySelector('#aiAssistProcessBtn');
    aiAssistStatusEl=backdrop.querySelector('#aiAssistStatus');
    aiAssistResultsEl=backdrop.querySelector('#aiAssistResults');
    aiAssistTableBody=backdrop.querySelector('#aiAssistTableBody');
    aiAssistAddRowBtn=backdrop.querySelector('#aiAssistAddRowBtn');
    aiAssistApplyBtn=backdrop.querySelector('#aiAssistApplyBtn');
    aiAssistBrandResults=backdrop.querySelector('#aiAssistBrandResults');
    aiAssistUploadBtn=backdrop.querySelector('#aiAssistUploadBtn');
    aiAssistCameraBtn=backdrop.querySelector('#aiAssistCameraBtn');
    aiAssistFileInput=backdrop.querySelector('#aiAssistFileInput');
    aiAssistImagePreview=backdrop.querySelector('#aiAssistImagePreview');
    aiAssistVideo=backdrop.querySelector('#aiAssistVideo');
    aiAssistCaptureBtn=backdrop.querySelector('#aiAssistCaptureBtn');
    aiAssistCancelCameraBtn=backdrop.querySelector('#aiAssistCancelCameraBtn');
    aiAssistClearImageBtn=backdrop.querySelector('#aiAssistClearImageBtn');
    aiAssistMediaPreview=backdrop.querySelector('#aiAssistMediaPreview');
    aiAssistElementsBound=false;
  }
  if(!aiAssistElementsBound){
    aiAssistBackdrop.addEventListener('click',(event)=>{
      if(event.target===aiAssistBackdrop) closeAiAssistant();
    });
    aiAssistCloseBtn.addEventListener('click',()=>closeAiAssistant());
    aiAssistDictateBtn.addEventListener('click',()=>toggleAiDictation());
    aiAssistProcessBtn.addEventListener('click',()=>handleAiProcess());

    // Recipe photo upload/camera handlers
    const uploadRecipeBtn = aiAssistBackdrop.querySelector('#aiAssistUploadRecipeBtn');
    const cameraRecipeBtn = aiAssistBackdrop.querySelector('#aiAssistCameraRecipeBtn');
    const recipeFileInput = aiAssistBackdrop.querySelector('#aiAssistRecipeFileInput');

    if(uploadRecipeBtn && recipeFileInput){
      uploadRecipeBtn.addEventListener('click',()=>{
        recipeFileInput.value='';
        recipeFileInput.click();
      });
      recipeFileInput.addEventListener('change',()=>{
        const file=recipeFileInput.files && recipeFileInput.files[0];
        if(file) handleRecipePhotoUpload(file);
      });
    }
    if(cameraRecipeBtn){
      cameraRecipeBtn.addEventListener('click',()=>handleRecipePhotoCamera());
    }

    aiAssistAddRowBtn.addEventListener('click',()=>{
      const data=collectAiTableData();
      data.push({name:'',brand:'',allergens:[]});
      renderAiTable(data);
    });
    aiAssistApplyBtn.addEventListener('click',()=>applyAiIngredientsToOverlay());
    if(aiAssistUploadBtn && aiAssistFileInput){
      aiAssistUploadBtn.addEventListener('click',()=>{
        aiAssistFileInput.value='';
        aiAssistFileInput.click();
      });
      aiAssistFileInput.addEventListener('change',()=>{
        const file=aiAssistFileInput.files && aiAssistFileInput.files[0];
        if(file) handleAiFileSelection(file);
      });
    }
    if(aiAssistCameraBtn){
      aiAssistCameraBtn.addEventListener('click',()=>startAiCamera());
    }
    if(aiAssistCaptureBtn){
      aiAssistCaptureBtn.addEventListener('click',()=>captureAiPhoto());
    }
    if(aiAssistCancelCameraBtn){
      aiAssistCancelCameraBtn.addEventListener('click',()=>stopAiCamera(true));
    }
    if(aiAssistClearImageBtn){
      aiAssistClearImageBtn.addEventListener('click',()=>clearAiImage());
    }
    aiAssistTableBody.addEventListener('click',(event)=>{
      const row=event.target.closest('tr');
      if(!row) return;
      const idx=Number(row.dataset.index||'0');
      if(event.target.classList.contains('aiDeleteRow') || event.target.closest('.aiDeleteRow')){
        const data=collectAiTableData();
        data.splice(idx,1);
        renderAiTable(data);
        return;
      }
      if(event.target.classList.contains('aiBrandSearchBtn') || event.target.closest('.aiBrandSearchBtn')){
        openAiBrandSearch(idx);
        return;
      }
      if(event.target.classList.contains('aiRemoveBrand') || event.target.closest('.aiRemoveBrand')){
        const brandIdx = Number(event.target.dataset.brandIdx || event.target.closest('.aiRemoveBrand')?.dataset.brandIdx);
        if(!isNaN(brandIdx)){
          const data = collectAiTableData();
          if(data[idx] && data[idx].brands){
            data[idx].brands.splice(brandIdx, 1);
            renderAiTable(data);
            aiAssistSetStatus('Brand removed from this ingredient.','info');
          }
        }
        return;
      }
    });
    aiAssistTableBody.addEventListener('input',(event)=>{
      const row=event.target.closest('tr');
      if(!row) return;
      if(event.target.classList.contains('aiIngredientName')){
        fillRowFromMemory(row,false);
      }
    });
    aiAssistTableBody.addEventListener('change',(event)=>{
      const row=event.target.closest('tr');
      if(!row) return;
      if(event.target.classList.contains('aiIngredientBrand')){
        const name=row.querySelector('.aiIngredientName')?.value||'';
        const brand=event.target.value.trim();
        if(name){
          if(brand){
            rememberBrand(name,{brand});
            row.dataset.brandImage='';
            row.dataset.ingredientsImage='';
            delete row.dataset.ingredientsList;
            updateAiBrandPreview(row);
          } else {
            forgetBrand(name);
            row.dataset.brandImage='';
            row.dataset.ingredientsImage='';
            delete row.dataset.ingredientsList;
            updateAiBrandPreview(row);
          }
        }
      }
    });
    aiAssistBrandResults.addEventListener('click',(event)=>{
      const card=event.target.closest('.aiBrandSuggestion');
      if(!card) return;
      const rowIdx=Number(card.dataset.row||'0');
      const suggestionIdx=Number(card.dataset.index||'0');
      applyBrandSuggestion(rowIdx,suggestionIdx);
    });
    updateAiAssistMediaPreview();
    aiAssistElementsBound=true;
  }
}

function toggleAiAssistBackdrop(show){
  ensureAiAssistElements();
  if(!aiAssistBackdrop) return;
  if(show){
    aiAssistBackdrop.classList.add('show');
    aiAssistBackdrop.setAttribute('aria-hidden','false');
  } else {
    aiAssistBackdrop.classList.remove('show');
    aiAssistBackdrop.setAttribute('aria-hidden','true');
  }
}

function updateAiAssistMediaPreview(){
  ensureAiAssistElements();
  const hasImage=!!aiAssistState.imageData;
  const hasStream=!!aiAssistState.mediaStream;
  if(aiAssistMediaPreview){
    aiAssistMediaPreview.classList.toggle('show',hasImage||hasStream);
  }
  if(aiAssistVideo){
    if(hasStream){
      aiAssistVideo.classList.remove('aiAssistHidden');
      if(aiAssistVideo.srcObject!==aiAssistState.mediaStream){
        aiAssistVideo.srcObject=aiAssistState.mediaStream;
      }
      aiAssistVideo.play().catch(()=>{});
    } else {
      try{aiAssistVideo.pause();}catch(_){ }
      aiAssistVideo.srcObject=null;
      aiAssistVideo.classList.add('aiAssistHidden');
    }
  }
  if(aiAssistCaptureBtn){
    aiAssistCaptureBtn.classList.toggle('aiAssistHidden',!hasStream);
  }
  if(aiAssistCancelCameraBtn){
    aiAssistCancelCameraBtn.classList.toggle('aiAssistHidden',!hasStream);
  }
  if(aiAssistImagePreview){
    if(hasImage){
      aiAssistImagePreview.src=aiAssistState.imageData;
      aiAssistImagePreview.classList.remove('aiAssistHidden');
    } else {
      aiAssistImagePreview.src='';
      aiAssistImagePreview.classList.add('aiAssistHidden');
    }
  }
  if(aiAssistClearImageBtn){
    aiAssistClearImageBtn.classList.toggle('aiAssistHidden',!hasImage);
  }
}

function handleAiFileSelection(file){
  ensureAiAssistElements();
  if(!file){
    aiAssistSetStatus('No file selected.','warn');
    return;
  }
  const reader=new FileReader();
  reader.onload=()=>{
    aiAssistState.imageData=typeof reader.result==='string'?reader.result:null;
    aiAssistState.imageFileName=file.name||'label.jpg';
    stopAiCamera();
    updateAiAssistMediaPreview();
    aiAssistSetStatus('Label photo attached. Review before processing.','info');
  };
  reader.onerror=()=>{
    aiAssistSetStatus('Could not read the selected image.','warn');
  };
  reader.readAsDataURL(file);
}

async function startAiCamera(){
  ensureAiAssistElements();
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    aiAssistSetStatus('Camera capture is not supported in this browser.','warn');
    return;
  }
  try{
    if(aiAssistState.mediaStream){
      stopAiCamera();
    }
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
    aiAssistState.mediaStream=stream;
    aiAssistState.imageData=null;
    aiAssistState.imageFileName=null;
    updateAiAssistMediaPreview();
    aiAssistSetStatus('Camera ready. Capture the label when it looks clear.','info');
  }catch(err){
    console.error('Camera error',err);
    aiAssistSetStatus('Could not access the camera: '+(err.message||err),'warn');
  }
}

function stopAiCamera(notify){
  ensureAiAssistElements();
  if(aiAssistState.mediaStream){
    try{aiAssistState.mediaStream.getTracks().forEach(track=>track.stop());}catch(_){ }
  }
  aiAssistState.mediaStream=null;
  if(aiAssistVideo){
    try{aiAssistVideo.pause();}catch(_){ }
    aiAssistVideo.srcObject=null;
  }
  updateAiAssistMediaPreview();
  if(notify){
    aiAssistSetStatus('Camera closed.','info');
  }
}

function captureAiPhoto(){
  ensureAiAssistElements();
  if(!aiAssistVideo || !aiAssistState.mediaStream){
    aiAssistSetStatus('Start the camera before capturing a photo.','warn');
    return;
  }
  const width=aiAssistVideo.videoWidth||1280;
  const height=aiAssistVideo.videoHeight||720;
  if(!width || !height){
    aiAssistSetStatus('Camera is still focusing. Try capturing again in a moment.','warn');
    return;
  }
  const canvas=document.createElement('canvas');
  canvas.width=width;
  canvas.height=height;
  const ctx=canvas.getContext('2d');
  if(!ctx){
    aiAssistSetStatus('Could not capture the photo.','warn');
    return;
  }
  ctx.drawImage(aiAssistVideo,0,0,width,height);
  aiAssistState.imageData=canvas.toDataURL('image/jpeg',0.92);
  aiAssistState.imageFileName=`label-${Date.now()}.jpg`;
  stopAiCamera();
  updateAiAssistMediaPreview();
  aiAssistSetStatus('Photo captured. Review before processing.','success');
}

function clearAiImage(){
  ensureAiAssistElements();
  aiAssistState.imageData=null;
  aiAssistState.imageFileName=null;
  if(aiAssistFileInput){
    aiAssistFileInput.value='';
  }
  updateAiAssistMediaPreview();
  aiAssistSetStatus('Label image cleared.','info');
}

function getRowIngredientsList(rowElement){
  if(!rowElement || !rowElement.dataset.ingredientsList) return [];
  try{
    const parsed=JSON.parse(rowElement.dataset.ingredientsList);
    return Array.isArray(parsed)?parsed:[];
  }catch(_){
    return [];
  }
}

function updateAiBrandPreview(rowElement){
  if(!rowElement) return;
  const brandPreview=rowElement.querySelector('.aiBrandPreview');
  if(brandPreview){
    const parts=[];
    const brandImage=rowElement.dataset.brandImage||'';
    const ingredientsImage=rowElement.dataset.ingredientsImage||'';
    if(brandImage) parts.push(`<img src="${esc(brandImage)}" alt="Brand preview" loading="lazy" onclick="openImageModal('${esc(brandImage)}')" title="Click to enlarge">`);
    if(ingredientsImage) parts.push(`<img src="${esc(ingredientsImage)}" alt="Ingredients label" loading="lazy" onclick="openImageModal('${esc(ingredientsImage)}')" title="Click to enlarge">`);
    brandPreview.innerHTML=parts.join('');
  }
  const listNote=rowElement.querySelector('.aiIngredientList');
  if(listNote){
    const list=getRowIngredientsList(rowElement);
    listNote.textContent=list.length?`Label ingredients: ${list.join(', ')}`:'';
  }
}

function collectAiTableData(){
  ensureAiAssistElements();
  if(!aiAssistTableBody) return [];
  const data=[];
  aiAssistTableBody.querySelectorAll('tr').forEach(row=>{
    const idx=Number(row.dataset.index||'0');
    const name=row.querySelector('.aiIngredientName')?.value.trim()||'';
    const allergens=[...row.querySelectorAll('.aiAllergenChecklist input:checked')].map(input=>input.value);

    // Collect multiple brands
    const brands=[];
    if(row.dataset.brands){
      try{
        brands.push(...JSON.parse(row.dataset.brands));
      }catch(_){}
    }

    data.push({index:idx,name,allergens,brands});
  });
  return data;
}

function renderAiTable(rows){
  ensureAiAssistElements();
  if(!aiAssistTableBody || !aiAssistResultsEl) return;
  const source=Array.isArray(rows)?rows:collectAiTableData();
  const data=source.map(item=>({...item}));
  aiAssistTableBody.innerHTML='';
  aiAssistState.brandSuggestions={};
  data.forEach((row,idx)=>{
    if(row.name){
      const memory=getRememberedBrand(row.name);
      if(memory){
        if(!row.brand && memory.brand) row.brand=memory.brand;
        if(!row.brandImage && memory.brandImage) row.brandImage=memory.brandImage;
        if(!row.ingredientsImage && memory.ingredientsImage) row.ingredientsImage=memory.ingredientsImage;
        if((!row.ingredientsList || !row.ingredientsList.length) && memory.ingredientsList){
          row.ingredientsList=memory.ingredientsList.slice();
        }
        if((!row.allergens || !row.allergens.length) && memory.allergens){
          row.allergens=memory.allergens.slice();
        }
      }
    }
    const tr=document.createElement('tr');
    tr.dataset.index=idx;
    const allergens=new Set((row.allergens||[]).map(norm));

    // Support multiple brands - store in dataset
    const brands = row.brands || [];
    if(brands.length > 0){
      tr.dataset.brands=JSON.stringify(brands);
    } else {
      delete tr.dataset.brands;
    }

    // Collect all AI-detected allergens from brands
    const aiDetectedAllergens = new Set();
    brands.forEach(brand => {
      if(Array.isArray(brand.allergens)){
        brand.allergens.forEach(a => aiDetectedAllergens.add(norm(a)));
      }
    });

    const brandsHTML = brands.length > 0 ? brands.map((brand, brandIdx) => {
      console.log('Rendering brand:', brand);
      const brandImages = [];
      if(brand.brandImage) brandImages.push(`<img src="${esc(brand.brandImage)}" alt="${esc(brand.name||'Brand')}" loading="lazy" onclick="openImageModal('${esc(brand.brandImage)}')" title="Click to enlarge">`);
      if(brand.ingredientsImage) brandImages.push(`<img src="${esc(brand.ingredientsImage)}" alt="Ingredients label" loading="lazy" onclick="openImageModal('${esc(brand.ingredientsImage)}')" title="Click to enlarge">`);
      const ingredientsNote = brand.ingredientsList && brand.ingredientsList.length ? `Label ingredients: ${brand.ingredientsList.map(i=>esc(i)).join(', ')}` : '';

      // Show message if no images are available
      const imagesDisplay = brandImages.length > 0 ? brandImages.join('') : '<div style="color:var(--muted);font-size:0.85rem;font-style:italic">No product images available</div>';
      console.log('Brand images array:', brandImages, 'Display:', imagesDisplay.substring(0, 50));

      return `
        <div class="aiBrandItem" data-brand-idx="${brandIdx}">
          <div class="aiBrandItemHeader">
            <strong>${esc(brand.name || 'Brand ' + (brandIdx + 1))}</strong>
            <button type="button" class="btn btnSmall aiRemoveBrand" data-brand-idx="${brandIdx}">×</button>
          </div>
          <div class="aiBrandPreview">${imagesDisplay}</div>
          ${ingredientsNote ? `<div class="aiIngredientList">${ingredientsNote}</div>` : '<div style="color:var(--muted);font-size:0.85rem;font-style:italic">No ingredient list available</div>'}
        </div>
      `;
    }).join('') : '<div class="aiNoBrands">No brands added yet</div>';

    tr.innerHTML=`
      <td colspan="4">
        <div class="aiIngredientRow">
          <div class="aiIngredientMain">
            <input type="text" class="aiIngredientName" placeholder="Ingredient name" value="${esc(row.name||'')}">
            <div class="aiBrandCell">
              <div class="aiBrandsList">
                ${brandsHTML}
              </div>
              <div class="aiBrandActions">
                <button type="button" class="btn aiBrandSearchBtn">+ Add brand</button>
              </div>
            </div>
            <div>
              ${aiDetectedAllergens.size > 0 ? '<div style="color:#4caf50;font-size:0.8rem;margin-bottom:6px">✓ Green = AI detected from brand labels</div>' : ''}
              <div class="aiAllergenChecklist">
                ${ALLERGENS.map(allergen=>{
                  const checked=allergens.has(norm(allergen))?'checked':'';
                  const aiDetected=aiDetectedAllergens.has(norm(allergen))?'aiDetected':'';
                  return `<label class="${aiDetected}"><input type="checkbox" value="${esc(allergen)}" ${checked}>${esc(cap(allergen))}</label>`;
                }).join('')}
              </div>
            </div>
            <button type="button" class="btn aiDeleteRow">Remove</button>
          </div>
          <div class="aiRowBrandResults" data-row-idx="${idx}"></div>
        </div>
      </td>
    `;
    aiAssistTableBody.appendChild(tr);
    updateAiBrandPreview(tr);
  });
  aiAssistResultsEl.classList.toggle('show', data.length>0);
  if(aiAssistBrandResults){
    aiAssistBrandResults.classList.remove('show');
    aiAssistBrandResults.innerHTML='';
  }
}

function heuristicallyExtractIngredients(text){
  if(!text) return [];
  const tokens=text
    .split(/\r?\n|\.|;/)
    .map(part=>part.split(/\band\b|\bwith\b|,/i))
    .flat()
    .map(part=>part.trim())
    .filter(Boolean);
  const unique=new Map();
  tokens.forEach(token=>{
    const cleaned=token.replace(/[\d/]+/g,'').replace(/\b(teaspoons?|tablespoons?|cups?|ounces?|grams?|lbs?|pounds?|ml|l|kg)\b/gi,'').replace(/[\(\)]/g,'').replace(/\s+/g,' ').trim();
    if(!cleaned) return;
    const key=norm(cleaned);
    if(unique.has(key)) return;
    const detectedAllergens=ALLERGENS.filter(a=>token.toLowerCase().includes(a));
    unique.set(key,{name:cap(cleaned),brand:'',allergens:detectedAllergens,ingredientsList:[cap(cleaned)]});
  });
  if(unique.size===0){
    return [{name:'',brand:'',allergens:[]}];
  }
  return Array.from(unique.values());
}

function openAiAssistant(context){
  ensureAiAssistElements();
  if(!aiAssistBackdrop) return;
  aiAssistState.context=context||{};
  aiAssistState.pendingRequestId=null;
  aiAssistState.brandSuggestions={};
  aiAssistState.imageData=null;
  aiAssistState.imageFileName=null;
  stopAiCamera();
  updateAiAssistMediaPreview();
  aiAssistSetStatus('');
  if(aiAssistInput){
    aiAssistInput.value=context?.seedText||'';
    setTimeout(()=>{aiAssistInput.focus(); aiAssistInput.selectionStart=aiAssistInput.value.length;},120);
  }
  renderAiTable([]);
  toggleAiAssistBackdrop(true);
}

function openImageModal(imageSrc){
  const modal=document.getElementById('imageModal');
  const img=document.getElementById('imageModalImg');
  if(modal && img){
    img.src=imageSrc;
    modal.classList.add('show');
    document.body.style.overflow='hidden';
  }
}

function closeImageModal(){
  const modal=document.getElementById('imageModal');
  if(modal){
    modal.classList.remove('show');
    document.body.style.overflow='';
  }
}

function closeAiAssistant(){
  ensureAiAssistElements();
  if(aiAssistState.recognition){
    try{aiAssistState.recognition.stop();}catch(_){}
  }
  aiAssistState.recognition=null;
  aiAssistState.listening=false;
  aiAssistState.pendingRequestId=null;
  aiAssistState.brandSuggestions={};
  aiAssistSetStatus('');
  stopAiCamera();
  aiAssistState.imageData=null;
  aiAssistState.imageFileName=null;
  updateAiAssistMediaPreview();
  if(aiAssistResultsEl){
    aiAssistResultsEl.classList.remove('show');
  }
  if(aiAssistTableBody){
    aiAssistTableBody.innerHTML='';
  }
  if(aiAssistBrandResults){
    aiAssistBrandResults.classList.remove('show');
    aiAssistBrandResults.innerHTML='';
  }
  if(aiAssistDictateBtn) aiAssistDictateBtn.textContent='🎙 Dictate';
  toggleAiAssistBackdrop(false);
}

function toggleAiDictation(){
  ensureAiAssistElements();
  if(aiAssistState.listening){
    if(aiAssistState.recognition){
      try{aiAssistState.recognition.stop();}catch(_){}
    }
    aiAssistState.listening=false;
    aiAssistSetStatus('Dictation stopped.','info');
    if(aiAssistDictateBtn) aiAssistDictateBtn.textContent='🎙 Dictate';
    return;
  }
  const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SpeechRecognition){
    aiAssistSetStatus('Dictation is not supported in this browser.','warn');
    return;
  }
  try{
    const recognition=new SpeechRecognition();
    recognition.lang='en-US';
    recognition.continuous=true;
    recognition.interimResults=true;
    recognition.onresult=(event)=>{
      let transcript='';
      for(let i=0;i<event.results.length;i++){
        transcript+=event.results[i][0].transcript;
      }
      if(aiAssistInput) aiAssistInput.value=transcript.trim();
    };
    recognition.onerror=(evt)=>{
      aiAssistSetStatus('Dictation error: '+(evt.error||'unknown'), 'warn');
    };
    recognition.onend=()=>{
      aiAssistState.listening=false;
      aiAssistState.recognition=null;
      if(aiAssistDictateBtn) aiAssistDictateBtn.textContent='🎙 Dictate';
    };
    recognition.start();
    aiAssistState.recognition=recognition;
    aiAssistState.listening=true;
    aiAssistSetStatus('Dictation active… speak now.');
    if(aiAssistDictateBtn) aiAssistDictateBtn.textContent='⏹ Stop dictation';
  }catch(err){
    console.error('Dictation failed',err);
    aiAssistSetStatus('Could not start dictation: '+(err.message||err),'error');
  }
}

async function correctSpellingWithAI(query, ingredientName){
  try {
    // Use Supabase function to correct spelling
    const client = window.supabaseClient;
    if(!client?.functions?.invoke){
      return query;
    }

    const { data, error } = await client.functions.invoke('spelling-corrector', {
      body: {
        query: query,
        ingredientName: ingredientName
      }
    });

    if(error){
      console.warn('Spelling correction error:', error);
      return query;
    }

    const corrected = data?.corrected || query;
    return corrected;
  } catch(err) {
    console.warn('AI spelling correction failed', err);
  }
  return query;
}

async function fetchBrandSuggestions(query, ingredientName){
  ensureAiAssistElements();
  if(!query) return [];

  // Try multiple search strategies for better results with misspellings
  let products = [];
  let searchQuery = query;

  // Strategy 0: Use AI to correct spelling if Supabase client is available
  if(window.supabaseClient){
    try {
      const corrected = await correctSpellingWithAI(query, ingredientName);
      if(corrected && corrected !== query){
        console.log(`AI corrected "${query}" to "${corrected}"`);
        searchQuery = corrected;
      }
    } catch(err) {
      console.warn('AI spelling correction failed, continuing with original query', err);
    }
  }

  // Strategy 1: Exact search (with potentially corrected spelling)
  try {
    const url=`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(searchQuery)}&search_simple=1&action=process&json=1&page_size=${AI_BRAND_LIMIT * 2}`;
    const res=await fetch(url);
    if(res.ok){
      const data=await res.json();
      products=Array.isArray(data.products)?data.products:[];
    }
  } catch(err) {
    console.warn('Exact search failed', err);
  }

  // Strategy 2: If no results, try fuzzy search by removing last letter and adding wildcard
  if(products.length === 0 && searchQuery.length > 4){
    try {
      const fuzzyQuery = searchQuery.substring(0, searchQuery.length - 1) + '*';
      const url=`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(fuzzyQuery)}&search_simple=1&action=process&json=1&page_size=${AI_BRAND_LIMIT * 2}`;
      const res=await fetch(url);
      if(res.ok){
        const data=await res.json();
        products=Array.isArray(data.products)?data.products:[];
      }
    } catch(err) {
      console.warn('Fuzzy search failed', err);
    }
  }

  // Strategy 3: If still no results, try without brand constraint
  if(products.length === 0){
    try {
      const url=`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(searchQuery)}&action=process&json=1&page_size=${AI_BRAND_LIMIT * 2}`;
      const res=await fetch(url);
      if(res.ok){
        const data=await res.json();
        products=Array.isArray(data.products)?data.products:[];
      }
    } catch(err) {
      console.warn('Broad search failed', err);
    }
  }

  if(!products.length) return [];

  // Filter products to match ingredient name (e.g., "tahini" should only show tahini products)
  if(ingredientName){
    const ingredientTerms = ingredientName.toLowerCase().split(/\s+/).filter(term => term.length > 2);
    products = products.filter(product => {
      const productName = (product.product_name || '').toLowerCase();
      const productCategories = (product.categories || '').toLowerCase();
      // Check if any ingredient term appears in product name or categories
      return ingredientTerms.some(term => productName.includes(term) || productCategories.includes(term));
    });
  }

  if(!products.length) return [];

  // Fetch full product details for first few products to get ingredient images
  const detailedProducts = await Promise.all(
    products.slice(0, Math.min(products.length, AI_BRAND_LIMIT)).map(async (product) => {
      if(!product.code) return product;
      try {
        const detailRes = await fetch(`https://world.openfoodfacts.org/api/v2/product/${product.code}.json`);
        if(detailRes.ok){
          const detailData = await detailRes.json();
          if(detailData.product){
            return {...product, ...detailData.product};
          }
        }
      } catch(err) {
        console.warn('Failed to fetch product details for', product.code, err);
      }
      return product;
    })
  );

  return detailedProducts.map(product=>{
    const allergens=[];
    if(Array.isArray(product.allergens_tags)){
      product.allergens_tags.forEach(tag=>{
        const key=norm(tag.replace(/^en:/,'').replace(/-/g,' '));
        const mapped=ALLERGEN_ALIASES[key] || key;
        if(mapped && ALLERGENS.some(a=>norm(a)===mapped)) allergens.push(cap(mapped));
      });
    }
    const ingredientsText = product.ingredients_text_en || product.ingredients_text || product.ingredients_original || '';
    let ingredientsList=[];
    if(ingredientsText){
      ingredientsList=ingredientsText.split(/[,;\n]/).map(part=>part.replace(/\(.+?\)/g,'').trim()).filter(Boolean).map(cap);
      detectAllergensInText(ingredientsText).forEach(a=>{
        if(!allergens.includes(cap(a))) allergens.push(cap(a));
      });
    }

    // Get ingredients image from multiple possible sources
    let ingredientsImage = product.image_ingredients_url || '';
    if(!ingredientsImage && product.selected_images?.ingredients){
      // Try different language variants
      const ingredImgs = product.selected_images.ingredients.display || product.selected_images.ingredients.small;
      if(ingredImgs){
        ingredientsImage = ingredImgs.en || ingredImgs.fr || ingredImgs.es || ingredImgs.de || Object.values(ingredImgs)[0] || '';
      }
    }

    return {
      name:product.product_name || product.brands || query,
      brand:product.brands || '',
      image:product.image_front_small_url || product.image_front_url || '',
      ingredientsImage,
      ingredientsList,
      allergens,
      productUrl:product.url || ''
    };
  }).filter(item=>item.name);
}

async function openAiBrandSearch(rowIdx){
  ensureAiAssistElements();
  const rows=collectAiTableData();
  if(!rows[rowIdx]){
    aiAssistSetStatus('Select an ingredient first.','warn');
    return;
  }

  const ingredientName = rows[rowIdx].name;
  if(!ingredientName){
    aiAssistSetStatus('Add an ingredient name before searching for a brand.','warn');
    return;
  }

  // Find the row-specific brand results container
  const rowElement=aiAssistTableBody?.querySelector(`tr[data-index="${rowIdx}"]`);
  if(!rowElement) return;
  const rowBrandResults=rowElement.querySelector('.aiRowBrandResults');
  if(!rowBrandResults) return;

  // Show search form
  rowBrandResults.classList.add('show');
  rowBrandResults.innerHTML=`
    <div class="aiBrandSearchForm">
      <div style="margin-bottom:12px">
        <label style="display:block;margin-bottom:6px;font-weight:500">Ingredient: <strong>${esc(ingredientName)}</strong></label>
        <input type="text" class="aiBrandSearchInput" placeholder="Optional: brand name (e.g., 'Chobani', 'Once Again')" style="width:100%;padding:8px;background:#0c102a;border:1px solid rgba(76,90,212,0.4);border-radius:8px;color:#fff">
      </div>
      <div style="display:flex;gap:8px">
        <button type="button" class="btn aiBrandSearchSubmit">Search</button>
        <button type="button" class="btn aiBrandSearchCancel" style="background:#301424;border-color:#4c2138">Cancel</button>
      </div>
    </div>
  `;

  const searchInput = rowBrandResults.querySelector('.aiBrandSearchInput');
  const submitBtn = rowBrandResults.querySelector('.aiBrandSearchSubmit');
  const cancelBtn = rowBrandResults.querySelector('.aiBrandSearchCancel');

  const performSearch = async () => {
    const brandFilter = searchInput.value.trim();
    const query = brandFilter ? `${ingredientName} ${brandFilter}` : ingredientName;

    aiAssistSetStatus('Searching for brand suggestions…');
    rowBrandResults.innerHTML='<div>Looking up brands…</div>';

    try{
      const suggestions=await fetchBrandSuggestions(query, ingredientName);
      aiAssistState.brandSuggestions[rowIdx]=suggestions;
      if(!suggestions.length){
        rowBrandResults.innerHTML=`
          <div style="text-align:center;padding:20px">
            <p style="margin-bottom:12px">No brands found.</p>
            <button type="button" class="btn aiBrandSearchAgain">Try a different search</button>
          </div>
        `;
        rowBrandResults.querySelector('.aiBrandSearchAgain').addEventListener('click', () => {
          openAiBrandSearch(rowIdx);
        });
        return;
      }
      rowBrandResults.innerHTML=`
        <div style="background:rgba(220,82,82,0.15);border:1px solid rgba(220,82,82,0.4);border-radius:12px;padding:12px;margin-bottom:16px">
          <strong style="color:#dc5252">⚠️ Safety Warning</strong>
          <p style="margin:8px 0 0 0;font-size:0.9rem;line-height:1.4">Data is crowdsourced and may be outdated or incorrect. ALWAYS verify ingredient labels match the actual product image before relying on allergen information.</p>
        </div>
        ${suggestions.map((item,idx)=>`
        <div class="aiBrandSuggestion" data-row="${rowIdx}" data-index="${idx}">
          ${item.image?`<img src="${esc(item.image)}" alt="${esc(item.name)}" loading="lazy">`:''}
          <div class="aiBrandSuggestionInfo">
            <strong>${esc(item.name)}</strong>
            ${item.brand?`<span>${esc(item.brand)}</span>`:''}
            ${item.ingredientsImage?'<span style="color:#4c5ad4">✓ Has label image - click to verify</span>':'<span style="color:#dc5252">⚠️ No label image available</span>'}
            ${item.productUrl?`<a href="${esc(item.productUrl)}" target="_blank" rel="noopener" style="font-size:0.85rem;color:#4c5ad4">View on Open Food Facts</a>`:''}
            <button type="button" class="btn btnSmall aiBrandApply" data-row="${rowIdx}" data-index="${idx}" style="margin-top:8px">Add this brand</button>
          </div>
        </div>
      `).join('')}
      <div style="text-align:center;margin-top:16px;padding-top:16px;border-top:1px solid rgba(76,90,212,0.2)">
        <button type="button" class="btn aiBrandSearchAgain">Search again</button>
      </div>
      `;

      // Add click handlers for "Add this brand" buttons
      rowBrandResults.querySelectorAll('.aiBrandApply').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const suggestionIdx = Number(e.target.dataset.index);
          applyBrandSuggestion(rowIdx, suggestionIdx);
        });
      });

      // Add click handler for "Search again" button
      rowBrandResults.querySelector('.aiBrandSearchAgain').addEventListener('click', () => {
        openAiBrandSearch(rowIdx);
      });

      aiAssistSetStatus('Review images carefully before applying. Click images to verify ingredient labels match.','warn');
    }catch(err){
      console.error('Brand lookup failed',err);
      rowBrandResults.innerHTML='<div>Could not retrieve brand information.</div>';
      aiAssistSetStatus('Brand lookup failed. Try again later.','warn');
    }
  };

  submitBtn.addEventListener('click', performSearch);
  cancelBtn.addEventListener('click', () => {
    rowBrandResults.classList.remove('show');
    rowBrandResults.innerHTML = '';
  });
  searchInput.addEventListener('keypress', (e) => {
    if(e.key === 'Enter'){
      performSearch();
    }
  });

  // Focus the input
  setTimeout(() => searchInput.focus(), 100);
}

function applyBrandSuggestion(rowIdx, suggestionIdx){
  ensureAiAssistElements();
  const suggestions=aiAssistState.brandSuggestions[rowIdx]||[];
  const suggestion=suggestions[suggestionIdx];
  if(!suggestion) return;

  // Safety confirmation for products with ingredient data
  if(suggestion.ingredientsList && suggestion.ingredientsList.length > 0){
    const hasImage = suggestion.ingredientsImage;
    const message = hasImage
      ? `⚠️ SAFETY CHECK:\n\nYou are about to apply ingredient data from Open Food Facts.\n\nIMPORTANT: This data is crowdsourced and may be outdated or incorrect.\n\nBefore applying:\n1. Click the ingredient label image to view it full-size\n2. Verify the ingredients list matches the image exactly\n3. Check that allergens are correctly identified\n\nProduct: ${suggestion.name}\nIngredients: ${suggestion.ingredientsList.slice(0,3).join(', ')}${suggestion.ingredientsList.length > 3 ? '...' : ''}\n\nHave you verified the ingredient label image matches this data?`
      : `⚠️ WARNING:\n\nThis product has ingredient data but NO LABEL IMAGE.\n\nWithout a label image, you cannot verify:\n- If the data is current\n- If it matches the actual product\n- If allergens are accurate\n\nProduct: ${suggestion.name}\n\nIt is NOT RECOMMENDED to use this data without visual verification.\n\nDo you want to proceed anyway?`;

    if(!confirm(message)){
      aiAssistSetStatus('Brand not applied. Verification required for safety.','warn');
      return;
    }
  }

  const row=aiAssistTableBody?.querySelector(`tr[data-index="${rowIdx}"]`);
  if(!row) return;

  // Get existing brands array
  let brands = [];
  if(row.dataset.brands){
    try{
      brands = JSON.parse(row.dataset.brands);
    }catch(_){}
  }

  // Add new brand to the array
  const newBrand = {
    name: suggestion.brand || suggestion.name || 'Brand',
    brandImage: suggestion.image || '',
    ingredientsImage: suggestion.ingredientsImage || '',
    ingredientsList: Array.isArray(suggestion.ingredientsList) ? suggestion.ingredientsList : [],
    allergens: Array.isArray(suggestion.allergens) ? suggestion.allergens : []
  };
  console.log('Adding brand:', newBrand);
  brands.push(newBrand);

  // Update allergens checkboxes with combined allergens from all brands
  const allAllergens = new Set();
  brands.forEach(brand => {
    if(Array.isArray(brand.allergens)){
      brand.allergens.forEach(a => allAllergens.add(norm(a)));
    }
  });
  row.querySelectorAll('.aiAllergenChecklist input').forEach(input=>{
    if(allAllergens.has(norm(input.value))){
      input.checked=true;
    }
  });

  // Store updated brands and re-render the row
  const rowData = collectAiTableData().find(r => r.index === rowIdx);
  if(rowData){
    rowData.brands = brands;
    renderAiTable(collectAiTableData().map(r => r.index === rowIdx ? {...r, brands} : r));
  }

  // Close the inline brand results
  const rowBrandResults=row.querySelector('.aiRowBrandResults');
  if(rowBrandResults){
    rowBrandResults.classList.remove('show');
    rowBrandResults.innerHTML='';
  }

  // Also close the old global results if present
  if(aiAssistBrandResults){
    aiAssistBrandResults.classList.remove('show');
    aiAssistBrandResults.innerHTML='';
  }
  aiAssistSetStatus('Brand applied. Please review allergens carefully.','warn');
}

async function requestAiExtraction(payload){
  const endpoint=state.aiAssistEndpoint || window.__CLE_AI_ENDPOINT__ || null;
  if(endpoint){
    const res=await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!res.ok){
      const text=await res.text().catch(()=>res.statusText);
      throw new Error(text||'AI endpoint returned an error');
    }
    return await res.json();
  }
  const client=window.supabaseClient;
  if(client?.functions?.invoke){
    const candidates=['ai-ingredient-assistant','ai-ingredient-extract','aiAssistExtract'];
    for(const fn of candidates){
      try{
        const { data, error } = await client.functions.invoke(fn,{ body: payload });
        if(error) continue;
        if(data) return data;
      }catch(err){
        console.warn('AI function call failed',fn,err);
      }
    }
  }
  throw new Error('AI service unavailable');
}

async function handleRecipePhotoUpload(file){
  ensureAiAssistElements();
  try{
    const reader = new FileReader();
    reader.onload = async (e) => {
      const imageData = e.target.result;
      aiAssistSetStatus('Reading recipe from photo using AI...');

      const payload = {
        imageData: imageData,
        imageFileName: file.name,
        text: 'Please extract all ingredients from this recipe image.',
        dishName: aiAssistState.context?.getCurrentName ? aiAssistState.context.getCurrentName() : ''
      };

      try{
        const result = await requestAiExtraction(payload);
        const rows = Array.isArray(result?.ingredients) ? result.ingredients : [];
        renderAiTable(rows);
        aiAssistSetStatus(rows.length ? 'Extracted ingredients from recipe photo. Review before applying.' : 'Could not extract ingredients from recipe photo.', rows.length ? 'info' : 'warn');
      }catch(err){
        console.error('Recipe photo extraction failed', err);
        aiAssistSetStatus('Failed to read recipe photo: ' + (err.message || err), 'error');
      }
    };
    reader.readAsDataURL(file);
  }catch(err){
    console.error('Recipe photo upload failed', err);
    aiAssistSetStatus('Failed to upload recipe photo: ' + (err.message || err), 'error');
  }
}

async function handleRecipePhotoCamera(){
  ensureAiAssistElements();
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    aiAssistState.mediaStream = stream;
    if(aiAssistVideo){
      aiAssistVideo.srcObject = stream;
      aiAssistVideo.play();
    }
    updateAiAssistMediaPreview();
    aiAssistSetStatus('Position recipe in view and click Capture photo');
  }catch(err){
    console.error('Camera access failed', err);
    aiAssistSetStatus('Could not access camera: ' + (err.message || err), 'error');
  }
}

function handleAiProcess(){
  ensureAiAssistElements();
  if(!aiAssistInput) return;
  const text=aiAssistInput.value.trim();
  const hasImage=!!aiAssistState.imageData;
  if(!text && !hasImage){
    aiAssistSetStatus('Describe the dish or add a label photo before processing.','warn');
    return;
  }
  aiAssistSetStatus('Processing description…');
  const payload={
    text,
    dishName:aiAssistState.context?.getCurrentName ? aiAssistState.context.getCurrentName() : ''
  };
  if(aiAssistState.imageData){
    payload.imageData=aiAssistState.imageData;
    if(aiAssistState.imageFileName) payload.imageFileName=aiAssistState.imageFileName;
  }
  if(window!==window.parent){
    const requestId=`ai-${Date.now()}-${Math.random().toString(16).slice(2)}`;
    aiAssistState.pendingRequestId=requestId;
    parent.postMessage({
      type:'aiAssistExtract',
      requestId,
      ...payload
    },"*");
  } else {
    (async()=>{
      try{
        const result=await requestAiExtraction(payload);
        const rows=Array.isArray(result?.ingredients)?result.ingredients:[];
        renderAiTable(rows);
        aiAssistSetStatus(rows.length?'AI ingredient suggestions ready. Review before applying.':'AI could not extract ingredients from the description.','info');
      }catch(err){
        console.error('AI extraction failed',err);
        if(text){
          const ingredients=heuristicallyExtractIngredients(text);
          renderAiTable(ingredients);
          aiAssistSetStatus('AI service unavailable—generated a draft using local parsing. Review before applying.','warn');
        } else {
          aiAssistSetStatus('AI assistant request failed: '+(err.message||err),'warn');
        }
      }
    })();
  }
}

function handleAiAssistantResult(payload){
  ensureAiAssistElements();
  if(!payload || payload.requestId!==aiAssistState.pendingRequestId) return;
  aiAssistState.pendingRequestId=null;
  const rows=Array.isArray(payload.ingredients)?payload.ingredients:[];
  rows.forEach(row=>{
    if(row && row.name && row.brand){
      rememberBrand(row.name,{
        brand:row.brand,
        brandImage:row.brandImage||'',
        ingredientsImage:row.ingredientsImage||'',
        ingredientsList:Array.isArray(row.ingredientsList)?row.ingredientsList:[],
        allergens:Array.isArray(row.allergens)?row.allergens:[],
      });
    }
  });
  renderAiTable(rows);
  aiAssistSetStatus(rows.length?'AI ingredient suggestions ready. Review before applying.':'AI could not extract ingredients from the description.','info');
}

function handleAiAssistantError(payload){
  ensureAiAssistElements();
  if(!payload || payload.requestId!==aiAssistState.pendingRequestId) return;
  aiAssistState.pendingRequestId=null;
  aiAssistSetStatus(payload.error || 'AI assistant request failed.', 'warn');
}

function applyAiIngredientsToOverlay(){
  ensureAiAssistElements();
  const rows=collectAiTableData();
  if(!rows.length){
    aiAssistSetStatus('Add at least one ingredient before applying.','warn');
    return;
  }
  rows.forEach(row=>{
    if(row && row.name && row.brand){
      rememberBrand(row.name,{
        brand:row.brand,
        brandImage:row.brandImage||'',
        ingredientsImage:row.ingredientsImage||'',
        ingredientsList:Array.isArray(row.ingredientsList)?row.ingredientsList:[],
        allergens:Array.isArray(row.allergens)?row.allergens:[],
      });
    }
  });
  if(aiAssistState.context?.onApply){
    aiAssistState.context.onApply(rows);
  }
  closeAiAssistant();
  aiAssistSetStatus('');
}

const daysAgo=d=>{
  try{
    const x=new Date(d);
    if(isNaN(x)) return '—';
    const now=new Date();
    
    // Reset both dates to midnight for accurate day comparison
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const compareDate = new Date(x.getFullYear(), x.getMonth(), x.getDate());
    
    const diff=Math.floor((today-compareDate)/(1000*60*60*24));
    
    if(diff===0) return 'today';
    if(diff===1) return '1 day ago';
    if(diff<0) return 'today'; // Future date edge case
    return diff+' days ago';
  }catch(_){return '—';}
};
function div(html,cls){const d=document.createElement('div'); if(cls)d.className=cls; d.innerHTML=html; return d;}

function normalizeRestaurant(row){
  if(!row) return null;
  const id = row._id ?? row.id;
  const menuImage = row.menuImage ?? row.menu_image;
  const lastConfirmed = row.lastConfirmed ?? row.last_confirmed;
  const overlays = Array.isArray(row.overlays) ? row.overlays : [];
  return {
    _id: id,
    name: row.name,
    slug: row.slug,
    menuImage,
    lastConfirmed,
    overlays
  };
}

function configureModalClose({visible=true,onClick=null}={}){
  const closeBtn=document.getElementById('modalCloseBtn');
  if(closeBtn){
    closeBtn.style.display=visible?'inline-flex':'none';
    closeBtn.onclick=onClick || null;
  }
}

async function insertChangeLogEntry(base){
  const client=window.supabaseClient;
  if(!client) throw new Error('Supabase client not ready.');
  const payload={
    restaurant_id: base.restaurantId,
    type: base.type,
    description: base.description,
    changes: base.changes,
    user_email: base.userEmail || null,
    photos: Array.isArray(base.photos) ? base.photos : (base.photos ? [base.photos] : []),
    timestamp: base.timestamp || new Date().toISOString()
  };
  Object.keys(payload).forEach(k=>payload[k]==null&&delete payload[k]);
  const { error } = await client.from('change_logs').insert([payload]);
  if(error) throw error;
  return true;
}

async function fetchChangeLogEntries(restaurantId){
  const client=window.supabaseClient;
  if(!client) throw new Error('Supabase client not ready.');
  let query=client.from('change_logs').select('*').order('timestamp',{ascending:false}).limit(50);
  if(restaurantId){
    query=query.eq('restaurant_id',restaurantId);
  }
  const {data,error}=await query;
  if(error) throw error;
  return data||[];
}
/* risk + tooltip */
function computeStatus(item,sel){
  if(!sel||!sel.length) return 'neutral';
  const hits=(item.allergens||[]).filter(a=>sel.includes(a));
  if(!hits.length) return 'safe';
  const removableAll=hits.every(a=>(item.removable||[]).some(r=>r.allergen===a));
  return removableAll?'removable':'unsafe';
}

function hasCrossContamination(item,sel){
  if(!sel||!sel.length) return false;
  const crossContam=(item.crossContamination||[]);
  return crossContam.some(a=>sel.includes(a));
}

/* scale-aware tooltip */
function currentScale(){
  try{ return (window.visualViewport && window.visualViewport.scale) ? window.visualViewport.scale : 1; }
  catch(_){ return 1; }
}
function tooltipBodyHTML(item,sel){
  const status=computeStatus(item,sel);
  const details=item.details||{};
  const hasCross=hasCrossContamination(item,sel);
  
  if(!sel.length) return `<div class="note">No saved allergens selected.</div>`;
  
  let html='';
  const hits=(item.allergens||[]).filter(a=>sel.includes(a));
  const removableSet=new Set((item.removable||[]).map(r=>norm(r.allergen||'')));
  
  const unsafeHits=hits.filter(a=>!removableSet.has(norm(a)));
  const removableHits=hits.filter(a=>removableSet.has(norm(a)));
  
  if(unsafeHits.length){
    const list=unsafeHits.map(a=>{
      const why=details[a]?` — ${esc(details[a])}`:'';
      return `<li>${esc(cap(a))}${why}</li>`;
    }).join('');
    html+=`<div class="note tooltipDangerText"><strong>Contains (cannot be accommodated)</strong><ul class="tooltipList">${list}</ul></div>`;
  }
  if(removableHits.length){
    const list=removableHits.map(a=>{
      const why=details[a]?` — ${esc(details[a])}`:'';
      return `<li>${esc(cap(a))}${why}</li>`;
    }).join('');
    html+=`<div class="note tooltipWarnText"><strong>Contains (can be accommodated)</strong><ul class="tooltipList">${list}</ul></div>`;
  }
  if(!hits.length){
    html+=`<div class="note tooltipNeutralText">No selected allergens found.</div>`;
  }
  
  if(hasCross){
    const crossHits=(item.crossContamination||[]).filter(a=>sel.includes(a));
    const crossList=crossHits.map(a=>`<li>${esc(cap(a))}</li>`).join('');
    html+=`<div class="note tooltipNeutralText"><strong>Cross-contamination risk</strong><ul class="tooltipList">${crossList}</ul></div>`;
  }
  
  if(details && details.__ingredientsSummary){
    html+=`<div class="note tooltipNeutralText"><strong>Ingredients</strong><br>${esc(details.__ingredientsSummary)}</div>`;
  }
  
  return html;
}

function renderTopbar(){
  const el=document.getElementById('topbar'); el.innerHTML='';
  const isQrExperience=!!(state.qr||urlQR);
  document.body.classList.toggle('qrMode',isQrExperience);
  const brand=div(`<img src="https://static.wixstatic.com/media/945e9d_2b97098295d341d493e4a07d80d6b57c~mv2.png" alt=""><span>CLE Allergy Aware</span>`,'brand');
  brand.onclick=()=>window.location.href='account.html';
  brand.style.cursor='pointer';
  el.appendChild(brand);
  if(!isQrExperience){
    const navWrap=div('','topNav');
    const tabs=div('','tabs');
    const navItems=[{t:'All restaurants',to:'/restaurants'}];
    if(state.user?.loggedIn){
      navItems.push({t:'Favorite restaurants',to:'/favorites'});
    }
    navItems.forEach(n=>{
      const b=div(n.t,'tab'); b.onclick=()=>send({type:'navigate',to:n.to}); tabs.appendChild(b);
    });
    navWrap.appendChild(tabs);
    const acct=div(state.user?.loggedIn?'My Account':'Sign in','acctBtn');
    acct.onclick=()=>{
      if(state.user?.loggedIn){
        send({type:'navigate',to:'/accounts'});
      } else {
        requestSignIn();
      }
    };
    navWrap.appendChild(acct);
    el.appendChild(navWrap);
  }
}

/* tooltips */
const pageTip=document.getElementById('tip');
function prefersMobileInfo(){
  try{
    const hasCoarse = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
    const hasFine = window.matchMedia && window.matchMedia('(pointer: fine)').matches;
    if(hasCoarse) return true;
    if(hasFine) return false;
    return window.innerWidth <= 640;
  }catch(_){
    return window.innerWidth <= 640;
  }
}
function renderMobileInfo(item){
  ensureMobileInfoPanel();
  if(!mobileInfoPanel) return;
  mobileInfoPanel.style.position='fixed';
  mobileInfoPanel.style.left='0';
  mobileInfoPanel.style.right='0';
  mobileInfoPanel.style.bottom='0';
  mobileInfoPanel.style.zIndex='3500';
  if(!prefersMobileInfo()){
    mobileInfoPanel.classList.remove('show');
    mobileInfoPanel.innerHTML='';
    currentMobileInfoItem=null;
    return;
  }
  if(!item){
    currentMobileInfoItem=null;
    mobileInfoPanel.innerHTML='';
    mobileInfoPanel.classList.remove('show');
    return;
  }
  currentMobileInfoItem=item;
  const bodyHTML=tooltipBodyHTML(item,state.allergies||[]);
  mobileInfoPanel.innerHTML=`
    <div class="mobileInfoHeaderRow">
      <div class="mobileInfoHeader">${esc(item.id||'Item')}</div>
      <button type="button" class="mobileInfoClose" aria-label="Close dish details">×</button>
    </div>
    ${bodyHTML}
  `;
  mobileInfoPanel.style.background='rgba(11,16,32,0.94)';
  mobileInfoPanel.style.backdropFilter='blur(14px)';
  mobileInfoPanel.style.webkitBackdropFilter='blur(14px)';
  adjustMobileInfoPanelForZoom();
  mobileInfoPanel.classList.add('show');
  const closeBtn=mobileInfoPanel.querySelector('.mobileInfoClose');
  if(closeBtn){
    const closePanel=(ev)=>{
      if(ev){ev.preventDefault(); ev.stopPropagation();}
      renderMobileInfo(null);
    };
    closeBtn.addEventListener('click',closePanel);
    closeBtn.addEventListener('touchend',closePanel,{passive:false});
    closeBtn.addEventListener('keydown',(ev)=>{ if(ev.key==='Enter'||ev.key===' '){ closePanel(ev); }});
  }
}
function syncMobileInfoPanel(){
  if(!mobileInfoPanel) return;
  adjustMobileInfoPanelForZoom();
  if(prefersMobileInfo()){
    if(currentMobileInfoItem){
      renderMobileInfo(currentMobileInfoItem);
    } else {
      mobileInfoPanel.innerHTML='';
      mobileInfoPanel.classList.remove('show');
    }
    hideTip();
  } else {
    mobileInfoPanel.classList.remove('show');
    mobileInfoPanel.innerHTML='';
    currentMobileInfoItem=null;
  }
}
addEventListener('resize', ()=>syncMobileInfoPanel(), {passive:true});
if(window.visualViewport){
  visualViewport.addEventListener('resize', ()=>syncMobileInfoPanel(), {passive:true});
  visualViewport.addEventListener('scroll', ()=>syncMobileInfoPanel(), {passive:true});
}
ensureMobileInfoPanel();
function showTipIn(el, x, y, title, bodyHTML, anchorRect=null){
  const vv=window.visualViewport;
  const zoom = vv && vv.scale ? vv.scale : 1;
  const offsetLeft = vv && typeof vv.offsetLeft === 'number' ? vv.offsetLeft : 0;
  const offsetTop = vv && typeof vv.offsetTop === 'number' ? vv.offsetTop : 0;
  const viewportWidth = vv && vv.width ? vv.width : window.innerWidth;
  const viewportHeight = vv && vv.height ? vv.height : window.innerHeight;
  const scrollX = window.scrollX || window.pageXOffset || document.documentElement.scrollLeft || 0;
  const scrollY = window.scrollY || window.pageYOffset || document.documentElement.scrollTop || 0;
  el.innerHTML = `
    <div class="tipHead">
      <div class="tTitle">${esc(title||'Item')}</div>
      <button class="tClose" type="button">✕</button>
    </div>
    ${bodyHTML}
  `;
  el.style.display = 'block';

  const isMobile = window.innerWidth <= 640;
  el.style.transform = '';
  el.style.transformOrigin = '';

  const layoutWidth = document.documentElement?.clientWidth || window.innerWidth;
  const baseMaxWidth = isMobile
    ? Math.min(280, Math.max(220, layoutWidth - 40))
    : Math.min(320, Math.max(240, layoutWidth - 80));
  el.style.maxWidth = baseMaxWidth + 'px';
  el.style.padding = isMobile ? '8px' : '10px';
  el.style.borderRadius = isMobile ? '8px' : '10px';
  el.style.fontSize = isMobile ? '12px' : '14px';
  
  const titleEl = el.querySelector('.tTitle');
  if(titleEl) titleEl.style.fontSize = isMobile ? '14px' : '16px';
  
  const closeEl = el.querySelector('.tClose');
  if(closeEl) {
    closeEl.style.padding = isMobile ? '3px 6px' : '4px 8px';
    closeEl.style.fontSize = isMobile ? '12px' : '14px';
    closeEl.style.borderRadius = isMobile ? '5px' : '6px';
  }

  const noteEls = el.querySelectorAll('.note');
  noteEls.forEach(n => n.style.fontSize = isMobile ? '11px' : '13px');

  requestAnimationFrame(() => {
    const r = el.getBoundingClientRect();
    const pad = isMobile ? 8 : 12;
    const visibleLeft = scrollX + offsetLeft;
    const visibleTop = scrollY + offsetTop;
    const visibleRight = visibleLeft + viewportWidth;
    const visibleBottom = visibleTop + viewportHeight;

    const useAnchor = !!anchorRect;

    const anchorLeft = anchorRect ? anchorRect.left + scrollX + offsetLeft : null;
    const anchorRight = anchorRect ? anchorRect.right + scrollX + offsetLeft : null;
    const anchorTop = anchorRect ? anchorRect.top + scrollY + offsetTop : null;
    const anchorBottom = anchorRect ? anchorRect.bottom + scrollY + offsetTop : null;
    const anchorCenterX = anchorRect ? (anchorLeft + anchorRight) / 2 : null;

    let left;
    let top;

    if(useAnchor){
      const offset = isMobile ? 12 : 16;
      left = (anchorCenterX || (visibleLeft + pad)) - (r.width/2);
      top = (anchorTop !== null ? anchorTop : (visibleTop + pad)) - r.height - offset;

      if (top < visibleTop + pad) {
        top = (anchorBottom !== null ? anchorBottom : (visibleTop + pad)) + offset;
      }
      if (top + r.height + pad > visibleBottom) {
        const anchorMiddle = anchorRect ? anchorTop + (anchorRect.height/2) : (visibleTop + viewportHeight/2);
        top = anchorMiddle - (r.height/2);
        if (top + r.height + pad > visibleBottom) {
          top = visibleBottom - r.height - pad;
        }
      }
    } else {
      const pointerX = (typeof x === 'number' ? x + scrollX + offsetLeft : (visibleLeft + viewportWidth/2));
      const pointerY = (typeof y === 'number' ? y + scrollY + offsetTop : (visibleTop + viewportHeight/2));
      left = pointerX + (isMobile ? 8 : 12);
      top = pointerY + (isMobile ? 8 : 12);
    }

    if (left + r.width + pad > visibleRight) {
      left = Math.max(visibleLeft + pad, visibleRight - r.width - pad);
    }
    if (top + r.height + pad > visibleBottom) {
      top = Math.max(visibleTop + pad, visibleBottom - r.height - pad);
    }
    
    left = Math.max(visibleLeft + pad, left);
    top = Math.max(visibleTop + pad, top);
    
    el.style.left = left + 'px';
    el.style.top  = top + 'px';
  });

  if(el.querySelector('.tClose')) {
    el.querySelector('.tClose').onclick = () => { el.style.display='none'; };
  }
}

function hideTip(){ pageTip.style.display='none'; }

/* list */
function renderCardsPage(){
  renderTopbar();
  const r=document.getElementById('root');
  r.innerHTML=`<h1 style="text-align:center">Restaurants</h1><div class="cards" id="grid"></div>`;
  const grid=document.getElementById('grid');
  (state.restaurants||[]).forEach(rs=>{
    const c=div(`<div class="card">
        <img src="${esc(rs.menuImage||'')}" alt="">
        <div class="pad">
          <div style="font-weight:800;margin-bottom:6px">${esc(rs.name||'Restaurant')}</div>
          <div class="note">Last confirmed by staff: ${rs.lastConfirmed?esc(daysAgo(rs.lastConfirmed)):'—'}</div>
          <div style="margin-top:10px"><button class="btn btnPrimary">View menu & allergens</button></div>
        </div></div>`);
    c.querySelector('.btn').onclick=()=>send({type:'openRestaurant',slug:rs.slug});
    grid.appendChild(c);
  });
}

/* chips */
function renderSavedChips(el){
  el.innerHTML='';
  const saved=(state.allergies||[]).map(norm);
  if(!saved.length){
    el.appendChild(div('<div class="note">No saved allergens. Use "Edit saved allergens".</div>'));
    updateFullScreenAllergySummary();
    return;
  }
  const row=div('','chips'); saved.forEach(a=>row.appendChild(div(esc(cap(a)),'chip active'))); el.appendChild(row);
  updateFullScreenAllergySummary();
}

/* selector for QR guests */
function renderSelector(el){
  el.innerHTML='';
  const row=div('','chips');
  row.setAttribute('role','list');
  const sel=new Set((state.allergies||[]).map(norm));
  ALLERGENS.forEach(a=>{
    const isActive=sel.has(a);
    const c=div(esc(cap(a)),'chip clickable'+(isActive?' active':''));
    c.setAttribute('role','button');
    c.setAttribute('tabindex','0');
    c.setAttribute('aria-pressed',isActive?'true':'false');
    c.dataset.value=a;
    const toggle=()=>{
      if(sel.has(a)){
        sel.delete(a);
      } else {
        sel.add(a);
      }
      state.allergies=[...sel];
      updateFullScreenAllergySummary();
      try{sessionStorage.setItem('qrAllergies',JSON.stringify(state.allergies));}catch(_){}
      renderSelector(el);
      if(window.__rerenderLayer__) window.__rerenderLayer__();
      send({type:'qrAllergies',allergies:state.allergies});
      if(prefersMobileInfo()) renderMobileInfo(currentMobileInfoItem);
    };
    c.addEventListener('click',(evt)=>{
      evt.preventDefault();
      evt.stopPropagation();
      toggle();
    },{passive:false});
    c.addEventListener('touchend',(evt)=>{
      evt.preventDefault();
      evt.stopPropagation();
      toggle();
    },{passive:false});
    c.addEventListener('keydown',(evt)=>{
      if(evt.key==='Enter' || evt.key===' '){
        evt.preventDefault();
        toggle();
      }
    });
    row.appendChild(c);
  });
  el.appendChild(row);
  updateFullScreenAllergySummary();
}

/* draw (simple image that follows page zoom) */
function drawMenu(container,imageURL){
  container.innerHTML='';
  const inner=div('','menuInner'); container.appendChild(inner);
  if(!imageURL){ inner.innerHTML=`<div class="note" style="padding:16px">No menu image configured for this restaurant.</div>`; return; }

  const img=new Image(); img.src=imageURL; img.className='menuImg'; inner.appendChild(img);
  const layer=div('','overlayLayer'); inner.appendChild(layer);

  const menuState=getMenuState();
  menuState.img=img;
  menuState.layer=layer;
  menuState.inner=inner;

  ensureMobileViewerChrome();
  updateZoomIndicator();
  const showOverlayDetails=(evt,item,target)=>{
    ensureMobileInfoPanel();
    let pointerType='mouse';
    if(evt){
      if(typeof evt.pointerType==='string'){
        pointerType=evt.pointerType;
      } else if(evt.type && evt.type.toLowerCase().includes('touch')){
        pointerType='touch';
      } else if(evt.type && evt.type.toLowerCase().includes('pointer')){
        pointerType='pen';
      }
    }
    const useMobilePanel = (pointerType!=='mouse') && prefersMobileInfo();
    if(useMobilePanel){
      if(evt){
        if(typeof evt.preventDefault==='function') evt.preventDefault();
        if(typeof evt.stopPropagation==='function') evt.stopPropagation();
      }
      if(currentMobileInfoItem===item && mobileInfoPanel?.classList.contains('show')){
        renderMobileInfo(null);
      } else {
        hideTip();
        renderMobileInfo(item);
      }
      return;
    }
    if(mobileInfoPanel && mobileInfoPanel.classList.contains('show')){
      mobileInfoPanel.classList.remove('show');
      mobileInfoPanel.innerHTML='';
      currentMobileInfoItem=null;
    }
    const client = evt?.changedTouches ? evt.changedTouches[0] : evt;
    const rect = target?.getBoundingClientRect
      ? target.getBoundingClientRect()
      : (evt?.currentTarget?.getBoundingClientRect ? evt.currentTarget.getBoundingClientRect() : null);
    const clientX = client?.clientX ?? 0;
    const clientY = client?.clientY ?? 0;
    showTipIn(pageTip, clientX, clientY, item.id||'Item', tooltipBodyHTML(item,state.allergies||[]), rect);
  };

  function renderLayer(){
    [...layer.querySelectorAll('.overlay')].forEach(n=>n.remove());
    const colors={ safe:'var(--ok)', removable:'var(--warn)', unsafe:'var(--bad)', neutral:'#ffffff1a'};
    
    if(!img.complete || !img.naturalWidth || !img.clientWidth || !img.clientHeight) {
      console.log('Image not ready yet');
      return;
    }
    
    layer.style.width = img.clientWidth + 'px';
    layer.style.height = img.clientHeight + 'px';
    
    (Array.isArray(state.restaurant?.overlays)?state.restaurant.overlays:[]).forEach(it=>{
      
      const box=document.createElement('div');
      box.className='overlay';
      const st=computeStatus(it,state.allergies||[]);
      box.style.borderColor=colors[st]||colors.neutral;
      box.style.left=(+it.x||0)+'%'; 
      box.style.top=(+it.y||0)+'%'; 
      box.style.width=(+it.w||0)+'%'; 
      box.style.height=(+it.h||0)+'%';

      const hasCross=hasCrossContamination(it,state.allergies||[]);
      if(hasCross){
        const warning=document.createElement('div');
        warning.className='ovWarning';
        warning.title='Cross-contamination warning';
        warning.textContent='⚠';
        warning.addEventListener('click',(e)=>{showOverlayDetails(e,it,e.currentTarget);});
        warning.addEventListener('touchend',(e)=>{showOverlayDetails(e,it,e.currentTarget);});
        box.appendChild(warning);
      }

      const badge=document.createElement('div'); 
      badge.className='ovBadge'; 
      badge.title='Details'; 
      badge.textContent='i';
      badge.addEventListener('click',(e)=>{showOverlayDetails(e,it,e.currentTarget);});
      badge.addEventListener('touchend',(e)=>{showOverlayDetails(e,it,e.currentTarget);});
      box.appendChild(badge);

      box.addEventListener('mousemove',(e)=>{
        if(prefersMobileInfo()) return;
        const rect = (e.currentTarget && e.currentTarget.getBoundingClientRect)
          ? e.currentTarget.getBoundingClientRect()
          : box.getBoundingClientRect();
        showTipIn(pageTip, e.clientX, e.clientY, it.id||'Item', tooltipBodyHTML(it,state.allergies||[]), rect);
      });
      box.addEventListener('mouseleave',hideTip);
      box.addEventListener('click',(e)=>{showOverlayDetails(e,it,e.currentTarget);});
      box.addEventListener('touchend',(e)=>{showOverlayDetails(e,it,e.currentTarget);});

      layer.appendChild(box);
    });
  }

  window.__rerenderLayer__=renderLayer;
  captureMenuBaseDimensions(true);

  if(img.complete && img.naturalWidth) {
    renderLayer();
    captureMenuBaseDimensions(true);
  } else {
    img.onload=()=>{
      setTimeout(renderLayer, 50);
      captureMenuBaseDimensions(true);
      if(document.body.classList.contains('mobileViewerActive')){
        setMobileZoom(mobileZoomLevel,true);
      }
    };
  }

  addEventListener('resize', ()=>{
    requestAnimationFrame(renderLayer);
  }, {passive:true});
  
  if (window.visualViewport){
    visualViewport.addEventListener('resize', ()=>{
      if (pageTip.style.display==='block'){
        const currentLeft = parseFloat(pageTip.style.left || 0);
        const currentTop = parseFloat(pageTip.style.top || 0);
        
        const zoom = visualViewport.scale || 1;
        const k = 1 / zoom;
        
        const isMobile = window.innerWidth <= 640;
        const vw = visualViewport.width;
        const vh = visualViewport.height;
        
        pageTip.style.transform = `scale(${k})`;
        pageTip.style.transformOrigin = 'top left';
        
        const vw2 = visualViewport.width;
        const vh2 = visualViewport.height;
        const baseMaxWidth = isMobile ? Math.min(220, vw2 - 30) : Math.min(280, vw2 - 40);
        pageTip.style.maxWidth = baseMaxWidth + 'px';
        
        requestAnimationFrame(() => {
          const pad = isMobile ? 8 : 12;
          const r = pageTip.getBoundingClientRect();
          
          let left = Math.min(currentLeft, vw2 - r.width - pad);
          let top = Math.min(currentTop, vh2 - r.height - pad);
          left = Math.max(pad, left);
          top = Math.max(pad, top);
          
          pageTip.style.left = left + 'px';
          pageTip.style.top = top + 'px';
        });
      }
    }, {passive:true});
  }
}

/* restaurant page */
function renderRestaurant(){
  renderTopbar();
  const root=document.getElementById('root');
  const rs=state.restaurant||{}; state.ack=false;

  root.innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;flex-wrap:wrap;gap:10px">
      <h1 style="margin:0">${esc(rs.name||'Restaurant')}</h1>
      ${state.canEdit?`<button class="btn btnPrimary" id="mgrEdit">Manager Edit</button>`:''}
    </div>
    <div class="pill">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;flex-wrap:wrap;gap:8px">
        <div style="font-weight:600">${(state.qr||!state.user?.loggedIn)?'Select your allergies':'Your saved allergies'}</div>
        ${(!state.qr && state.user?.loggedIn)?`<button class="btn clickable" id="editSavedBtn">Edit saved allergens</button>`:''}
      </div>
      <div id="savedChips"></div>
    </div>
    <div class="banner">
      <span>Reference only. Ingredients & practices can change. Always inform staff about your allergies.</span>
      <button class="ackBtn off" id="ackBtn">I understand</button>
    </div>
    <div id="legendRow" style="display:none" class="legend">
      <span><span class="key ok"></span> Free of selected allergen(s)</span>
      <span><span class="key warn"></span> Allergen(s) can be accommodated</span>
      <span><span class="key bad"></span> Allergen(s) not accommodated</span>
      <span><span style="display:inline-flex;align-items:center;justify-content:center;width:14px;height:14px;background:#facc15;border:2px solid #facc15;border-radius:50%;font-size:9px;vertical-align:middle;color:#000;font-weight:bold;margin-right:4px;">⚠</span>Cross-contamination risk</span>
      <span class="note">👆 Hover or tap a box for details</span>
    </div>
    <div id="confirmedRow" style="display:none" class="note">Last confirmed by staff: ${rs.lastConfirmed?esc(fmtDate(rs.lastConfirmed)):'—'}</div>
    <div class="mobileMenuNotice" id="mobileMenuNotice" aria-hidden="true" style="display:none">
      <div class="mobileMenuNoticeText">Open the menu in full screen for zoom controls.</div>
      <button class="btn btnPrimary mobileMenuOpenBtn" type="button">Open menu full screen</button>
    </div>
    <div class="menuWrap" id="menu"></div>
  `;

  const chipsHost=document.getElementById('savedChips');
  if(state.qr||!state.user?.loggedIn) renderSelector(chipsHost); else renderSavedChips(chipsHost);

  const menu=document.getElementById('menu');
  ensureMobileInfoPanel();
  mobileInfoPanel.classList.remove('show');
  mobileInfoPanel.innerHTML='';
  document.getElementById('ackBtn').onclick=()=>{
    if(!state.ack){send({type:'ack'}); state.ack=true;}
    const b=document.getElementById('ackBtn'); b.textContent='Acknowledged'; b.classList.remove('off'); b.classList.add('on');
    menu.classList.add('show');
    document.getElementById('legendRow').style.display='flex';
    document.getElementById('confirmedRow').style.display='block';
    drawMenu(menu, rs.menuImage);
    const hasMenuImage=!!rs.menuImage;
    if(hasMenuImage){
      ensureMobileViewerChrome();
      updateZoomIndicator();
      const notice=document.getElementById('mobileMenuNotice');
      if(notice){
        notice.style.display='flex';
        notice.setAttribute('aria-hidden','false');
        notice.dataset.enabled='1';
        const openBtn=notice.querySelector('.mobileMenuOpenBtn');
        if(openBtn){
          if(!openBtn.__openHandler){
            const handler=(e)=>{
              if(e && typeof e.preventDefault==='function') e.preventDefault();
              if(e && typeof e.stopPropagation==='function') e.stopPropagation();
              openMobileViewer();
            };
            openBtn.__openHandler=handler;
            openBtn.addEventListener('click', handler);
          }
        }
      }
    } else {
      const notice=document.getElementById('mobileMenuNotice');
      if(notice){
        notice.style.display='none';
        notice.setAttribute('aria-hidden','true');
        delete notice.dataset.enabled;
        const openBtn=notice.querySelector('.mobileMenuOpenBtn');
        if(openBtn && openBtn.__openHandler){
          openBtn.removeEventListener('click', openBtn.__openHandler);
          delete openBtn.__openHandler;
        }
      }
    }
    if(mobileInfoPanel){
      mobileInfoPanel.classList.remove('show');
      mobileInfoPanel.innerHTML='';
      currentMobileInfoItem=null;
    }
    if((state.qr || urlQR) && !state.user?.loggedIn && shouldShowQrPromo()){
      queueQrPromoTimer();
    } else {
      cancelQrPromoTimer();
    }
  };

  if((state.qr || urlQR) && !state.user?.loggedIn){
    if(!shouldShowQrPromo() && shouldShowQrBanner()){
      showQrBanner();
    } else if(!shouldShowQrBanner()){
      hideQrBanner();
    }
  } else {
    hideQrBanner();
  }

  if(!state.qr && state.user?.loggedIn){
    const editBtn=document.getElementById('editSavedBtn');
    if(editBtn) editBtn.onclick=()=>send({type:'navigate',to:'/accounts',slug:rs.slug});
  }

  if(state.canEdit){
    const mgr=document.getElementById('mgrEdit');
    if(mgr) mgr.onclick=()=>{state.page='editor'; renderEditor();};
  }
}

/* editor */
function renderEditor(){
  renderTopbar();
  const rs=state.restaurant||{};
  const root=document.getElementById('root');
  root.innerHTML=`
    <h1>${esc(rs.name||'Restaurant')} — Menu Editor</h1>
    <div class="mgrRow" style="justify-content:space-between">
      <button class="btn" id="backBtn">← Done</button>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button class="btn" id="viewLogBtn">📋 View log of changes</button>
        <button class="btn btnDanger" id="confirmBtn">Confirm allergen information is up-to-date</button>
        <button class="btn" id="addBox">Add overlay</button>
        <div class="saveRow" id="saveRow"><button class="btn btnPrimary" id="saveBtn">Save to site</button></div>
      </div>
    </div>
    <div class="note" id="lastConfirmedText" style="text-align:right;font-size:12px;margin-top:4px">Last confirmed: ${rs.lastConfirmed?esc(fmtDateTime(rs.lastConfirmed)):'Never'}</div>
    <div class="note" style="margin-bottom:8px">Drag to move. Drag any corner to resize. Click ✏️ to edit details.</div>
    <div class="menuWrap show" id="menu"></div>
  `;
  const menu=document.getElementById('menu');
  const inner=div('','menuInner'); menu.appendChild(inner);
  const img=new Image(); img.src=rs.menuImage||''; img.className='menuImg'; inner.appendChild(img);

  const overlays=JSON.parse(JSON.stringify(rs.overlays||[]));
  let dirty=false; function setDirty(v=true){dirty=v; document.getElementById('saveRow').style.display=dirty?'block':'none';}

  // Track all changes as they happen
  let pendingChanges=[];

  const saveBtn=document.getElementById('saveBtn');
  function setSaveState(s){
    if(!saveBtn)return;
    if(s==='saving'){saveBtn.disabled=true;saveBtn.textContent='Saving…';saveBtn.classList.remove('btnSuccess','btnDanger','btnPrimary');saveBtn.classList.add('btn');}
    else if(s==='saved'){saveBtn.disabled=true;saveBtn.textContent='Saved';saveBtn.classList.remove('btn','btnDanger','btnPrimary');saveBtn.classList.add('btnSuccess');
      setTimeout(()=>{saveBtn.disabled=false;saveBtn.textContent='Save to site';saveBtn.classList.remove('btnSuccess','btnDanger');saveBtn.classList.add('btnPrimary');pendingChanges=[];},900);}
    else if(s==='error'){saveBtn.disabled=false;saveBtn.textContent='Retry save';saveBtn.classList.remove('btnSuccess','btnPrimary');saveBtn.classList.add('btnDanger');}
  }
  function formatChangesForLog(changesList){
    const firstName=state.user?.user_metadata?.first_name||'';
    const lastName=state.user?.user_metadata?.last_name||'';
    let fullName=`${firstName} ${lastName}`.trim();
    if(!fullName) fullName=(state.user?.name||'').trim();
    if(!fullName) fullName=(state.user?.email||'').trim();
    if(!fullName) fullName='User';

    const grouped={};
    const generalChanges=[];

    (changesList||[]).forEach(change=>{
      if(typeof change!=='string') return;
      const colonIndex=change.indexOf(':');
      if(colonIndex>0){
        const itemName=change.substring(0,colonIndex).trim();
        const itemChange=change.substring(colonIndex+1).trim();
        if(!grouped[itemName]) grouped[itemName]=[];
        if(itemChange) grouped[itemName].push(itemChange);
      } else if(change.trim()){
        generalChanges.push(change.trim());
      }
    });

    return {
      author: fullName,
      general: generalChanges,
      items: grouped
    };
  }

  if(saveBtn){
    const originalOverlays=JSON.stringify(rs.overlays||[]);
    saveBtn.onclick=()=>{
      setSaveState('saving');
      let changesList=[];
      if(pendingChanges.length>0){
        changesList=[...pendingChanges];
      } else {
        changesList=describeOverlayChanges(JSON.parse(originalOverlays),overlays);
      }
      if(!changesList.length){
        setSaveState('saved');
        return;
      }
      const formattedChanges=formatChangesForLog(changesList);
      send({type:'saveOverlays',overlays,menuImage:rs.menuImage||'',changes:formattedChanges});
    };
  }
  
  function describeOverlayChanges(oldOverlays,newOverlays){
    const changes=[];
    const oldList=Array.isArray(oldOverlays)?oldOverlays:[];
    const newList=Array.isArray(newOverlays)?newOverlays:[];
    const oldById=new Map(oldList.filter(o=>o&&o.id).map(o=>[o.id,o]));
    const newById=new Map(newList.filter(o=>o&&o.id).map(o=>[o.id,o]));
    const renamedPairs=[];

    newList.forEach((item,idx)=>{
      if(!item) return;
      const itemName=item.id||'Item';
      const old=oldList[idx];
      if(old && old.id && item.id && old.id!==item.id){
        renamedPairs.push({from:old.id,to:item.id});
        changes.push(`Renamed "${old.id}" to "${item.id}"`);
      }
      if(old){
        const oldAllergens=new Set((old.allergens||[]).map(norm));
        const newAllergens=new Set((item.allergens||[]).map(norm));
        const added=[...newAllergens].filter(a=>!oldAllergens.has(a));
        const removed=[...oldAllergens].filter(a=>!newAllergens.has(a));
        if(added.length){
          const allergenWord=added.length===1?'allergen':'allergens';
          changes.push(`${itemName}: Added ${allergenWord} ${added.join(', ')}`);
        }
        if(removed.length){
          const allergenWord=removed.length===1?'allergen':'allergens';
          changes.push(`${itemName}: Removed ${allergenWord} ${removed.join(', ')}`);
        }
        const moved=old.x!==item.x || old.y!==item.y || old.w!==item.w || old.h!==item.h;
        if(moved){
          changes.push(`${itemName}: Adjusted overlay position`);
        }
      }
    });

    const renamedNewIds=new Set(renamedPairs.map(p=>p.to));
    const renamedOldIds=new Set(renamedPairs.map(p=>p.from));

    newList.forEach(item=>{
      if(!item || !item.id) return;
      if(renamedNewIds.has(item.id)) return;
      if(!oldById.has(item.id)){
        const itemName=item.id||'Item';
        changes.push(`${itemName}: Added overlay`);
      }
    });

    oldList.forEach(item=>{
      if(!item || !item.id) return;
      if(renamedOldIds.has(item.id)) return;
      if(!newById.has(item.id)){
        const itemName=item.id||'Item';
        changes.push(`${itemName}: Removed overlay`);
      }
    });

    return changes;
  }

  const confirmBtn=document.getElementById('confirmBtn');
  if(confirmBtn){confirmBtn.onclick=()=>{openPhotoCapture();};}
  
  const viewLogBtn=document.getElementById('viewLogBtn');
  if(viewLogBtn){viewLogBtn.onclick=()=>{openChangeLog();};}
  
  function updateLastConfirmedText(){
    const lastConfirmedText=document.getElementById('lastConfirmedText');
    if(lastConfirmedText){
      const now=new Date();
      lastConfirmedText.textContent='Last confirmed: '+fmtDateTime(now);
    }
  }
  
  function openPhotoCapture(){
    const mb=document.getElementById('modalBack');
    const body=document.getElementById('modalBody');
    document.getElementById('modalTitle').textContent='Confirm Allergen Information';
    
    body.innerHTML=`
      <div class="photoCapture">
        <div class="note" style="text-align:center;margin-bottom:8px">Take photos of your current menu to confirm that it aligns with the menu on CLE Allergy Aware</div>
        <video id="videoStream" class="videoPreview" autoplay playsinline style="display:none"></video>
        <canvas id="photoCanvas" style="display:none"></canvas>
        <div id="photosContainer" style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:12px"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
          <button class="btn btnPrimary" id="startCameraBtn">📷 Take Photo</button>
          <button class="btn btnPrimary" id="takePictureBtn" style="display:none">📸 Capture</button>
          <input type="file" id="fileInput" accept="image/*" capture="environment" style="display:none" multiple>
          <button class="btn" id="uploadBtn">📁 Upload Photos</button>
          <button class="btn btnSuccess" id="doneAddingBtn" style="display:none">Done adding photos</button>
        </div>
        <div id="confirmSection" style="display:none;width:100%;text-align:center">
          <div class="note" style="margin:12px 0 8px">Are all dishes clearly visible in these photos?</div>
          <div style="display:flex;gap:8px;justify-content:center;margin-bottom:12px">
            <button class="btn btnSuccess" id="yesVisibleBtn">✓ Yes</button>
            <button class="btn btnDanger" id="noVisibleBtn">✗ No</button>
          </div>
        </div>
        <div id="menuConfirmSection" style="display:none;width:100%;text-align:center">
          <div class="note" style="margin:12px 0 8px">Are these photos of your most current menu?</div>
          <div style="display:flex;gap:8px;justify-content:center">
            <button class="btn btnSuccess" id="confirmPhotoBtn">✓ Yes, confirm</button>
            <button class="btn btnDanger" id="cancelPhotoBtn">✗ Cancel</button>
          </div>
        </div>
      </div>
    `;
    
    mb.style.display='flex';
    configureModalClose({visible:true,onClick:()=>{
      mb.style.display='none';
      if(stream){
        stream.getTracks().forEach(track=>track.stop());
        stream=null;
      }
    }});
    
    let stream=null;
    let photoDataArray=[];

    function renderPhotos(){
      const container=document.getElementById('photosContainer');
      container.innerHTML='';
      photoDataArray.forEach((photoData,idx)=>{
        const wrapper=document.createElement('div');
        wrapper.style.cssText='position:relative;display:inline-block';
        const img=document.createElement('img');
        img.src=photoData;
        img.style.cssText='max-width:120px;max-height:80px;object-fit:cover;border-radius:6px;border:1px solid #2a3466;cursor:pointer';
        img.onclick=()=>window.showPhotoPreview(photoData);
        const removeBtn=document.createElement('button');
        removeBtn.textContent='×';
        removeBtn.className='btn btnDanger';
        removeBtn.style.cssText='position:absolute;top:-8px;right:-8px;width:24px;height:24px;padding:0;min-width:24px;border-radius:50%;font-size:16px;line-height:1';
        removeBtn.onclick=(e)=>{e.stopPropagation();photoDataArray.splice(idx,1);renderPhotos();updateButtonStates();};
        wrapper.appendChild(img);
        wrapper.appendChild(removeBtn);
        container.appendChild(wrapper);
      });
    }

    function updateButtonStates(){
      const doneBtn=document.getElementById('doneAddingBtn');
      const confirmSection=document.getElementById('confirmSection');
      if(photoDataArray.length>0){
        doneBtn.style.display='inline-flex';
      }else{
        doneBtn.style.display='none';
        confirmSection.style.display='none';
        document.getElementById('menuConfirmSection').style.display='none';
      }
    }
    
    document.getElementById('startCameraBtn').onclick=async()=>{
      try{
        if(!stream){
          stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
          const video=document.getElementById('videoStream');
          video.srcObject=stream;
        }
        document.getElementById('videoStream').style.display='block';
        document.getElementById('startCameraBtn').textContent='📷 Take another';
        document.getElementById('takePictureBtn').style.display='inline-flex';
      }catch(err){
        alert('Camera access denied or not available. Please use the upload option.');
      }
    };
    
    document.getElementById('takePictureBtn').onclick=()=>{
      const video=document.getElementById('videoStream');
      const canvas=document.getElementById('photoCanvas');
      const ctx=canvas.getContext('2d');

      const maxWidth = 600;
      const scale = Math.min(1, maxWidth / video.videoWidth);
      canvas.width = video.videoWidth * scale;
      canvas.height = video.videoHeight * scale;

      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const photoData = canvas.toDataURL('image/jpeg', 0.6);

      console.log('Photo captured, size:', photoData.length, 'bytes');

      photoDataArray.push(photoData);
      renderPhotos();
      updateButtonStates();

      video.style.display='none';
      document.getElementById('takePictureBtn').style.display='none';
      document.getElementById('startCameraBtn').style.display='inline-flex';
    };
    
    document.getElementById('doneAddingBtn').onclick=()=>{
      if(photoDataArray.length===0){
        alert('Please add at least one photo.');
        return;
      }
      if(stream){
        stream.getTracks().forEach(track=>track.stop());
        stream=null;
      }
      document.getElementById('videoStream').style.display='none';
      document.getElementById('startCameraBtn').style.display='inline-flex';
      document.getElementById('takePictureBtn').style.display='none';
      document.getElementById('confirmSection').style.display='block';
    };
    
    document.getElementById('uploadBtn').onclick=()=>{
      document.getElementById('fileInput').click();
    };
    
    document.getElementById('fileInput').onchange=(e)=>{
      const files=Array.from(e.target.files);
      let processed=0;

      files.forEach(file=>{
        const reader=new FileReader();
        reader.onload=(ev)=>{
          const img = new Image();
          img.onload = () => {
            const canvas = document.getElementById('photoCanvas');
            const ctx = canvas.getContext('2d');

            const maxWidth = 600;
            const scale = Math.min(1, maxWidth / img.width);
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;

            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            const photoData = canvas.toDataURL('image/jpeg', 0.6);

            console.log('Photo uploaded, size:', photoData.length, 'bytes');

            photoDataArray.push(photoData);
            processed++;

            if(processed===files.length){
              renderPhotos();
              updateButtonStates();
            }
          };
          img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
      });

      e.target.value='';
    };
    
    document.getElementById('yesVisibleBtn').onclick=()=>{
      document.getElementById('confirmSection').style.display='none';
      document.getElementById('menuConfirmSection').style.display='block';
    };

    document.getElementById('noVisibleBtn').onclick=()=>{
      photoDataArray=[];
      renderPhotos();
      updateButtonStates();
      document.getElementById('confirmSection').style.display='none';
      document.getElementById('menuConfirmSection').style.display='none';
      document.getElementById('startCameraBtn').textContent='📷 Take Photo';
    };

    document.getElementById('confirmPhotoBtn').onclick=()=>{
      if(photoDataArray.length>0){
        send({type:'confirmAllergens',photos:photoDataArray,timestamp:new Date().toISOString()});
        const confirmBtn=document.querySelectorAll('.btn.btnDanger')[0];
        if(confirmBtn){
          confirmBtn.textContent='Allergy information confirmed';
          confirmBtn.classList.remove('btnDanger');
          confirmBtn.classList.add('btnSuccess');
        }
        updateLastConfirmedText();
        mb.style.display='none';
        if(stream){
          stream.getTracks().forEach(track=>track.stop());
        }
      }
    };

    document.getElementById('cancelPhotoBtn').onclick=()=>{
      mb.style.display='none';
      if(stream){
        stream.getTracks().forEach(track=>track.stop());
      }
    };
  }
  
  function openChangeLog(){
    const mb=document.getElementById('modalBack');
    const body=document.getElementById('modalBody');
    document.getElementById('modalTitle').textContent='Change Log - '+esc(rs.name||'Restaurant');
    configureModalClose({visible:true,onClick:()=>{mb.style.display='none'; mb.onclick=null;}});
    
    send({type:'getChangeLog',restaurantId:rs._id||rs.id||null});
    
    body.innerHTML=`
      <div class="note" style="margin-bottom:12px">Loading change log...</div>
    `;
    
    mb.style.display='flex';
    
    // Add click handler to close modal when clicking outside
    mb.onclick=(e)=>{
      if(e.target===mb){
        mb.style.display='none';
        mb.onclick=null;
      }
    };
  }
  
  window.displayChangeLog=(logs,errorMsg)=>{
    const body=document.getElementById('modalBody');
    if(errorMsg){
      body.innerHTML=`
        <div class="note" style="color:var(--bad);">${esc(errorMsg)}</div>
        <div style="margin-top:12px;text-align:center">
          <button class="btn" onclick="document.getElementById('modalBack').style.display='none'">Close</button>
        </div>`;
      return;
    }
    const restaurantId = state.restaurant?._id || state.restaurant?.id || null;
    if(Array.isArray(logs) && restaurantId){
      logs = logs.filter(log=>log.restaurantId===restaurantId || log.restaurant_id===restaurantId);
    }
    if(!logs||!logs.length){
      body.innerHTML=`
        <div class="note">No changes recorded yet.</div>
        <div style="margin-top:12px;text-align:center">
          <button class="btn" onclick="document.getElementById('modalBack').style.display='none'">Close</button>
        </div>`;
      return;
    }
    
    let html='';
    logs.forEach(log=>{
      const typeLabel=log.type==='confirm'?'Allergen Confirmation':'Allergen Update';
      const typeClass=log.type==='confirm'?'confirm':'update';

      html+=`<div class="logEntry">
        <div class="logHeader">
          <span class="logType ${typeClass}">${esc(typeLabel)}</span>
          <span class="logTimestamp">${esc(fmtDateTime(log.timestamp))}</span>
        </div>`;
      const parsedChanges = (()=>{
        if(!log.changes) return null;
        if(typeof log.changes==='object') return log.changes;
        if(typeof log.changes==='string'){
          try{return JSON.parse(log.changes);}catch(_){return null;}
        }
        return null;
      })();

      if(parsedChanges && (Object.keys(parsedChanges.items||{}).length || (parsedChanges.general||[]).length)){
        let authorName=parsedChanges.author || log.description || '';
        if(authorName.includes(':')) authorName=authorName.split(':')[0];
        if(authorName){
          html+=`<div class="logAuthor">${esc(authorName)}</div>`;
        }
        if(Array.isArray(parsedChanges.general) && parsedChanges.general.length){
          html+=`<ul class="logList">${parsedChanges.general.map(item=>`<li>${esc(item)}</li>`).join('')}</ul>`;
        }
        Object.entries(parsedChanges.items||{}).forEach(([itemName,entries])=>{
          html+=`<div class="logItem">${esc(itemName)}</div>`;
          if(Array.isArray(entries) && entries.length){
            html+=`<ul class="logList">${entries.map(entry=>`<li>${esc(entry)}</li>`).join('')}</ul>`;
          }
        });
      } else {
        let authorLine = log.description || (parsedChanges && parsedChanges.author);
        if(authorLine && authorLine.includes(':')) authorLine=authorLine.split(':')[0];
        if(authorLine){
          html+=`<div class="logAuthor">${esc(authorLine)}</div>`;
        }
        if(log.changes){
          let changesHtml=esc(typeof log.changes==='string'?log.changes:JSON.stringify(log.changes));
          changesHtml=changesHtml.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>');
          changesHtml=changesHtml.replace(/\n/g,'<br>');
          html+=`<div class="note" style="margin-top:8px;font-size:13px;line-height:1.6">${changesHtml}</div>`;
        }
      }
      // Display photos if present (stored as array in database)
      const photos = log.photos || [];
      if(Array.isArray(photos) && photos.length > 0){
        photos.forEach(photoUrl => {
          const photoEsc=esc(photoUrl).replace(/'/g,'&#39;');
          html+=`<img src="${esc(photoUrl)}" class="logThumbnail" onclick="window.showPhotoPreview('${photoEsc}')" alt="Confirmation photo">`;
        });
      }
      html+=`</div>`;
    });
    
    html+=`<div style="margin-top:12px;text-align:center">
      <button class="btn" onclick="document.getElementById('modalBack').style.display='none'">Close</button>
    </div>`;
    
    body.innerHTML=html;
  };
  
  window.showPhotoPreview=(photoUrl)=>{
    const modal=document.getElementById('photoModal');
    const img=document.getElementById('photoModalImage');
    img.src=photoUrl;
    modal.style.display='flex';
  };
  
  document.getElementById('photoModalClose').onclick=()=>{
    document.getElementById('photoModal').style.display='none';
  };
  
  document.getElementById('photoModal').onclick=(e)=>{
    if(e.target.id==='photoModal'){
      document.getElementById('photoModal').style.display='none';
    }
  };

  function drawAll(){
    [...inner.querySelectorAll('.editBox')].forEach(n=>n.remove());
    const iw=img.clientWidth, ih=img.clientHeight;

    overlays.forEach((it,idx)=>{
      const box=document.createElement('div'); box.className='editBox';
      Object.assign(box.style,{left:(+it.x)+'%',top:(+it.y)+'%',width:(+it.w)+'%',height:(+it.h)+'%'});

      ['nw','ne','sw','se'].forEach(c=>{const h=document.createElement('div'); h.className='handle '+c; box.appendChild(h); h.addEventListener('pointerdown',(e)=>startResize(e,c));});

      const eb=document.createElement('div'); eb.className='editBadge'; eb.title='Edit this item'; eb.innerHTML='✏️';
      eb.addEventListener('click',(e)=>{e.stopPropagation();openItemEditor(it,idx);}); box.appendChild(eb);

      let dragging=false,start={};
      box.addEventListener('pointerdown',(e)=>{ if(e.target.classList.contains('handle')||e.target===eb) return;
        dragging=true; box.setPointerCapture(e.pointerId);
        start={x:e.clientX,y:e.clientY,l:box.offsetLeft,t:box.offsetTop,w:box.offsetWidth,h:box.offsetHeight};});
      box.addEventListener('pointermove',(e)=>{ if(!dragging) return;
        const nx=Math.max(0,Math.min(iw-start.w,start.l+(e.clientX-start.x)));
        const ny=Math.max(0,Math.min(ih-start.h,start.t+(e.clientY-start.y)));
        const xPct=nx/iw*100,yPct=ny/ih*100; it.x=xPct; it.y=yPct; box.style.left=xPct+'%'; box.style.top=yPct+'%';});
      box.addEventListener('pointerup',()=>{ if(dragging){dragging=false; setDirty(true);} });

      function startResize(e,corner){
        e.stopPropagation(); e.preventDefault(); box.setPointerCapture(e.pointerId);
        const rect=inner.getBoundingClientRect(); const st={x:e.clientX,y:e.clientY,left:+it.x,top:+it.y,w:+it.w,h:+it.h};
        const snapThreshold=0.8;
        
        function getSnapTargets(){
          const targets={xEdges:[],yEdges:[]};
          overlays.forEach((other,otherIdx)=>{
            if(otherIdx===idx) return;
            targets.xEdges.push(+other.x);
            targets.xEdges.push(+other.x + +other.w);
            targets.yEdges.push(+other.y);
            targets.yEdges.push(+other.y + +other.h);
          });
          return targets;
        }
        
        function snapValue(val,edges,threshold){
          for(const edge of edges){
            if(Math.abs(val-edge)<threshold) return edge;
          }
          return val;
        }
        
        function onMove(ev){
          const dx=(ev.clientX-st.x)/rect.width*100, dy=(ev.clientY-st.y)/rect.height*100;
          let x=st.left,y=st.top,w=st.w,h=st.h;
          
          if(corner==='se'){w=st.w+dx;h=st.h+dy;}
          if(corner==='ne'){w=st.w+dx;h=st.h-dy;y=st.top+dy;}
          if(corner==='sw'){w=st.w-dx;h=st.h+dy;x=st.left+dx;}
          if(corner==='nw'){w=st.w-dx;h=st.h-dy;x=st.left+dx;y=st.top+dy;}
          
          w=Math.max(3,Math.min(100,w)); 
          h=Math.max(2,Math.min(100,h));
          x=Math.max(0,Math.min(100-w,x)); 
          y=Math.max(0,Math.min(100-h,y));
          
          const snapTargets=getSnapTargets();
          const right=x+w;
          const bottom=y+h;
          
          if(corner==='se'){
            const snappedRight=snapValue(right,snapTargets.xEdges,snapThreshold);
            const snappedBottom=snapValue(bottom,snapTargets.yEdges,snapThreshold);
            if(snappedRight!==right) w=Math.max(3,snappedRight-x);
            if(snappedBottom!==bottom) h=Math.max(2,snappedBottom-y);
          }
          else if(corner==='ne'){
            const snappedRight=snapValue(right,snapTargets.xEdges,snapThreshold);
            const snappedTop=snapValue(y,snapTargets.yEdges,snapThreshold);
            if(snappedRight!==right) w=Math.max(3,snappedRight-x);
            if(snappedTop!==y){
              const oldBottom=y+h;
              y=snappedTop;
              h=Math.max(2,oldBottom-y);
            }
          }
          else if(corner==='sw'){
            const snappedLeft=snapValue(x,snapTargets.xEdges,snapThreshold);
            const snappedBottom=snapValue(bottom,snapTargets.yEdges,snapThreshold);
            if(snappedLeft!==x){
              const oldRight=x+w;
              x=snappedLeft;
              w=Math.max(3,oldRight-x);
            }
            if(snappedBottom!==bottom) h=Math.max(2,snappedBottom-y);
          }
          else if(corner==='nw'){
            const snappedLeft=snapValue(x,snapTargets.xEdges,snapThreshold);
            const snappedTop=snapValue(y,snapTargets.yEdges,snapThreshold);
            if(snappedLeft!==x){
              const oldRight=x+w;
              x=snappedLeft;
              w=Math.max(3,oldRight-x);
            }
            if(snappedTop!==y){
              const oldBottom=y+h;
              y=snappedTop;
              h=Math.max(2,oldBottom-y);
            }
          }
          
          w=Math.max(3,Math.min(100,w)); 
          h=Math.max(2,Math.min(100,h));
          x=Math.max(0,Math.min(100-w,x)); 
          y=Math.max(0,Math.min(100-h,y));
          
          it.x=x; it.y=y; it.w=w; it.h=h;
          box.style.left=x+'%'; box.style.top=y+'%'; box.style.width=w+'%'; box.style.height=h+'%';
        }
        function onUp(ev){ box.releasePointerCapture(ev.pointerId); document.removeEventListener('pointermove',onMove); document.removeEventListener('pointerup',onUp); setDirty(true); }
        document.addEventListener('pointermove',onMove); document.addEventListener('pointerup',onUp);
      }

      box.addEventListener('click',(e)=>{e.preventDefault(); e.stopPropagation();});
      inner.appendChild(box);
    });
  }

  img.onload=drawAll; if(img.complete) drawAll();
  document.getElementById('addBox').onclick=()=>{
    const newOverlay={id:'New item',x:10,y:10,w:20,h:8,allergens:[],removable:[],crossContamination:[],details:{}};
    overlays.push(newOverlay);
    pendingChanges.push(`${newOverlay.id}: Added overlay`);
    drawAll();
    setDirty(true);
  };
  document.getElementById('backBtn').onclick=()=>{
    if(dirty){
      const oldTitle=document.title;
      document.title='CLE Allergy Aware';
      const result=confirm('You have unsaved changes. Do you want to save before exiting?');
      document.title=oldTitle;
      if(result){
        setSaveState('saving');
        // Use pendingChanges if available, otherwise fall back to comparison
        let changesList=[];
        if(pendingChanges.length>0){
          changesList=[...pendingChanges];
        } else {
          const originalOverlays=JSON.stringify(rs.overlays||[]);
          changesList=describeOverlayChanges(JSON.parse(originalOverlays),overlays);
        }
        if(changesList.length){
          const formattedChanges=formatChangesForLog(changesList);
          send({type:'saveOverlays',overlays,menuImage:rs.menuImage||'',changes:formattedChanges});
          setTimeout(()=>{state.page='restaurant'; renderRestaurant();},500);
        } else {
          state.page='restaurant'; renderRestaurant();
        }
      } else {
        state.page='restaurant'; renderRestaurant();
      }
    } else {
      state.page='restaurant'; renderRestaurant();
    }
  };

  const mb=document.getElementById('modalBack');
  function openItemEditor(it,idx){
    configureModalClose({visible:false});
    if(mb) mb.onclick=null;
    const body=document.getElementById('modalBody'); document.getElementById('modalTitle').textContent='Edit item';
    body.innerHTML=`<div class="algRow" style="grid-template-columns:1fr">
        <input id="itemName" class="algInput" style="font-weight:700" placeholder="Item name" value="${esc(it.id||'')}">
      </div><div id="algList"></div>
      <div class="note" style="margin:8px 0 4px">Live preview (assumes the user is allergic to everything)</div>
      <div id="previewBox" style="border:1px solid #2a3466;border-radius:10px;padding:10px"></div>
      <div class="editorActionRow" style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
        <button class="btn btnPrimary" id="doneBtn">Done</button>
        <button class="btn btnDanger" id="delBtn">Delete overlay</button>
        <button class="btn" id="aiAssistBtn" type="button">AI ingredient helper</button>
      </div>`;
    const list=document.getElementById('algList');
    if(list){
      list.dataset.aiIngredients='';
      list.dataset.aiIngredientSummary='';
    }
    const sel=new Set(it.allergens||[]); 
    const details=it.details||{}; 
    const rem=new Map((it.removable||[]).map(r=>[r.allergen,r.component]));
    const cross=new Set(it.crossContamination||[]);
    
    ALLERGENS.forEach(a=>{
      const row=document.createElement('div'); row.className='algRow';
      const b=document.createElement('div'); b.className='algBtn'; b.textContent=cap(a); b.dataset.a=a; if(sel.has(a)) b.classList.add('active');
      const inp=document.createElement('input'); inp.className='algInput'; inp.placeholder='Which part of the dish contains the allergen?'; inp.value=details[a]||'';
      const lab=document.createElement('label'); lab.className='algChk'; const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=rem.has(a); lab.appendChild(cb); lab.appendChild(document.createTextNode('can be accommodated'));
      const labCross=document.createElement('label'); labCross.className='algChk'; const cbCross=document.createElement('input'); cbCross.type='checkbox'; cbCross.checked=cross.has(a); labCross.appendChild(cbCross); labCross.appendChild(document.createTextNode('cross-contamination risk'));
      
      function reflect(){
        const on=b.classList.contains('active'); 
        inp.style.display=on?'block':'none'; 
        lab.style.display=on?'flex':'none'; 
        labCross.style.display='flex';
        updatePreview();
      }
      b.onclick=()=>{b.classList.toggle('active'); reflect();}; 
      cb.onchange=updatePreview; 
      cbCross.onchange=updatePreview;
      inp.oninput=updatePreview;
      row.appendChild(b); row.appendChild(inp); row.appendChild(lab); row.appendChild(labCross); list.appendChild(row); reflect();
    });
    
    function updatePreview(){
      const tmp={id:(document.getElementById('itemName').value||it.id||'Item'),allergens:[],removable:[],crossContamination:[],details:{}};
      list.querySelectorAll('.algRow').forEach(row=>{
        const a=row.querySelector('.algBtn').dataset.a;
        const on=row.querySelector('.algBtn').classList.contains('active');
        const txt=row.querySelector('.algInput').value.trim();
        const checkboxes=row.querySelectorAll('input[type="checkbox"]');
        const isRem=checkboxes[0].checked;
        const isCross=checkboxes[1].checked;
        if(on){tmp.allergens.push(a); if(txt) tmp.details[a]=txt; if(isRem) tmp.removable.push({allergen:a,component:txt||a});}
        if(isCross){tmp.crossContamination.push(a);}
      });
      document.getElementById('previewBox').innerHTML=tooltipBodyHTML(tmp,ALLERGENS.slice());
    }
    updatePreview();
    
    function applyIngredientsFromAi(rows){
    if(!Array.isArray(rows) || !rows.length){
      aiAssistSetStatus('No ingredients to apply.', 'warn');
      return;
    }
      if(list){
        list.dataset.aiIngredients = JSON.stringify(rows);
      }
      const allergenDetailsMap={};
      const activeAllergens=new Set();
      const aggregatedIngredientNames=[];
      rows.forEach(row=>{
        const allergens=Array.isArray(row.allergens)?row.allergens:[];
        const name=(row.name||'').trim();
        const brand=(row.brand||'').trim();
        if(Array.isArray(row.ingredientsList) && row.ingredientsList.length){
          aggregatedIngredientNames.push(...row.ingredientsList);
        } else if(name){
          aggregatedIngredientNames.push(brand ? `${cap(name)} (${brand})` : cap(name));
        }
        const label=name?cap(name):'';
        const labelWithBrand=brand ? (label?`${label} (${brand})`:brand) : label;
        allergens.forEach(al=>{
          const key=norm(al);
          if(!key) return;
          activeAllergens.add(key);
          if(labelWithBrand){
            if(!allergenDetailsMap[key]) allergenDetailsMap[key]=[];
            if(!allergenDetailsMap[key].includes(labelWithBrand)){
              allergenDetailsMap[key].push(labelWithBrand);
            }
          }
        });
      });
      if(list){
        const uniqueAggregated=[...new Set(aggregatedIngredientNames.map(item=>(item||'').trim()).filter(Boolean))];
        list.dataset.aiIngredientSummary = JSON.stringify(uniqueAggregated);
      }
      list.querySelectorAll('.algRow').forEach(row=>{
        const btn=row.querySelector('.algBtn');
        const allergen=btn.dataset.a;
        const key=norm(allergen);
        const input=row.querySelector('.algInput');
        const labels=row.querySelectorAll('.algChk');
        const remLabel=labels[0];
        const crossLabel=labels[1];
        const remChk=remLabel?remLabel.querySelector('input'):null;
        const crossChk=crossLabel?crossLabel.querySelector('input'):null;
        const isActive=activeAllergens.has(key);
        btn.classList.toggle('active',isActive);
        if(input){
          if(isActive){
            const explanations=allergenDetailsMap[key]||[];
            input.value=explanations.length?`Contains ${explanations.join(', ')}`:'';
          } else {
            input.value='';
          }
          input.style.display=isActive?'block':'none';
        }
        if(remLabel){
          remLabel.style.display=isActive?'flex':'none';
          if(!isActive && remChk) remChk.checked=false;
        }
        if(crossLabel){
          crossLabel.style.display='flex';
        }
      });
      updatePreview();
      setDirty(true);
      aiAssistSetStatus('Ingredient details applied. Review and save the dish when ready.','success');
    }
    
    const aiAssistBtn=document.getElementById('aiAssistBtn');
    if(aiAssistBtn){
      aiAssistBtn.onclick=()=>{
        const seedText=Object.values(it.details||{}).join('\n');
        openAiAssistant({
          seedText,
          getCurrentName:()=>document.getElementById('itemName').value||it.id||'Item',
          onApply:(rows)=>applyIngredientsFromAi(rows)
        });
      };
    }
    
    document.getElementById('doneBtn').onclick=()=>{
      const oldName=it.id;
      const oldAllergens=new Set(it.allergens||[]);

      const final={allergens:[],removable:[],crossContamination:[],details:{}};
      list.querySelectorAll('.algRow').forEach(row=>{
        const a=row.querySelector('.algBtn').dataset.a;
        const on=row.querySelector('.algBtn').classList.contains('active');
        const txt=row.querySelector('.algInput').value.trim();
        const checkboxes=row.querySelectorAll('input[type="checkbox"]');
        const isRem=checkboxes[0].checked;
        const isCross=checkboxes[1].checked;
        if(on){final.allergens.push(a); if(txt) final.details[a]=txt; if(isRem) final.removable.push({allergen:a,component:txt||a}); }
        if(isCross){final.crossContamination.push(a);}
      });
      if(list && list.dataset.aiIngredientSummary){
        try{
          const rawSummary=JSON.parse(list.dataset.aiIngredientSummary)||[];
          const summary=[...new Set(rawSummary.map(item=>(item||'').trim()).filter(Boolean))];
          if(summary.length){
            final.details.__ingredientsSummary=summary.join(', ');
          } else {
            delete final.details.__ingredientsSummary;
          }
        }catch(_){ delete final.details.__ingredientsSummary; }
      }
      const newName=(document.getElementById('itemName').value||it.id||'Item');

      // Track rename
      if(oldName!==newName){
        pendingChanges.push(`Renamed "${oldName}" to "${newName}"`);
      }

      // Track allergen changes
      const newAllergens=new Set(final.allergens);
      const added=[...newAllergens].filter(a=>!oldAllergens.has(a));
      const removed=[...oldAllergens].filter(a=>!newAllergens.has(a));
      if(added.length){
        const allergenWord=added.length===1?'allergen':'allergens';
        pendingChanges.push(`${newName}: Added ${allergenWord} ${added.join(', ')}`);
      }
      if(removed.length){
        const allergenWord=removed.length===1?'allergen':'allergens';
        pendingChanges.push(`${newName}: Removed ${allergenWord} ${removed.join(', ')}`);
      }

      it.id=newName;
      it.allergens=final.allergens;
      it.details=final.details;
      it.removable=final.removable;
      it.crossContamination=final.crossContamination;
      if(list){
        list.dataset.aiIngredients='';
        list.dataset.aiIngredientSummary='';
      }
      mb.style.display='none'; drawAll(); setDirty(true);
    };
    document.getElementById('delBtn').onclick=()=>{
      if(confirm('Delete this overlay?')){
        pendingChanges.push(`${it.id||'Item'}: Removed overlay`);
        overlays.splice(idx,1);
        mb.style.display='none';
        drawAll();
        setDirty(true);
      }
    };
    mb.style.display='flex';
  }
}

/* report */
function renderReport(){
  renderTopbar();
  const root=document.getElementById('root');
  root.innerHTML=`<h1>Report an issue</h1>
    <div style="max-width:640px">
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin:8px 0">
        <input id="rName" type="text" placeholder="Your name" style="flex:1">
        <input id="rEmail" type="email" placeholder="Email (required)" style="flex:1">
      </div>
      <textarea id="rMsg" rows="6" style="width:100%;border-radius:16px" placeholder="Describe the issue"></textarea>
      <div class="mgrRow" style="justify-content:flex-start"><button class="btn btnPrimary" id="rSend">Send</button></div>
      <div class="note">We require an email so we can follow up if needed.</div>
    </div>`;
  document.getElementById('rSend').onclick=()=>{ 
    const name=(document.getElementById('rName').value||'').trim();
    const email=(document.getElementById('rEmail').value||'').trim();
    const message=(document.getElementById('rMsg').value||'').trim();
    if(!email){alert('Please enter your email.');return;}
    send({type:'sendReport',name,email,message});
  };
}

/* router */
function render(){
  switch(state.page){
    case 'restaurants': return renderCardsPage();
    case 'editor':      return renderEditor();
    case 'report':      return renderReport();
    case 'restaurant':  return renderRestaurant();
    default:            return;
  }
}

/* hydrate */
window.addEventListener('message',(ev)=>{
  const m=ev.data||{};
  if(!state._hydrated){state._hydrated=true; document.body.style.display='';}

  if(m.page){state.page=m.page;}
  if(m.user){state.user=m.user;}
  if(state.user?.loggedIn){closeQrPromo('login'); hideQrBanner();}
  if(m.allergies){state.allergies=m.allergies;}
  if(m.restaurant){state.restaurant=normalizeRestaurant(m.restaurant);}
  if(m.restaurants){state.restaurants=m.restaurants;}
  if(typeof m.canEdit==='boolean'){state.canEdit=m.canEdit;}
  if(typeof m.qr==='boolean'){state.qr=m.qr;} else if(urlQR){state.qr=true;}
  if(m.aiAssistEndpoint){state.aiAssistEndpoint=m.aiAssistEndpoint;}
  if((state.qr||urlQR) && (!state.allergies||!state.allergies.length)){
    try{const s=sessionStorage.getItem('qrAllergies'); if(s) state.allergies=JSON.parse(s)||[];}catch(_){}
  }
  if(m.page==='restaurant'||m.restaurant){state.ack=false;}
  if(m.type==='allergiesSaved'){state.allergies=m.allergies||[];}
  if(m.type==='aiAssistResult'){handleAiAssistantResult(m); return;}
  if(m.type==='aiAssistError'){handleAiAssistantError(m); return;}

  if(m.type==='overlaysSaved'){
    try{setSaveState('saved');}catch(_){ }
    if(m.restaurant) state.restaurant=normalizeRestaurant(m.restaurant) || state.restaurant;
  }
  if(m.type==='saveFailed'){try{setSaveState('error');}catch(_){ }}
  if(m.type==='confirmationSaved'){
    if(m.timestamp && state.restaurant) state.restaurant.lastConfirmed=m.timestamp;
    if(m.restaurant) state.restaurant=normalizeRestaurant(m.restaurant) || state.restaurant;
    try{updateLastConfirmedText();}catch(_){ }
  }
  if(m.type==='confirmationFailed'){
    alert('Could not confirm allergen information. '+(m.message||''));
  }
  if(m.type==='changeLog'){
    try{if(window.displayChangeLog)window.displayChangeLog(m.logs||[], m.error);}catch(_){ }
    return;
  }

  renderTopbar(); render();
  updateFullScreenAllergySummary();
});
</script>
<script type="module" src="js/report-modal.js"></script>
</body>
</html>
