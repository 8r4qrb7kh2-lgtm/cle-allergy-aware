<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>How It Works - Clarivore</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    :root {
      --bg: #0b1020;
      --panel: #111630;
      --ink: #e9ecff;
      --muted: #a8b2d6;
      --brand: #7c9cff;
      --ok: #22c55e;
      --warn: #facc15;
      --bad: #ef4444;
      --border: #2a3261;
      --hover: #4c5ad4;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--bg);
      color: var(--ink);
      overflow-x: hidden;
    }

    .simple-topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(11, 16, 32, 0.95);
      backdrop-filter: blur(10px);
      z-index: 1000;
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
    }

    .simple-topbar-inner {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .simple-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: var(--ink);
      font-weight: 600;
      font-size: 1.1rem;
    }

    .simple-brand img {
      width: 32px;
      height: 32px;
    }

    /* Hero Section */
    .hero-section {
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      background: linear-gradient(135deg, #1e3a5f 0%, #2a5298 100%);
    }

    .hero-title {
      font-size: clamp(2.5rem, 8vw, 6rem);
      font-weight: 700;
      text-align: center;
      padding: 0 20px;
      margin-bottom: 20px;
    }

    .hero-subtitle {
      font-size: clamp(1rem, 3vw, 1.5rem);
      text-align: center;
      padding: 0 20px;
      max-width: 800px;
      color: rgba(255,255,255,0.9);
    }

    .scroll-indicator {
      position: absolute;
      bottom: 40px;
      font-size: 2rem;
      animation: bounce 2s infinite;
      opacity: 0.7;
      cursor: pointer;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(10px); }
    }

    /* Showcase Section */
    .showcase-section {
      min-height: 500vh;
      position: relative;
      background: var(--bg);
      padding: 0;
    }

    .showcase-sticky {
      position: sticky;
      top: 0;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .showcase-container {
      max-width: 1400px;
      width: 100%;
      padding: 40px 20px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 60px;
      align-items: center;
    }

    @media (max-width: 968px) {
      .showcase-container {
        grid-template-columns: 1fr;
        gap: 30px;
      }
    }

    .showcase-info {
      padding: 20px;
    }

    .showcase-info h2 {
      font-size: clamp(2rem, 4vw, 3rem);
      margin-bottom: 20px;
      color: var(--brand);
    }

    .showcase-info p {
      font-size: clamp(1rem, 2vw, 1.2rem);
      line-height: 1.6;
      color: var(--muted);
      margin-bottom: 16px;
    }

    .feature-list {
      list-style: none;
      margin-top: 20px;
    }

    .feature-list li {
      padding: 12px 0;
      font-size: 1.1rem;
      color: var(--ink);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .feature-list li::before {
      content: "‚úì";
      color: var(--ok);
      font-weight: bold;
      font-size: 1.3rem;
    }

    /* Demo Area */
    .demo-area {
      position: relative;
      background: var(--panel);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      border: 1px solid var(--border);
      min-height: 600px;
    }

    /* Allergen Selector */
    .allergen-selector {
      margin-bottom: 24px;
      padding: 16px;
      background: rgba(124,156,255,0.05);
      border: 1px dashed rgba(124,156,255,0.3);
      border-radius: 12px;
    }

    .allergen-selector-title {
      font-weight: 600;
      color: var(--brand);
      margin-bottom: 12px;
      font-size: 0.95rem;
    }

    .allergen-chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .allergen-chip {
      background: rgba(168, 178, 214, 0.1);
      color: var(--muted);
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 0.9rem;
      border: 1px solid rgba(168, 178, 214, 0.2);
      cursor: pointer;
      transition: all 0.3s;
      user-select: none;
    }

    .allergen-chip.selected {
      background: rgba(239,68,68,0.15);
      color: #e85d5d;
      border-color: rgba(239,68,68,0.3);
    }

    .diet-chip {
      background: rgba(168, 178, 214, 0.1);
      color: var(--muted);
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 0.9rem;
      border: 1px solid rgba(168, 178, 214, 0.2);
      cursor: pointer;
      transition: all 0.3s;
      user-select: none;
    }

    .diet-chip.selected {
      background: rgba(76,200,90,0.15);
      color: #4cc85a;
      border-color: rgba(76,200,90,0.3);
    }

    /* Menu Demo */
    .menu-demo {
      position: relative;
      background: rgba(255,255,255,0.02);
      border-radius: 12px;
      padding: 20px;
      min-height: 400px;
    }

    .menu-item {
      background: rgba(255,255,255,0.03);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      position: relative;
      cursor: pointer;
      transition: all 0.3s;
    }

    .menu-item:hover {
      transform: translateX(4px);
    }

    .menu-item.status-safe {
      border-color: var(--ok);
      background: rgba(34,197,94,0.05);
    }

    .menu-item.status-removable {
      border-color: var(--warn);
      background: rgba(250,204,21,0.05);
    }

    .menu-item.status-unsafe {
      border-color: var(--bad);
      background: rgba(239,68,68,0.05);
    }

    .menu-item.status-neutral {
      border-color: rgba(255,255,255,0.1);
    }

    .item-name {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 4px;
      color: var(--ink);
    }

    .item-desc {
      color: var(--muted);
      font-size: 0.9rem;
    }

    .item-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.1rem;
    }

    .status-safe .item-badge {
      background: var(--ok);
      color: white;
    }

    .status-removable .item-badge {
      background: var(--warn);
      color: #000;
    }

    .status-unsafe .item-badge {
      background: var(--bad);
      color: white;
    }

    .status-neutral .item-badge {
      background: rgba(255,255,255,0.2);
      color: var(--muted);
    }

    .warning-badge {
      position: absolute;
      top: 16px;
      left: 16px;
      width: 28px;
      height: 28px;
      background: var(--warn);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }

    /* Tooltip */
    .demo-tooltip {
      position: absolute;
      background: rgba(11, 16, 32, 0.98);
      backdrop-filter: blur(14px);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      max-width: 320px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      z-index: 100;
      font-size: 0.9rem;
    }

    .demo-tooltip.visible {
      opacity: 1;
    }

    .tooltip-title {
      font-weight: 600;
      color: var(--ink);
      margin-bottom: 12px;
      font-size: 1rem;
    }

    .tooltip-section {
      margin-bottom: 12px;
    }

    .tooltip-section:last-child {
      margin-bottom: 0;
    }

    .tooltip-section strong {
      display: block;
      margin-bottom: 8px;
      color: var(--ink);
      font-size: 0.95rem;
    }

    .tooltip-allergen {
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .tooltip-allergen.danger {
      background: rgba(239,68,68,0.15);
      border-left: 3px solid var(--bad);
      color: var(--ink);
    }

    .tooltip-allergen.warning {
      background: rgba(250,204,21,0.15);
      border-left: 3px solid var(--warn);
      color: var(--ink);
    }

    .tooltip-allergen.safe {
      background: rgba(34,197,94,0.15);
      border-left: 3px solid var(--ok);
      color: var(--ink);
    }

    .tooltip-diet {
      margin-bottom: 6px;
      font-size: 0.9rem;
    }

    .tooltip-diet.met {
      color: #4cc85a;
    }

    .tooltip-diet.not-met {
      color: #e85d5d;
    }

    /* Virtual Cursor */
    .virtual-cursor {
      position: absolute;
      width: 40px;
      height: 40px;
      pointer-events: none;
      opacity: 0;
      transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 200;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }

    .virtual-cursor.visible {
      opacity: 1;
    }

    .virtual-cursor svg {
      width: 100%;
      height: 100%;
    }

    /* Progress Indicator */
    .progress-text {
      text-align: center;
      margin-top: 20px;
      color: var(--muted);
      font-size: 0.95rem;
      min-height: 48px;
      line-height: 1.5;
    }

    /* CTA Section */
    .cta-section {
      min-height: 80vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #4c5ad4 0%, #6366f1 100%);
      padding: 60px 20px;
    }

    .cta-section h2 {
      font-size: clamp(2rem, 5vw, 3rem);
      margin-bottom: 20px;
      text-align: center;
    }

    .cta-section p {
      font-size: clamp(1rem, 2vw, 1.3rem);
      margin-bottom: 40px;
      text-align: center;
      color: rgba(255,255,255,0.9);
      max-width: 600px;
    }

    .cta-button {
      padding: 18px 48px;
      background: white;
      color: #4c5ad4;
      border: none;
      border-radius: 50px;
      font-size: 1.2rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
    }

    .cta-button:hover {
      transform: scale(1.05);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    /* Mobile Bottom Sheet Demo */
    .mobile-sheet {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(11, 16, 32, 0.98);
      backdrop-filter: blur(14px);
      border-radius: 20px 20px 0 0;
      padding: 24px;
      border-top: 1px solid var(--border);
      transform: translateY(100%);
      transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .mobile-sheet.visible {
      transform: translateY(0);
    }

    .mobile-sheet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .mobile-sheet-title {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--ink);
    }

    .mobile-sheet-close {
      background: rgba(255,255,255,0.1);
      border: none;
      color: var(--ink);
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.2rem;
    }
  </style>
</head>
<body>
  <header class="simple-topbar">
    <div class="simple-topbar-inner">
      <a class="simple-brand" href="restaurants.html">
        <img src="https://static.wixstatic.com/media/945e9d_2b97098295d341d493e4a07d80d6b57c~mv2.png" alt="Clarivore logo">
        <span>Clarivore</span>
      </a>
      <div class="simple-nav">
        <!-- Navigation populated by shared-nav.js -->
      </div>
    </div>
  </header>

  <!-- Hero Section -->
  <section class="hero-section">
    <h1 class="hero-title">Dine with Confidence</h1>
    <p class="hero-subtitle">Discover how Clarivore makes dining safer for people with food allergies and dietary restrictions</p>
    <div class="scroll-indicator">‚Üì</div>
  </section>

  <!-- Interactive Showcase Section -->
  <section class="showcase-section">
    <div class="showcase-sticky">
      <div class="showcase-container">
        <!-- Info Panel -->
        <div class="showcase-info">
          <h2 id="sceneTitle">Welcome to Clarivore</h2>
          <div id="sceneDescription">
            <p>Scroll down to see how Clarivore helps you find safe menu options based on your allergens and dietary preferences.</p>
          </div>
        </div>

        <!-- Demo Panel -->
        <div class="demo-area">
          <!-- Virtual Cursor -->
          <div class="virtual-cursor" id="virtualCursor">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none">
              <path d="M3 3L10.07 19.97L12.58 12.58L19.97 10.07L3 3Z" fill="#7c9cff" stroke="#fff" stroke-width="1.5"/>
            </svg>
          </div>

          <!-- Allergen Selector -->
          <div class="allergen-selector" id="allergenSelector">
            <div class="allergen-selector-title">Your Saved Allergens</div>
            <div class="allergen-chips" id="allergenChips"></div>
            <div class="allergen-selector-title" style="margin-top: 16px;">Your Saved Dietary Preferences</div>
            <div class="allergen-chips" id="dietChips"></div>
          </div>

          <!-- Menu Demo -->
          <div class="menu-demo" id="menuDemo"></div>

          <!-- Demo Tooltip -->
          <div class="demo-tooltip" id="demoTooltip"></div>

          <!-- Mobile Bottom Sheet -->
          <div class="mobile-sheet" id="mobileSheet">
            <div class="mobile-sheet-header">
              <div class="mobile-sheet-title" id="sheetTitle">Item Details</div>
              <button class="mobile-sheet-close">√ó</button>
            </div>
            <div id="sheetContent"></div>
          </div>

          <!-- Progress Text -->
          <div class="progress-text" id="progressText"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- CTA Section -->
  <section class="cta-section">
    <h2>Ready to Get Started?</h2>
    <p>Join Clarivore and discover safe dining options across Cleveland</p>
    <a href="account.html" class="cta-button">Create Your Profile</a>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module">
    import supabaseClient from './js/supabase-client.js';
    import { setupNav, attachSignOutHandler } from './js/shared-nav.js';

    async function initNav() {
      const { data: { user } } = await supabaseClient.auth.getUser();
      setupNav('how-it-works', user);
      if (user) {
        attachSignOutHandler(supabaseClient);
      }
    }
    initNav();
  </script>
  <script>
    // Constants from restaurant.html
    const ALLERGENS = ["dairy", "egg", "peanut", "tree nut", "shellfish", "fish", "soy", "sesame", "wheat"];
    const DIETS = ["Vegan", "Vegetarian", "Pescatarian", "Kosher", "Halal"];
    const ALLERGEN_EMOJI = {
      'dairy': 'ü•õ',
      'egg': 'ü•ö',
      'peanut': 'ü•ú',
      'tree nut': 'üå∞',
      'shellfish': 'ü¶ê',
      'fish': 'üêü',
      'soy': 'ü´õ',
      'sesame': 'ü´ò',
      'wheat': 'üåæ'
    };
    const DIET_EMOJI = {
      'Vegan': 'üå±',
      'Vegetarian': 'ü•¨',
      'Pescatarian': 'üêü',
      'Kosher': '‚ú°Ô∏è',
      'Halal': '‚ò™Ô∏è'
    };

    // Demo menu items with comprehensive allergen data
    const DEMO_ITEMS = [
      {
        id: "Garden Salad",
        emoji: "ü•ó",
        desc: "Fresh mixed greens, tomatoes, cucumber, balsamic vinaigrette",
        allergens: [],
        removable: [],
        crossContamination: [],
        diets: ["Vegan", "Vegetarian", "Pescatarian"]
      },
      {
        id: "Grilled Chicken",
        emoji: "üçó",
        desc: "Herb-marinated chicken breast with roasted vegetables",
        allergens: [],
        removable: [],
        crossContamination: ["soy"],
        diets: ["Pescatarian"]
      },
      {
        id: "Pasta Primavera",
        emoji: "üçù",
        desc: "Seasonal vegetables, olive oil, parmesan cheese",
        allergens: ["dairy"],
        removable: [{allergen: "dairy"}],
        crossContamination: [],
        diets: ["Vegetarian", "Pescatarian"]
      },
      {
        id: "Thai Peanut Noodles",
        emoji: "ü•ú",
        desc: "Rice noodles, peanut sauce, vegetables, sesame oil",
        allergens: ["peanut", "sesame"],
        removable: [],
        crossContamination: [],
        diets: ["Vegan", "Vegetarian", "Pescatarian"]
      },
      {
        id: "Seafood Linguine",
        emoji: "ü¶ê",
        desc: "Shrimp, scallops, white wine cream sauce",
        allergens: ["shellfish", "fish", "dairy"],
        removable: [],
        crossContamination: [],
        diets: ["Pescatarian"]
      },
      {
        id: "Margherita Pizza",
        emoji: "üçï",
        desc: "Fresh mozzarella, basil, tomato sauce",
        allergens: ["dairy", "wheat"],
        removable: [{allergen: "dairy"}],
        crossContamination: [],
        diets: ["Vegetarian", "Pescatarian"]
      }
    ];

    // State
    let selectedAllergens = [];
    let selectedDiets = [];
    let currentScene = 0;

    // Core logic from restaurant.html
    function computeStatus(item, allergens, diets) {
      const hasAllergenReqs = allergens && allergens.length > 0;
      const hasDietReqs = diets && diets.length > 0;

      if (!hasAllergenReqs && !hasDietReqs) return 'neutral';

      const allergenHits = (item.allergens || []).filter(a => allergens.includes(a));
      const hasAllergenIssues = allergenHits.length > 0;
      const allergenRemovableAll = hasAllergenIssues ?
        allergenHits.every(a => (item.removable || []).some(r => r.allergen === a)) : true;

      const itemDiets = new Set(item.diets || []);
      const meetsDietReqs = !hasDietReqs || diets.every(diet => itemDiets.has(diet));

      if (!meetsDietReqs) return 'unsafe';
      if (hasAllergenIssues && !allergenRemovableAll) return 'unsafe';
      if (hasAllergenIssues && allergenRemovableAll) return 'removable';

      return 'safe';
    }

    function hasCrossContamination(item, allergens) {
      if (!allergens || !allergens.length) return false;
      const crossContam = item.crossContamination || [];
      return crossContam.some(a => allergens.includes(a));
    }

    function generateTooltipHTML(item, allergens, diets) {
      if (!allergens.length && !diets.length) {
        return '<div style="color: var(--muted);">Select allergens or dietary preferences to see details</div>';
      }

      let html = '';

      if (allergens.length) {
        html += '<div class="tooltip-section"><strong>Allergen Information</strong>';

        const hits = (item.allergens || []).filter(a => allergens.includes(a));
        const removableSet = new Set((item.removable || []).map(r => r.allergen));
        const unsafeHits = hits.filter(a => !removableSet.has(a));
        const removableHits = hits.filter(a => removableSet.has(a));

        if (unsafeHits.length) {
          unsafeHits.forEach(a => {
            const emoji = ALLERGEN_EMOJI[a] || '‚ö†Ô∏è';
            html += `<div class="tooltip-allergen danger">${emoji} Contains <strong>${a}</strong> (cannot be substituted out)</div>`;
          });
        }

        if (removableHits.length) {
          removableHits.forEach(a => {
            const emoji = ALLERGEN_EMOJI[a] || '‚ö†Ô∏è';
            html += `<div class="tooltip-allergen warning">${emoji} Contains <strong>${a}</strong> (can be substituted out)</div>`;
          });
        }

        if (!hits.length) {
          html += '<div class="tooltip-allergen safe">‚úì None of your selected allergens found</div>';
        }

        const hasCross = hasCrossContamination(item, allergens);
        if (hasCross) {
          const crossHits = (item.crossContamination || []).filter(a => allergens.includes(a));
          crossHits.forEach(a => {
            const emoji = ALLERGEN_EMOJI[a] || '‚ö†Ô∏è';
            html += `<div class="tooltip-allergen warning">${emoji} Cross-contamination risk: <strong>${a}</strong></div>`;
          });
        }

        html += '</div>';
      }

      if (diets.length) {
        html += '<div class="tooltip-section"><strong>Dietary Options</strong>';
        const itemDietSet = new Set(item.diets || []);

        diets.forEach(diet => {
          const isDietMet = itemDietSet.has(diet);
          const emoji = DIET_EMOJI[diet] || '‚úì';
          const status = isDietMet ? 'is' : 'is not';
          const className = isDietMet ? 'met' : 'not-met';
          html += `<div class="tooltip-diet ${className}">${emoji} This dish ${status} <strong>${diet.toLowerCase()}</strong></div>`;
        });

        html += '</div>';
      }

      return html;
    }

    // Render functions
    function renderAllergenSelector() {
      const allergenChips = document.getElementById('allergenChips');
      allergenChips.innerHTML = ALLERGENS.map(allergen => {
        const emoji = ALLERGEN_EMOJI[allergen] || '';
        const selected = selectedAllergens.includes(allergen);
        return `<div class="allergen-chip ${selected ? 'selected' : ''}" data-allergen="${allergen}">
          ${emoji} ${allergen.charAt(0).toUpperCase() + allergen.slice(1)}
        </div>`;
      }).join('');

      const dietChips = document.getElementById('dietChips');
      dietChips.innerHTML = DIETS.map(diet => {
        const emoji = DIET_EMOJI[diet] || '';
        const selected = selectedDiets.includes(diet);
        return `<div class="diet-chip ${selected ? 'selected' : ''}" data-diet="${diet}">
          ${emoji} ${diet}
        </div>`;
      }).join('');
    }

    function renderMenu() {
      const menuDemo = document.getElementById('menuDemo');
      menuDemo.innerHTML = DEMO_ITEMS.map(item => {
        const status = computeStatus(item, selectedAllergens, selectedDiets);
        const hasCross = hasCrossContamination(item, selectedAllergens);

        const badgeContent = status === 'safe' ? '‚úì' :
                            status === 'removable' ? '!' :
                            status === 'unsafe' ? '‚úï' : 'i';

        return `
          <div class="menu-item status-${status}" data-item="${item.id}">
            ${hasCross ? '<div class="warning-badge">‚ö†</div>' : ''}
            <div class="item-name">${item.emoji} ${item.id}</div>
            <div class="item-desc">${item.desc}</div>
            <div class="item-badge">${badgeContent}</div>
          </div>
        `;
      }).join('');
    }

    // Scene definitions
    const SCENES = [
      {
        title: "Welcome to Clarivore",
        description: "<p>Scroll down to see how Clarivore helps you find safe menu options based on your allergens and dietary preferences.</p>",
        allergens: [],
        diets: [],
        cursorTarget: null,
        tooltipItem: null,
        progressText: "Scroll down to begin the demo ‚Üí"
      },
      {
        title: "Select Your Allergens",
        description: "<p>First, choose your allergens. Watch as we select some common allergens.</p><p>The system supports 9 major allergens including dairy, eggs, peanuts, tree nuts, shellfish, fish, soy, sesame, and wheat.</p>",
        allergens: [],
        diets: [],
        cursorTarget: "allergen:dairy",
        tooltipItem: null,
        progressText: "Selecting allergens: dairy, peanut..."
      },
      {
        title: "Allergens Selected",
        description: "<p>Now we've selected dairy and peanut as allergens.</p><p>Notice how the menu items haven't changed yet? That's because we haven't applied any filters.</p>",
        allergens: ["dairy", "peanut"],
        diets: [],
        cursorTarget: null,
        tooltipItem: null,
        progressText: "Allergens saved: ü•õ Dairy, ü•ú Peanut"
      },
      {
        title: "Color-Coded Menu Items",
        description: "<p>Watch how menu items are automatically color-coded:</p><ul class='feature-list'><li>Green = Safe to eat</li><li>Yellow = Can be accommodated</li><li>Red = Contains allergens</li></ul>",
        allergens: ["dairy", "peanut"],
        diets: [],
        cursorTarget: "item:Garden Salad",
        tooltipItem: null,
        progressText: "‚úì Green = Safe - no allergens detected"
      },
      {
        title: "Interactive Tooltips",
        description: "<p>Hover over any item to see detailed allergen information.</p><p>The tooltip shows exactly which allergens are present and whether they can be removed.</p>",
        allergens: ["dairy", "peanut"],
        diets: [],
        cursorTarget: "item:Pasta Primavera",
        tooltipItem: "Pasta Primavera",
        progressText: "‚ö†Ô∏è Yellow = Caution - tap to see what can be removed"
      },
      {
        title: "Unsafe Items",
        description: "<p>Items marked in red contain allergens that cannot be removed.</p><p>This dish contains peanuts which are integral to the recipe.</p>",
        allergens: ["dairy", "peanut"],
        diets: [],
        cursorTarget: "item:Thai Peanut Noodles",
        tooltipItem: "Thai Peanut Noodles",
        progressText: "üö´ Red = Avoid - contains allergens that cannot be removed"
      },
      {
        title: "Cross-Contamination Warnings",
        description: "<p>The yellow warning badge indicates potential cross-contamination risks.</p><p>This helps you make informed decisions even for items that don't directly contain your allergens.</p>",
        allergens: ["soy"],
        diets: [],
        cursorTarget: "item:Grilled Chicken",
        tooltipItem: "Grilled Chicken",
        progressText: "‚ö†Ô∏è Yellow badge = Cross-contamination warning"
      },
      {
        title: "Dietary Preferences",
        description: "<p>Add dietary preferences like Vegan, Vegetarian, Pescatarian, Kosher, or Halal.</p><p>Menu items will be filtered to match both allergens AND dietary requirements.</p>",
        allergens: [],
        diets: ["Vegan"],
        cursorTarget: "diet:Vegan",
        tooltipItem: null,
        progressText: "Selecting dietary preference: üå± Vegan"
      },
      {
        title: "Combined Filtering",
        description: "<p>Combine allergens and dietary preferences for precise filtering.</p><p>Items must meet ALL your requirements to be marked as safe.</p>",
        allergens: ["dairy"],
        diets: ["Vegan"],
        cursorTarget: "item:Garden Salad",
        tooltipItem: "Garden Salad",
        progressText: "‚úì Filters both allergens and dietary preferences"
      },
      {
        title: "Complete Safety Information",
        description: "<p>Every menu item shows:</p><ul class='feature-list'><li>Allergen presence</li><li>Removal possibility</li><li>Cross-contamination risks</li><li>Dietary compatibility</li></ul>",
        allergens: ["dairy", "peanut"],
        diets: [],
        cursorTarget: "item:Margherita Pizza",
        tooltipItem: "Margherita Pizza",
        progressText: "Tap any item to see complete allergen information"
      }
    ];

    // Animation and scroll handling
    let currentSceneIndex = 0;
    let sceneProgress = 0;

    function updateScene() {
      const showcaseSection = document.querySelector('.showcase-section');
      const rect = showcaseSection.getBoundingClientRect();
      const viewportHeight = window.innerHeight;

      // Calculate overall progress through the showcase section
      let overallProgress = 0;
      if (rect.top > 0) {
        overallProgress = 0;
      } else if (rect.bottom < viewportHeight) {
        overallProgress = 1;
      } else {
        overallProgress = Math.abs(rect.top) / (rect.height - viewportHeight);
      }

      // Determine current scene
      const sceneIndex = Math.min(
        Math.floor(overallProgress * SCENES.length),
        SCENES.length - 1
      );

      const sceneStart = sceneIndex / SCENES.length;
      const sceneEnd = (sceneIndex + 1) / SCENES.length;
      sceneProgress = (overallProgress - sceneStart) / (sceneEnd - sceneStart);
      sceneProgress = Math.max(0, Math.min(1, sceneProgress));

      if (sceneIndex !== currentSceneIndex) {
        currentSceneIndex = sceneIndex;
        applyScene(SCENES[currentSceneIndex]);
      }

      // Update cursor position based on scene progress
      updateCursor();
    }

    function applyScene(scene) {
      // Update title and description
      document.getElementById('sceneTitle').textContent = scene.title;
      document.getElementById('sceneDescription').innerHTML = scene.description;
      document.getElementById('progressText').textContent = scene.progressText;

      // Update state
      selectedAllergens = [...scene.allergens];
      selectedDiets = [...scene.diets];

      // Re-render
      renderAllergenSelector();
      renderMenu();

      // Hide tooltip initially
      document.getElementById('demoTooltip').classList.remove('visible');
    }

    function updateCursor() {
      const scene = SCENES[currentSceneIndex];
      const cursor = document.getElementById('virtualCursor');
      const tooltip = document.getElementById('demoTooltip');

      if (!scene.cursorTarget && !scene.tooltipItem) {
        cursor.classList.remove('visible');
        tooltip.classList.remove('visible');
        return;
      }

      // Show cursor
      cursor.classList.add('visible');

      // Find target element
      let targetElement = null;
      if (scene.cursorTarget) {
        if (scene.cursorTarget.startsWith('allergen:')) {
          const allergen = scene.cursorTarget.split(':')[1];
          targetElement = document.querySelector(`[data-allergen="${allergen}"]`);
        } else if (scene.cursorTarget.startsWith('diet:')) {
          const diet = scene.cursorTarget.split(':')[1];
          targetElement = document.querySelector(`[data-diet="${diet}"]`);
        } else if (scene.cursorTarget.startsWith('item:')) {
          const itemName = scene.cursorTarget.split(':')[1];
          targetElement = document.querySelector(`[data-item="${itemName}"]`);
        }
      }

      if (targetElement) {
        const rect = targetElement.getBoundingClientRect();
        const demoArea = document.querySelector('.demo-area');
        const demoRect = demoArea.getBoundingClientRect();

        cursor.style.left = (rect.left - demoRect.left + rect.width / 2 - 20) + 'px';
        cursor.style.top = (rect.top - demoRect.top + rect.height / 2 - 20) + 'px';
      }

      // Show tooltip if specified
      if (scene.tooltipItem && sceneProgress > 0.3) {
        const item = DEMO_ITEMS.find(i => i.id === scene.tooltipItem);
        if (item) {
          tooltip.innerHTML = `
            <div class="tooltip-title">${item.emoji} ${item.id}</div>
            ${generateTooltipHTML(item, selectedAllergens, selectedDiets)}
          `;

          const itemElement = document.querySelector(`[data-item="${item.id}"]`);
          if (itemElement) {
            const rect = itemElement.getBoundingClientRect();
            const demoArea = document.querySelector('.demo-area');
            const demoRect = demoArea.getBoundingClientRect();

            tooltip.style.left = (rect.right - demoRect.left + 10) + 'px';
            tooltip.style.top = (rect.top - demoRect.top) + 'px';
            tooltip.classList.add('visible');
          }
        }
      } else {
        tooltip.classList.remove('visible');
      }
    }

    // Initialize
    function init() {
      renderAllergenSelector();
      renderMenu();
      applyScene(SCENES[0]);

      // Scroll listener
      let ticking = false;
      window.addEventListener('scroll', () => {
        if (!ticking) {
          window.requestAnimationFrame(() => {
            updateScene();
            ticking = false;
          });
          ticking = true;
        }
      }, { passive: true });

      // Scroll indicator
      const scrollIndicator = document.querySelector('.scroll-indicator');
      if (scrollIndicator) {
        scrollIndicator.addEventListener('click', () => {
          window.scrollTo({
            top: window.innerHeight,
            behavior: 'smooth'
          });
        });
      }

      // Initial update
      updateScene();
    }

    // Start when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
