<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>How It Works - Clarivore</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    :root {
      --bg: #0b1020;
      --panel: #111630;
      --ink: #e9ecff;
      --muted: #a8b2d6;
      --brand: #7c9cff;
      --ok: #22c55e;
      --warn: #facc15;
      --bad: #ef4444;
      --border: #2a3261;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--bg);
      color: var(--ink);
      overflow-x: hidden;
    }

    .simple-topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(11, 16, 32, 0.95);
      backdrop-filter: blur(10px);
      z-index: 1000;
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
    }

    .simple-topbar-inner {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .simple-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: var(--ink);
      font-weight: 600;
      font-size: 1.1rem;
    }

    .simple-brand img {
      width: 32px;
      height: 32px;
    }

    /* Hero Section */
    .hero-section {
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #1e3a5f 0%, #2a5298 100%);
    }

    .hero-title {
      font-size: clamp(2.5rem, 8vw, 6rem);
      font-weight: 700;
      text-align: center;
      padding: 0 20px;
      margin-bottom: 20px;
    }

    .hero-subtitle {
      font-size: clamp(1rem, 3vw, 1.5rem);
      text-align: center;
      padding: 0 20px;
      max-width: 800px;
      color: rgba(255,255,255,0.9);
      margin-bottom: 40px;
    }

    .scroll-indicator {
      font-size: 2rem;
      animation: bounce 2s infinite;
      opacity: 0.7;
      cursor: pointer;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(10px); }
    }

    /* Main Showcase */
    .showcase-section {
      min-height: 600vh;
      position: relative;
      background: var(--bg);
    }

    .showcase-sticky {
      position: sticky;
      top: 0;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 80px 20px 20px;
    }

    .showcase-container {
      max-width: 1600px;
      width: 100%;
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 40px;
      align-items: start;
    }

    @media (max-width: 1200px) {
      .showcase-container {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      .info-panel {
        max-width: 600px;
        margin: 0 auto;
      }
    }

    .info-panel {
      padding: 30px;
      background: var(--panel);
      border-radius: 16px;
      border: 1px solid var(--border);
    }

    .info-panel h2 {
      font-size: 2rem;
      color: var(--brand);
      margin-bottom: 16px;
    }

    .info-panel p {
      font-size: 1.1rem;
      line-height: 1.6;
      color: var(--muted);
      margin-bottom: 12px;
    }

    .info-panel strong {
      color: var(--ink);
    }

    /* Menu Container - mimics restaurant.html */
    .menu-container {
      position: relative;
      background: var(--panel);
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      overflow: hidden;
    }

    /* Allergen Selector - from restaurant.html */
    .allergen-selector {
      padding: 20px;
      background: rgba(124,156,255,0.05);
      border-bottom: 1px solid var(--border);
    }

    .allergen-selector-title {
      font-weight: 600;
      color: var(--brand);
      margin-bottom: 10px;
      font-size: 0.9rem;
    }

    .allergen-chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .allergen-chip {
      background: rgba(168, 178, 214, 0.1);
      color: var(--muted);
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 0.85rem;
      border: 1px solid rgba(168, 178, 214, 0.2);
      transition: all 0.3s;
      user-select: none;
    }

    .allergen-chip.selected {
      background: rgba(239,68,68,0.15);
      color: #e85d5d;
      border-color: rgba(239,68,68,0.3);
    }

    .diet-chip.selected {
      background: rgba(76,200,90,0.15);
      color: #4cc85a;
      border-color: rgba(76,200,90,0.3);
    }

    /* Demo Menu Image */
    .menu-wrapper {
      position: relative;
      padding: 20px;
      background: #1a1a1a;
    }

    #demoMenu {
      width: 100%;
      height: 700px;
      background: linear-gradient(to bottom, #2a2a2a 0%, #1a1a1a 100%);
      border-radius: 8px;
      position: relative;
      background-image:
        linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
      background-size: 50px 50px;
    }

    /* Menu Title Overlay */
    .menu-title-overlay {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 2.5rem;
      font-weight: 700;
      color: rgba(255,255,255,0.1);
      text-transform: uppercase;
      letter-spacing: 4px;
      pointer-events: none;
    }

    /* Overlay Layer - from restaurant.html */
    #overlayLayer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .overlay {
      position: absolute;
      border: 3px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      transition: all 0.3s;
      pointer-events: all;
      cursor: pointer;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(2px);
    }

    .overlay:hover {
      background: rgba(0,0,0,0.5);
      transform: scale(1.02);
    }

    /* Badges - from restaurant.html */
    .ovBadge {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 32px;
      height: 32px;
      background: rgba(124,156,255,0.9);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .ovBadge:hover {
      transform: scale(1.1);
      background: var(--brand);
    }

    .ovWarning {
      position: absolute;
      top: 8px;
      left: 8px;
      width: 28px;
      height: 28px;
      background: var(--warn);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.05); }
    }

    /* Tooltip - from restaurant.html */
    #pageTip {
      position: absolute;
      background: rgba(11, 16, 32, 0.98);
      backdrop-filter: blur(14px);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      max-width: 320px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      display: none;
      z-index: 1000;
      font-size: 0.9rem;
    }

    .tipHead {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .tTitle {
      font-weight: 600;
      color: var(--ink);
      font-size: 1rem;
    }

    .tClose {
      background: rgba(255,255,255,0.1);
      border: none;
      color: var(--ink);
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }

    .note {
      background: rgba(124,156,255,0.1);
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .tooltipDangerText {
      background: rgba(239,68,68,0.15);
      border-left: 3px solid var(--bad);
      color: var(--ink);
    }

    .tooltipWarnText {
      background: rgba(250,204,21,0.15);
      border-left: 3px solid var(--warn);
      color: var(--ink);
    }

    .tooltipNeutralText {
      background: rgba(34,197,94,0.15);
      border-left: 3px solid var(--ok);
      color: var(--ink);
    }

    /* Virtual Cursor */
    #virtualCursor {
      position: absolute;
      width: 40px;
      height: 40px;
      pointer-events: none;
      opacity: 0;
      transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 2000;
      filter: drop-shadow(0 2px 8px rgba(124,156,255,0.5));
    }

    #virtualCursor.visible {
      opacity: 1;
    }

    /* Progress Indicator */
    .progress-indicator {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(11, 16, 32, 0.9);
      padding: 12px 24px;
      border-radius: 24px;
      border: 1px solid var(--border);
      font-size: 0.9rem;
      color: var(--muted);
      text-align: center;
      max-width: 90%;
    }

    /* CTA Section */
    .cta-section {
      min-height: 80vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #4c5ad4 0%, #6366f1 100%);
      padding: 60px 20px;
    }

    .cta-section h2 {
      font-size: clamp(2rem, 5vw, 3rem);
      margin-bottom: 20px;
      text-align: center;
    }

    .cta-section p {
      font-size: clamp(1rem, 2vw, 1.3rem);
      margin-bottom: 40px;
      text-align: center;
      color: rgba(255,255,255,0.9);
      max-width: 600px;
    }

    .cta-button {
      padding: 18px 48px;
      background: white;
      color: #4c5ad4;
      border: none;
      border-radius: 50px;
      font-size: 1.2rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
    }

    .cta-button:hover {
      transform: scale(1.05);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <header class="simple-topbar">
    <div class="simple-topbar-inner">
      <a class="simple-brand" href="restaurants.html">
        <img src="https://static.wixstatic.com/media/945e9d_2b97098295d341d493e4a07d80d6b57c~mv2.png" alt="Clarivore logo">
        <span>Clarivore</span>
      </a>
      <div class="simple-nav"></div>
    </div>
  </header>

  <!-- Hero Section -->
  <section class="hero-section">
    <h1 class="hero-title">How Clarivore Works</h1>
    <p class="hero-subtitle">Experience the complete allergen-aware dining system. Scroll to see every feature in action.</p>
    <div class="scroll-indicator">‚Üì</div>
  </section>

  <!-- Interactive Showcase -->
  <section class="showcase-section">
    <div class="showcase-sticky">
      <div class="showcase-container">
        <!-- Info Panel -->
        <div class="info-panel">
          <h2 id="sceneTitle">Loading...</h2>
          <div id="sceneDescription"></div>
        </div>

        <!-- Menu Demo -->
        <div class="menu-container">
          <!-- Allergen Selector -->
          <div class="allergen-selector">
            <div class="allergen-selector-title">Your Saved Allergens</div>
            <div class="allergen-chips" id="allergenChips"></div>
            <div class="allergen-selector-title">Your Saved Dietary Preferences</div>
            <div class="allergen-chips" id="dietChips"></div>
          </div>

          <!-- Menu Display -->
          <div class="menu-wrapper">
            <div id="demoMenu">
              <div class="menu-title-overlay">DEMO MENU</div>
              <div id="overlayLayer"></div>
            </div>

            <!-- Virtual Cursor -->
            <div id="virtualCursor">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none">
                <path d="M3 3L10.07 19.97L12.58 12.58L19.97 10.07L3 3Z" fill="#7c9cff" stroke="#fff" stroke-width="2"/>
              </svg>
            </div>

            <!-- Tooltip -->
            <div id="pageTip"></div>
          </div>

          <!-- Progress Indicator -->
          <div class="progress-indicator" id="progressText">Scroll to begin</div>
        </div>
      </div>
    </div>
  </section>

  <!-- CTA Section -->
  <section class="cta-section">
    <h2>Ready to Get Started?</h2>
    <p>Join Clarivore and discover safe dining options tailored to your needs</p>
    <a href="account.html" class="cta-button">Create Your Profile</a>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module">
    import supabaseClient from './js/supabase-client.js';
    import { setupNav, attachSignOutHandler } from './js/shared-nav.js';

    async function initNav() {
      const { data: { user } } = await supabaseClient.auth.getUser();
      setupNav('how-it-works', user);
      if (user) attachSignOutHandler(supabaseClient);
    }
    initNav();
  </script>
  <script>
    // Constants from restaurant.html
    const ALLERGENS = ["dairy", "egg", "peanut", "tree nut", "shellfish", "fish", "soy", "sesame", "wheat"];
    const DIETS = ["Vegan", "Vegetarian", "Pescatarian", "Kosher", "Halal"];
    const ALLERGEN_EMOJI = {
      'dairy': 'ü•õ', 'egg': 'ü•ö', 'peanut': 'ü•ú', 'tree nut': 'üå∞',
      'shellfish': 'ü¶ê', 'fish': 'üêü', 'soy': 'ü´õ', 'sesame': 'ü´ò', 'wheat': 'üåæ'
    };
    const DIET_EMOJI = {
      'Vegan': 'üå±', 'Vegetarian': 'ü•¨', 'Pescatarian': 'üêü', 'Kosher': '‚ú°Ô∏è', 'Halal': '‚ò™Ô∏è'
    };

    // Demo menu items with overlay positions (as percentages)
    const DEMO_ITEMS = [
      {
        id: "Garden Salad",
        x: 10, y: 8, w: 35, h: 12,
        allergens: [],
        removable: [],
        crossContamination: [],
        diets: ["Vegan", "Vegetarian", "Pescatarian"]
      },
      {
        id: "Grilled Chicken Breast",
        x: 55, y: 8, w: 35, h: 12,
        allergens: [],
        removable: [],
        crossContamination: ["soy"],
        diets: []
      },
      {
        id: "Pasta Primavera",
        x: 10, y: 25, w: 35, h: 12,
        allergens: ["dairy"],
        removable: [{allergen: "dairy"}],
        crossContamination: [],
        diets: ["Vegetarian"]
      },
      {
        id: "Thai Peanut Noodles",
        x: 55, y: 25, w: 35, h: 12,
        allergens: ["peanut", "sesame"],
        removable: [],
        crossContamination: [],
        diets: ["Vegan", "Vegetarian"]
      },
      {
        id: "Seafood Linguine",
        x: 10, y: 42, w: 35, h: 12,
        allergens: ["shellfish", "fish", "dairy"],
        removable: [],
        crossContamination: [],
        diets: []
      },
      {
        id: "Margherita Pizza",
        x: 55, y: 42, w: 35, h: 12,
        allergens: ["dairy", "wheat"],
        removable: [{allergen: "dairy"}],
        crossContamination: [],
        diets: ["Vegetarian"]
      },
      {
        id: "Caesar Salad",
        x: 10, y: 59, w: 35, h: 12,
        allergens: ["dairy", "egg", "fish"],
        removable: [{allergen: "dairy"}],
        crossContamination: [],
        diets: []
      },
      {
        id: "Vegetable Stir Fry",
        x: 55, y: 59, w: 35, h: 12,
        allergens: ["soy"],
        removable: [],
        crossContamination: [],
        diets: ["Vegan", "Vegetarian"]
      },
      {
        id: "Chocolate Cake",
        x: 10, y: 76, w: 35, h: 12,
        allergens: ["dairy", "egg", "wheat"],
        removable: [],
        crossContamination: [],
        diets: ["Vegetarian"]
      },
      {
        id: "Fresh Fruit Plate",
        x: 55, y: 76, w: 35, h: 12,
        allergens: [],
        removable: [],
        crossContamination: [],
        diets: ["Vegan", "Vegetarian", "Pescatarian", "Kosher", "Halal"]
      }
    ];

    // State
    let state = {
      allergens: [],
      diets: [],
      currentScene: 0
    };

    // Core logic from restaurant.html
    function computeStatus(item, allergens, diets) {
      const hasAllergenReqs = allergens && allergens.length > 0;
      const hasDietReqs = diets && diets.length > 0;
      if (!hasAllergenReqs && !hasDietReqs) return 'neutral';

      const allergenHits = (item.allergens || []).filter(a => allergens.includes(a));
      const hasAllergenIssues = allergenHits.length > 0;
      const allergenRemovableAll = hasAllergenIssues ?
        allergenHits.every(a => (item.removable || []).some(r => r.allergen === a)) : true;

      const itemDiets = new Set(item.diets || []);
      const meetsDietReqs = !hasDietReqs || diets.every(diet => itemDiets.has(diet));

      if (!meetsDietReqs) return 'unsafe';
      if (hasAllergenIssues && !allergenRemovableAll) return 'unsafe';
      if (hasAllergenIssues && allergenRemovableAll) return 'removable';
      return 'safe';
    }

    function hasCrossContamination(item, allergens) {
      if (!allergens || !allergens.length) return false;
      return (item.crossContamination || []).some(a => allergens.includes(a));
    }

    function tooltipBodyHTML(item, allergens, diets) {
      if (!allergens.length && !diets.length) {
        return '<div class="note">Select allergens or dietary preferences to see safety information</div>';
      }

      let html = '';
      if (allergens.length) {
        html += '<strong style="display:block;margin-bottom:8px;color:var(--ink)">Allergen Information</strong>';
        const hits = (item.allergens || []).filter(a => allergens.includes(a));
        const removableSet = new Set((item.removable || []).map(r => r.allergen));
        const unsafeHits = hits.filter(a => !removableSet.has(a));
        const removableHits = hits.filter(a => removableSet.has(a));

        if (unsafeHits.length) {
          const list = unsafeHits.map(a => {
            const emoji = ALLERGEN_EMOJI[a] || '‚ö†Ô∏è';
            return `<div style="margin-bottom:4px">${emoji} Contains <strong>${a}</strong> (cannot be substituted)</div>`;
          }).join('');
          html += `<div class="note tooltipDangerText">${list}</div>`;
        }
        if (removableHits.length) {
          const list = removableHits.map(a => {
            const emoji = ALLERGEN_EMOJI[a] || '‚ö†Ô∏è';
            return `<div style="margin-bottom:4px">${emoji} Contains <strong>${a}</strong> (can be substituted)</div>`;
          }).join('');
          html += `<div class="note tooltipWarnText">${list}</div>`;
        }
        if (!hits.length && !hasCrossContamination(item, allergens)) {
          html += '<div class="note tooltipNeutralText">‚úì None of your allergens found</div>';
        }

        if (hasCrossContamination(item, allergens)) {
          const crossHits = (item.crossContamination || []).filter(a => allergens.includes(a));
          const crossList = crossHits.map(a => {
            const emoji = ALLERGEN_EMOJI[a] || '‚ö†Ô∏è';
            return `<div style="margin-bottom:4px">${emoji} Cross-contamination risk: <strong>${a}</strong></div>`;
          }).join('');
          html += `<div class="note tooltipWarnText">${crossList}</div>`;
        }
      }

      if (diets.length) {
        html += '<div style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(124,156,255,0.2)">';
        html += '<strong style="display:block;margin-bottom:8px;color:var(--ink)">Dietary Options</strong>';
        const itemDietSet = new Set(item.diets || []);
        diets.forEach(diet => {
          const isDietMet = itemDietSet.has(diet);
          const color = isDietMet ? '#4cc85a' : '#e85d5d';
          const emoji = DIET_EMOJI[diet] || '‚úì';
          const status = isDietMet ? 'is' : 'is not';
          html += `<div style="margin-bottom:6px;color:${color};font-size:0.9rem">${emoji} This dish ${status} <strong>${diet.toLowerCase()}</strong></div>`;
        });
        html += '</div>';
      }

      return html;
    }

    // Render functions
    function renderAllergenSelector() {
      const allergenChips = document.getElementById('allergenChips');
      allergenChips.innerHTML = ALLERGENS.map(allergen => {
        const emoji = ALLERGEN_EMOJI[allergen] || '';
        const selected = state.allergens.includes(allergen);
        return `<div class="allergen-chip ${selected ? 'selected' : ''}">${emoji} ${allergen.charAt(0).toUpperCase() + allergen.slice(1)}</div>`;
      }).join('');

      const dietChips = document.getElementById('dietChips');
      dietChips.innerHTML = DIETS.map(diet => {
        const emoji = DIET_EMOJI[diet] || '';
        const selected = state.diets.includes(diet);
        return `<div class="allergen-chip diet-chip ${selected ? 'selected' : ''}">${emoji} ${diet}</div>`;
      }).join('');
    }

    function renderLayer() {
      const layer = document.getElementById('overlayLayer');
      const menu = document.getElementById('demoMenu');
      layer.innerHTML = '';

      const colors = {
        safe: 'var(--ok)',
        removable: 'var(--warn)',
        unsafe: 'var(--bad)',
        neutral: 'rgba(255,255,255,0.2)'
      };

      DEMO_ITEMS.forEach(item => {
        const box = document.createElement('div');
        box.className = 'overlay';
        box.dataset.itemId = item.id;

        const status = computeStatus(item, state.allergens, state.diets);
        box.style.borderColor = colors[status];
        box.style.left = item.x + '%';
        box.style.top = item.y + '%';
        box.style.width = item.w + '%';
        box.style.height = item.h + '%';

        // Add item label
        const label = document.createElement('div');
        label.style.cssText = 'position:absolute;bottom:8px;left:8px;color:rgba(255,255,255,0.9);font-size:0.85rem;font-weight:600;text-shadow:0 1px 3px rgba(0,0,0,0.8);';
        label.textContent = item.id;
        box.appendChild(label);

        // Cross-contamination warning
        if (hasCrossContamination(item, state.allergens)) {
          const warning = document.createElement('div');
          warning.className = 'ovWarning';
          warning.textContent = '‚ö†';
          box.appendChild(warning);
        }

        // Info badge
        const badge = document.createElement('div');
        badge.className = 'ovBadge';
        badge.textContent = 'i';
        box.appendChild(badge);

        // Hover tooltip
        box.addEventListener('mouseenter', (e) => {
          showTooltip(item, e);
        });
        box.addEventListener('mouseleave', hideTooltip);

        layer.appendChild(box);
      });
    }

    function showTooltip(item, event) {
      const tip = document.getElementById('pageTip');
      const html = tooltipBodyHTML(item, state.allergens, state.diets);

      tip.innerHTML = `
        <div class="tipHead">
          <div class="tTitle">${item.id}</div>
          <button class="tClose" onclick="document.getElementById('pageTip').style.display='none'">√ó</button>
        </div>
        ${html}
      `;

      tip.style.display = 'block';

      // Position tooltip
      const rect = event.currentTarget.getBoundingClientRect();
      const menuWrapper = document.querySelector('.menu-wrapper');
      const wrapperRect = menuWrapper.getBoundingClientRect();

      tip.style.left = (rect.right - wrapperRect.left + 10) + 'px';
      tip.style.top = (rect.top - wrapperRect.top) + 'px';
    }

    function hideTooltip() {
      document.getElementById('pageTip').style.display = 'none';
    }

    // Scene definitions
    const SCENES = [
      {
        title: "Welcome to Clarivore",
        description: "<p>This is an interactive demo showing exactly how Clarivore works with real menus.</p><p><strong>Scroll down</strong> to see the virtual cursor navigate through all features.</p>",
        allergens: [],
        diets: [],
        cursorTarget: null,
        tooltipItem: null,
        progressText: "Scroll down to begin the interactive demo"
      },
      {
        title: "Step 1: Select Your Allergens",
        description: "<p>First, you select your allergens from the top panel.</p><p>Watch as we automatically select <strong>dairy</strong> and <strong>peanut</strong> allergens.</p><p>The menu overlays will instantly update to show which items are safe.</p>",
        allergens: ["dairy", "peanut"],
        diets: [],
        cursorTarget: null,
        tooltipItem: null,
        progressText: "Allergens selected: ü•õ Dairy, ü•ú Peanut"
      },
      {
        title: "Step 2: Color-Coded Safety Status",
        description: "<p>Notice how each menu item now has a colored border:</p><p>üü¢ <strong>Green</strong> = Safe to eat</p><p>üü° <strong>Yellow</strong> = Can be accommodated</p><p>üî¥ <strong>Red</strong> = Contains allergens</p>",
        allergens: ["dairy", "peanut"],
        diets: [],
        cursorTarget: "Garden Salad",
        tooltipItem: null,
        progressText: "Green borders indicate safe items with no allergens"
      },
      {
        title: "Step 3: Hover for Details",
        description: "<p>Hover over any menu item to see detailed allergen information.</p><p>The <strong>Pasta Primavera</strong> contains dairy, but it can be substituted.</p><p>This is why it has a yellow border instead of red.</p>",
        allergens: ["dairy", "peanut"],
        diets: [],
        cursorTarget: "Pasta Primavera",
        tooltipItem: "Pasta Primavera",
        progressText: "Yellow = allergen can be removed or substituted"
      },
      {
        title: "Step 4: Unsafe Items",
        description: "<p>Items with red borders contain allergens that cannot be removed.</p><p><strong>Thai Peanut Noodles</strong> has peanuts as a core ingredient.</p><p>The tooltip shows clearly that it cannot be substituted.</p>",
        allergens: ["dairy", "peanut"],
        diets: [],
        cursorTarget: "Thai Peanut Noodles",
        tooltipItem: "Thai Peanut Noodles",
        progressText: "Red = contains allergens that cannot be removed"
      },
      {
        title: "Step 5: Cross-Contamination Warnings",
        description: "<p>The yellow ‚ö†Ô∏è badge indicates cross-contamination risk.</p><p><strong>Grilled Chicken</strong> doesn't contain soy, but it's prepared in an area with soy cross-contamination.</p><p>This helps you make fully informed decisions.</p>",
        allergens: ["soy"],
        diets: [],
        cursorTarget: "Grilled Chicken Breast",
        tooltipItem: "Grilled Chicken Breast",
        progressText: "‚ö†Ô∏è Yellow badge = cross-contamination warning"
      },
      {
        title: "Step 6: Dietary Preferences",
        description: "<p>You can also filter by dietary preferences like Vegan, Vegetarian, Pescatarian, Kosher, or Halal.</p><p>Let's add <strong>Vegan</strong> to see which items meet that requirement.</p>",
        allergens: [],
        diets: ["Vegan"],
        cursorTarget: "Fresh Fruit Plate",
        tooltipItem: "Fresh Fruit Plate",
        progressText: "Dietary preference selected: üå± Vegan"
      },
      {
        title: "Step 7: Combined Filtering",
        description: "<p>Combine allergens and dietary preferences for precise filtering.</p><p>With dairy allergy + vegan diet, items must pass BOTH requirements to be green.</p><p>Items like <strong>Vegetable Stir Fry</strong> are vegan but contain soy.</p>",
        allergens: ["dairy"],
        diets: ["Vegan"],
        cursorTarget: "Vegetable Stir Fry",
        tooltipItem: "Vegetable Stir Fry",
        progressText: "Filtering by both allergens AND dietary preferences"
      },
      {
        title: "Step 8: The Info Badge",
        description: "<p>Every menu item has an info badge (‚ìò) you can click.</p><p>This shows complete allergen and dietary information.</p><p>All tooltips work exactly as they do in the real menu viewer.</p>",
        allergens: ["dairy", "wheat"],
        diets: [],
        cursorTarget: "Margherita Pizza",
        tooltipItem: "Margherita Pizza",
        progressText: "Click the ‚ìò badge on any item for full details"
      },
      {
        title: "Complete Feature Set",
        description: "<p>Clarivore gives you:</p><p>‚úì Visual color-coding at a glance</p><p>‚úì Detailed allergen information</p><p>‚úì Removable vs. non-removable indicators</p><p>‚úì Cross-contamination warnings</p><p>‚úì Dietary preference filtering</p><p><strong>All working together</strong> to help you dine safely.</p>",
        allergens: ["dairy", "peanut"],
        diets: [],
        cursorTarget: null,
        tooltipItem: null,
        progressText: "Scroll down to create your profile"
      }
    ];

    // Animation and scroll handling
    let currentSceneIndex = 0;

    function updateScene() {
      const showcaseSection = document.querySelector('.showcase-section');
      const rect = showcaseSection.getBoundingClientRect();
      const viewportHeight = window.innerHeight;

      let progress = 0;
      if (rect.top > 0) {
        progress = 0;
      } else if (rect.bottom < viewportHeight) {
        progress = 1;
      } else {
        progress = Math.abs(rect.top) / (rect.height - viewportHeight);
      }

      const sceneIndex = Math.min(
        Math.floor(progress * SCENES.length),
        SCENES.length - 1
      );

      if (sceneIndex !== currentSceneIndex) {
        currentSceneIndex = sceneIndex;
        applyScene(SCENES[currentSceneIndex]);
      }

      updateCursor();
    }

    function applyScene(scene) {
      document.getElementById('sceneTitle').textContent = scene.title;
      document.getElementById('sceneDescription').innerHTML = scene.description;
      document.getElementById('progressText').textContent = scene.progressText;

      state.allergens = [...scene.allergens];
      state.diets = [...scene.diets];

      renderAllergenSelector();
      renderLayer();
      hideTooltip();
    }

    function updateCursor() {
      const scene = SCENES[currentSceneIndex];
      const cursor = document.getElementById('virtualCursor');

      if (!scene.cursorTarget) {
        cursor.classList.remove('visible');
        if (!scene.tooltipItem) hideTooltip();
        return;
      }

      cursor.classList.add('visible');

      const targetOverlay = document.querySelector(`[data-item-id="${scene.cursorTarget}"]`);
      if (targetOverlay) {
        const rect = targetOverlay.getBoundingClientRect();
        const menuWrapper = document.querySelector('.menu-wrapper');
        const wrapperRect = menuWrapper.getBoundingClientRect();

        cursor.style.left = (rect.left - wrapperRect.left + rect.width / 2 - 20) + 'px';
        cursor.style.top = (rect.top - wrapperRect.top + rect.height / 2 - 20) + 'px';
      }

      if (scene.tooltipItem) {
        const item = DEMO_ITEMS.find(i => i.id === scene.tooltipItem);
        if (item) {
          const overlay = document.querySelector(`[data-item-id="${item.id}"]`);
          if (overlay) {
            showTooltip(item, { currentTarget: overlay });
          }
        }
      }
    }

    // Initialize
    function init() {
      renderAllergenSelector();
      renderLayer();
      applyScene(SCENES[0]);

      let ticking = false;
      window.addEventListener('scroll', () => {
        if (!ticking) {
          window.requestAnimationFrame(() => {
            updateScene();
            ticking = false;
          });
          ticking = true;
        }
      }, { passive: true });

      const scrollIndicator = document.querySelector('.scroll-indicator');
      if (scrollIndicator) {
        scrollIndicator.addEventListener('click', () => {
          window.scrollTo({ top: window.innerHeight, behavior: 'smooth' });
        });
      }

      updateScene();
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
