<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="favicon.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Share Your Feedback - Clarivore</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    :root {
      --ok: #22c55e;
      --warn: #facc15;
      --bad: #ef4444;
    }
    .feedback-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .feedback-section {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }
    .feedback-section h2 {
      margin: 0 0 8px 0;
      font-size: 1.2rem;
      color: var(--text);
    }
    .feedback-section p {
      margin: 0 0 16px 0;
      color: var(--muted);
      font-size: 0.9rem;
    }
    .feedback-textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--soft);
      color: var(--text);
      font-family: inherit;
      font-size: 0.95rem;
      resize: vertical;
      box-sizing: border-box;
    }
    .feedback-textarea:focus {
      outline: none;
      border-color: var(--accent);
    }
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 12px;
      font-size: 0.9rem;
      color: var(--muted);
    }
    .checkbox-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .menu-section {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }
    .menu-section h2 {
      margin: 0 0 8px 0;
      font-size: 1.2rem;
      color: var(--text);
    }
    .menu-section > p {
      margin: 0 0 20px 0;
      color: var(--muted);
      font-size: 0.9rem;
    }
    .menu-page-container {
      position: relative;
      margin-bottom: 16px;
    }
    .menu-image {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 8px;
    }
    .overlay-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    .overlay {
      position: absolute;
      border: 3px solid;
      border-radius: 4px;
      box-sizing: border-box;
      pointer-events: auto;
      cursor: pointer;
      transition: transform 0.1s;
    }
    .overlay:hover {
      transform: scale(1.02);
      z-index: 10;
    }
    .overlay.safe { border-color: var(--ok); }
    .overlay.removable { border-color: var(--warn); }
    .overlay.unsafe { border-color: var(--bad); background: rgba(239, 68, 68, 0.15); }
    .overlay.neutral { border-color: rgba(255, 255, 255, 0.3); }
    .overlay-checkbox {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 24px;
      height: 24px;
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid var(--bad);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }
    .overlay-checkbox:hover {
      transform: scale(1.1);
    }
    .overlay-checkbox.checked {
      background: var(--bad);
    }
    .overlay-checkbox svg {
      width: 16px;
      height: 16px;
      fill: white;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .overlay-checkbox.checked svg {
      opacity: 1;
    }
    .overlay-name {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      margin-bottom: 4px;
    }
    .overlay:hover .overlay-name {
      opacity: 1;
    }
    .selected-dishes {
      margin-top: 20px;
      padding: 16px;
      background: var(--soft);
      border-radius: 8px;
    }
    .selected-dishes h3 {
      margin: 0 0 12px 0;
      font-size: 1rem;
      color: var(--text);
    }
    .selected-dish-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-bottom: 8px;
    }
    .selected-dish-item:last-child {
      margin-bottom: 0;
    }
    .selected-dish-name {
      font-size: 0.9rem;
      color: var(--text);
    }
    .remove-dish-btn {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 4px;
      font-size: 1.2rem;
      line-height: 1;
    }
    .remove-dish-btn:hover {
      color: var(--bad);
    }
    .no-selections {
      color: var(--muted);
      font-size: 0.9rem;
      font-style: italic;
    }
    .submit-section {
      text-align: center;
      padding: 20px 0;
    }
    .submit-btn {
      padding: 14px 48px;
      font-size: 1rem;
      background: #3651ff;
      border: 1px solid #4e65ff;
      color: white;
      border-radius: 999px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(54, 81, 255, 0.25);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 24px rgba(54, 81, 255, 0.35);
    }
    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .success-message {
      text-align: center;
      padding: 60px 20px;
    }
    .success-message h1 {
      color: var(--ok);
      margin-bottom: 16px;
    }
    .success-message p {
      color: var(--muted);
      font-size: 1.1rem;
    }
    .error-message {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--bad);
      color: var(--bad);
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
    }
    .page-nav {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 16px;
    }
    .page-nav button {
      padding: 8px 16px;
      background: var(--soft);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      cursor: pointer;
      font-size: 0.85rem;
    }
    .page-nav button:hover {
      background: var(--hover);
    }
    .page-nav button.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    .loading-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }
    .invalid-token {
      text-align: center;
      padding: 60px 20px;
    }
    .invalid-token h1 {
      color: var(--bad);
      margin-bottom: 16px;
    }
  </style>
</head>
<body class="page-shell">
  <header class="simple-topbar">
    <div class="simple-topbar-inner">
      <a class="simple-brand" href="home.html">
        <img src="https://static.wixstatic.com/media/945e9d_2b97098295d341d493e4a07d80d6b57c~mv2.png" alt="Clarivore logo">
        <span>Clarivore</span>
      </a>
    </div>
  </header>

  <main class="page-main">
    <div class="page-content">
      <div id="loading-state" class="loading-state">
        <p>Loading your feedback form...</p>
      </div>

      <div id="invalid-token" class="invalid-token" style="display:none;">
        <h1>Invalid or Expired Link</h1>
        <p>This feedback link is no longer valid. It may have expired or already been used.</p>
        <p style="margin-top:20px;"><a href="restaurants.html" style="color:var(--accent);">Return to Restaurants</a></p>
      </div>

      <div id="success-message" class="success-message" style="display:none;">
        <h1>Thank You!</h1>
        <p>Your feedback has been submitted successfully.</p>
        <p style="margin-top:20px;">We appreciate you helping us and the restaurant improve!</p>
        <p style="margin-top:30px;"><a href="restaurants.html" style="color:var(--accent);">Browse More Restaurants</a></p>
      </div>

      <div id="feedback-form" class="feedback-container" style="display:none;">
        <h1 style="text-align:center;margin-bottom:8px;">How was your experience?</h1>
        <p style="text-align:center;color:var(--muted);margin-bottom:32px;">at <strong id="restaurant-name"></strong></p>

        <div id="error-container"></div>

        <!-- Feedback to Restaurant -->
        <div class="feedback-section">
          <h2>Feedback for the Restaurant</h2>
          <p>Share your experience with the restaurant. What did they do well? What could be improved?</p>
          <textarea id="restaurant-feedback" class="feedback-textarea" placeholder="Optional: Share your thoughts about the food, service, or how they handled your dietary needs..."></textarea>
          <label class="checkbox-row">
            <input type="checkbox" id="restaurant-include-email">
            <span>Include my email so that restaurant management can follow up with me. Otherwise, comments will be shared anonymously.</span>
          </label>
        </div>

        <!-- Feedback for Website -->
        <div class="feedback-section">
          <h2>Feedback for Clarivore</h2>
          <p>Help us improve! Let us know about your experience using our service.</p>
          <textarea id="website-feedback" class="feedback-textarea" placeholder="Optional: How can we make Clarivore better for you?"></textarea>
          <label class="checkbox-row">
            <input type="checkbox" id="website-include-email">
            <span>Include my email so that website development can follow up with me. Otherwise, comments will be shared anonymously.</span>
          </label>
        </div>

        <!-- Menu with Accommodation Requests -->
        <div class="menu-section">
          <h2>Request Dish Accommodations</h2>
          <p>Click the checkbox on any dish that doesn't work for you to request the restaurant consider making it available for your dietary needs in the future.</p>

          <div id="menu-pages-container"></div>

          <div id="selected-dishes" class="selected-dishes" style="display:none;">
            <h3>Dishes you'd like accommodated:</h3>
            <div id="selected-dishes-list"></div>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="submit-section">
          <button id="submit-btn" class="submit-btn">Submit Feedback</button>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/auth-redirect.js" defer></script>
  <script>
    const SUPABASE_URL = 'https://fgoiyycctnwnghrvsilt.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZnb2l5eWNjdG53bmdocnZzaWx0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MzY1MjYsImV4cCI6MjA3NjAxMjUyNn0.xlSSXr0Gl7j-vsckrj-2anpPmp4BG2SUIdN-_dquSA8';
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    // State
    let feedbackData = null;
    let restaurantData = null;
    let userAllergens = [];
    let userDiets = [];
    let selectedDishes = new Set();
    let currentPage = 0;

    // DOM elements
    const loadingState = document.getElementById('loading-state');
    const invalidToken = document.getElementById('invalid-token');
    const successMessage = document.getElementById('success-message');
    const feedbackForm = document.getElementById('feedback-form');
    const restaurantNameEl = document.getElementById('restaurant-name');
    const errorContainer = document.getElementById('error-container');
    const menuPagesContainer = document.getElementById('menu-pages-container');
    const selectedDishesSection = document.getElementById('selected-dishes');
    const selectedDishesList = document.getElementById('selected-dishes-list');
    const submitBtn = document.getElementById('submit-btn');

    function norm(str) {
      return (str || '').toString().toLowerCase().trim();
    }

    function computeStatus(item, allergens, diets) {
      const hasAllergenReqs = allergens && allergens.length > 0;
      const hasDietReqs = diets && diets.length > 0;

      if (!hasAllergenReqs && !hasDietReqs) return 'neutral';

      const allergenHits = (item.allergens || []).filter(a => allergens.includes(a));
      const hasAllergenIssues = allergenHits.length > 0;
      const removableAllergenSet = new Set((item.removable || []).map(r => norm(r.allergen || '')));
      const allergenRemovableAll = hasAllergenIssues ? allergenHits.every(a => removableAllergenSet.has(norm(a))) : true;

      const itemDiets = new Set(item.diets || []);
      const meetsDietReqs = !hasDietReqs || diets.every(diet => itemDiets.has(diet));

      let canBeMadeForDiets = false;
      if (hasDietReqs && !meetsDietReqs) {
        const allergenConflicts = {
          'Vegan': ['dairy', 'egg', 'fish', 'shellfish'],
          'Vegetarian': ['fish', 'shellfish'],
          'Pescatarian': [],
          'Gluten-free': ['wheat']
        };

        const unmetDiets = diets.filter(diet => !itemDiets.has(diet));
        if (unmetDiets.length) {
          canBeMadeForDiets = unmetDiets.every(userDiet => {
            const conflicts = allergenConflicts[userDiet] || [];
            const itemAllergens = item.allergens || [];
            const conflictingAllergens = conflicts.filter(allergen => {
              return itemAllergens.some(a => norm(a) === norm(allergen));
            });
            const allConflictingAllergensRemovable = conflictingAllergens.length > 0 &&
              conflictingAllergens.every(allergen => removableAllergenSet.has(norm(allergen)));

            const blockingIngredients = item.ingredientsBlockingDiets?.[userDiet] || [];
            const allBlockingIngredientsRemovable = blockingIngredients.length > 0 &&
              blockingIngredients.every(ing => ing.removable);

            const hasBlocks = conflictingAllergens.length > 0 || blockingIngredients.length > 0;
            if (!hasBlocks) return false;
            if (conflictingAllergens.length > 0 && !allConflictingAllergensRemovable) return false;
            if (blockingIngredients.length > 0 && !allBlockingIngredientsRemovable) return false;
            return true;
          });
        }
      }

      if (!meetsDietReqs && !canBeMadeForDiets) return 'unsafe';
      if (hasAllergenIssues && !allergenRemovableAll) return 'unsafe';
      if (hasAllergenIssues || canBeMadeForDiets) return 'removable';
      return 'safe';
    }

    function toggleDishSelection(dishName) {
      if (selectedDishes.has(dishName)) {
        selectedDishes.delete(dishName);
      } else {
        selectedDishes.add(dishName);
      }
      updateSelectedDishesUI();
      renderOverlays();
    }

    function updateSelectedDishesUI() {
      if (selectedDishes.size === 0) {
        selectedDishesSection.style.display = 'none';
        return;
      }

      selectedDishesSection.style.display = 'block';
      selectedDishesList.innerHTML = Array.from(selectedDishes).map(dish => `
        <div class="selected-dish-item">
          <span class="selected-dish-name">${escapeHtml(dish)}</span>
          <button class="remove-dish-btn" onclick="toggleDishSelection('${escapeHtml(dish)}')">&times;</button>
        </div>
      `).join('');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function renderOverlays() {
      const menuImages = document.querySelectorAll('.menu-image');
      menuImages.forEach((img, pageIndex) => {
        const layer = img.nextElementSibling;
        if (!layer || !layer.classList.contains('overlay-layer')) return;

        layer.innerHTML = '';

        if (!img.complete || !img.naturalWidth) return;

        const pageOverlays = (restaurantData?.overlays || []).filter(o => (o.pageIndex || 0) === pageIndex);

        pageOverlays.forEach(item => {
          const status = computeStatus(item, userAllergens, userDiets);
          const dishName = item.name || item.id || 'Unnamed dish';

          const overlay = document.createElement('div');
          overlay.className = `overlay ${status}`;
          overlay.style.left = (+item.x || 0) + '%';
          overlay.style.top = (+item.y || 0) + '%';
          overlay.style.width = (+item.w || 0) + '%';
          overlay.style.height = (+item.h || 0) + '%';

          // Add dish name tooltip
          const nameLabel = document.createElement('div');
          nameLabel.className = 'overlay-name';
          nameLabel.textContent = dishName;
          overlay.appendChild(nameLabel);

          // Only add checkbox for unsafe dishes
          if (status === 'unsafe') {
            const checkbox = document.createElement('div');
            checkbox.className = `overlay-checkbox ${selectedDishes.has(dishName) ? 'checked' : ''}`;
            checkbox.innerHTML = '<svg viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"/></svg>';
            checkbox.addEventListener('click', (e) => {
              e.stopPropagation();
              toggleDishSelection(dishName);
            });
            overlay.appendChild(checkbox);
          }

          layer.appendChild(overlay);
        });
      });
    }

    function renderMenuPages() {
      const menuImages = restaurantData?.menu_images || [];
      if (menuImages.length === 0) {
        menuPagesContainer.innerHTML = '<p style="color:var(--muted);text-align:center;">No menu images available.</p>';
        return;
      }

      let html = '';
      menuImages.forEach((imageUrl, index) => {
        html += `
          <div class="menu-page-container" data-page="${index}" style="${index !== currentPage ? 'display:none;' : ''}">
            <img src="${imageUrl}" class="menu-image" data-page="${index}" onload="renderOverlays()">
            <div class="overlay-layer"></div>
          </div>
        `;
      });

      if (menuImages.length > 1) {
        html += '<div class="page-nav">';
        menuImages.forEach((_, index) => {
          html += `<button class="${index === currentPage ? 'active' : ''}" onclick="switchPage(${index})">Page ${index + 1}</button>`;
        });
        html += '</div>';
      }

      menuPagesContainer.innerHTML = html;
    }

    function switchPage(pageIndex) {
      currentPage = pageIndex;
      document.querySelectorAll('.menu-page-container').forEach((container, index) => {
        container.style.display = index === pageIndex ? 'block' : 'none';
      });
      document.querySelectorAll('.page-nav button').forEach((btn, index) => {
        btn.classList.toggle('active', index === pageIndex);
      });
      renderOverlays();
    }

    async function loadFeedbackData() {
      const params = new URLSearchParams(window.location.search);
      const token = params.get('token');

      if (!token) {
        showInvalidToken();
        return;
      }

      try {
        // Fetch feedback queue entry by token
        const { data: queueEntry, error: queueError } = await supabaseClient
          .from('feedback_email_queue')
          .select('*')
          .eq('feedback_token', token)
          .maybeSingle();

        if (queueError || !queueEntry) {
          showInvalidToken();
          return;
        }

        feedbackData = queueEntry;
        userAllergens = queueEntry.user_allergens || [];
        userDiets = queueEntry.user_diets || [];

        // Fetch restaurant data
        const { data: restaurant, error: restaurantError } = await supabaseClient
          .from('restaurants')
          .select('id, name, slug, overlays, menu_images')
          .eq('id', queueEntry.restaurant_id)
          .maybeSingle();

        if (restaurantError || !restaurant) {
          showInvalidToken();
          return;
        }

        restaurantData = restaurant;
        restaurantNameEl.textContent = restaurant.name;

        // Show the form
        loadingState.style.display = 'none';
        feedbackForm.style.display = 'block';

        // Render menu
        renderMenuPages();

      } catch (err) {
        console.error('Error loading feedback data:', err);
        showInvalidToken();
      }
    }

    function showInvalidToken() {
      loadingState.style.display = 'none';
      invalidToken.style.display = 'block';
    }

    function showError(message) {
      errorContainer.innerHTML = `<div class="error-message">${escapeHtml(message)}</div>`;
    }

    async function submitFeedback() {
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      errorContainer.innerHTML = '';

      const restaurantFeedback = document.getElementById('restaurant-feedback').value.trim();
      const websiteFeedback = document.getElementById('website-feedback').value.trim();
      const restaurantIncludeEmail = document.getElementById('restaurant-include-email').checked;
      const websiteIncludeEmail = document.getElementById('website-include-email').checked;

      // Check if there's anything to submit
      if (!restaurantFeedback && !websiteFeedback && selectedDishes.size === 0) {
        showError('Please provide some feedback or select dishes for accommodation requests.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Feedback';
        return;
      }

      try {
        // Insert feedback
        const { data: feedbackRecord, error: feedbackError } = await supabaseClient
          .from('order_feedback')
          .insert({
            order_id: feedbackData.order_id,
            restaurant_id: feedbackData.restaurant_id,
            user_id: feedbackData.user_id || null,
            restaurant_feedback: restaurantFeedback || null,
            website_feedback: websiteFeedback || null,
            restaurant_feedback_include_email: restaurantIncludeEmail,
            website_feedback_include_email: websiteIncludeEmail,
            user_email: (restaurantIncludeEmail || websiteIncludeEmail) ? feedbackData.user_email : null
          })
          .select()
          .single();

        if (feedbackError) throw feedbackError;

        // Insert accommodation requests
        if (selectedDishes.size > 0) {
          const accommodationRequests = Array.from(selectedDishes).map(dishName => ({
            feedback_id: feedbackRecord.id,
            restaurant_id: feedbackData.restaurant_id,
            user_id: feedbackData.user_id || null,
            dish_name: dishName,
            user_allergens: userAllergens,
            user_diets: userDiets
          }));

          const { error: requestsError } = await supabaseClient
            .from('accommodation_requests')
            .insert(accommodationRequests);

          if (requestsError) throw requestsError;
        }

        // Mark email as processed (update sent_at)
        await supabaseClient
          .from('feedback_email_queue')
          .update({ sent_at: new Date().toISOString() })
          .eq('id', feedbackData.id);

        // Show success
        feedbackForm.style.display = 'none';
        successMessage.style.display = 'block';

      } catch (err) {
        console.error('Error submitting feedback:', err);
        showError('Failed to submit feedback. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Feedback';
      }
    }

    // Initialize
    submitBtn.addEventListener('click', submitFeedback);
    loadFeedbackData();
  </script>
</body>
</html>
